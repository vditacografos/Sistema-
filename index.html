// 7. Geração do PDF
    doc.setFontSize(14);
    doc.text(titulo, 14, 20);

    doc.autoTable({
        head: head,
        body: body,
        startY: 25,
        theme: 'striped',
        headStyles: { fillColor: [74, 144, 226] },
        columnStyles: columnStyles,
        
        // ESTE HOOK É EXECUTADO EM CADA PÁGINA
        didDrawPage: function(data) {
            // Rodapé com o total de Registros (Pode ser repetido ou não, mas é útil)
            doc.setFontSize(10);
            let footerText = `Total de Registros: ${dadosFiltrados.length}`;
            
            // Texto do rodapé com Totais Detalhados para GERAL
            if (categoriaNormalizada === 'geral') {
                 footerText += ` | Total de Vendas (OS): R$ ${totalOS.toFixed(2).replace('.', ',')} | Total Mão de Obra: R$ ${totalMO.toFixed(2).replace('.', ',')}`;
            }

            // Garante que o texto de rodapé básico (Contagem de Registros) apareça em todas as páginas
            doc.text(footerText, data.settings.margin.left, doc.internal.pageSize.height - 10);
        },

        // ESTE HOOK É EXECUTADO APENAS APÓS O DESENHO COMPLETO DE CADA CÉLULA (O QUE INCLUI A ÚLTIMA PÁGINA)
        didDrawPage: function(data) {
            // AQUI VERIFICAMOS SE É A ÚLTIMA PÁGINA.
            // O didDrawPage é o local certo, mas precisamos de uma variável externa para o cursor final.
            
            // --- CÓDIGO DE RODAPÉ BÁSICO (Repetido em todas as páginas) ---
            doc.setFontSize(10);
            let footerText = `Total de Registros: ${dadosFiltrados.length}`;
            if (categoriaNormalizada === 'geral') {
                 footerText += ` | Total de Vendas (OS): R$ ${totalOS.toFixed(2).replace('.', ',')} | Total Mão de Obra: R$ ${totalMO.toFixed(2).replace('.', ',')}`;
            }
            doc.text(footerText, data.settings.margin.left, doc.internal.pageSize.height - 10);
            // -----------------------------------------------------------------

            // Coloca o total grande APENAS na última página.
            // Para fazer isso de forma robusta dentro do autoTable, precisamos de uma forma de saber o total de páginas.
            // O autoTable não expõe o total de páginas de forma limpa, mas o data.cursor.y é a altura após a tabela.
        }
    });
    
    // 8. ADICIONAMOS O TOTAL GRANDE AQUI, APÓS O autoTable, 
    // USANDO O doc.autoTable.previous.finalY PARA SABER ONDE TERMINOU A TABELA.
    // Isso garante que ele só é desenhado uma vez, no final do documento.
    
    // Verifica a altura final da tabela
    const finalY = doc.autoTable.previous.finalY || 25; // 25 é o startY

    // Coloca o total grande (valor da categoria)
    const totalValueFormatted = `R$ ${totalDaCategoria.toFixed(2).replace('.', ',')}`;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    
    // Usa a coordenada final Y da tabela + 10px para posicionar o total
    doc.text(`TOTAL DA CATEGORIA: ${totalValueFormatted}`, 190, finalY + 10, { align: 'right' });


    // 9. Salvar o PDF
    doc.save(nomeArquivo);
}
