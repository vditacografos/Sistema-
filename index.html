<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VDI Tacógrafos — Frente de Caixa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f4f6f9; }
        header { background: linear-gradient(90deg,#4a90e2,#9013fe); color:white; padding:20px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .container { padding:20px; max-width:1200px; margin:auto; }
        .buttons, .filters, .search { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
        button { background:#4a90e2; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; display:flex; align-items:center; gap:5px; }
        button:hover { background:#357ABD; }
        input, select { padding:10px 12px; border-radius:6px; border:1px solid #ccc; box-sizing: border-box;}
        table { width:100%; border-collapse:collapse; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding:8px 10px; text-align:left; font-size:13px; }
        th { background:#4a90e2; color:white; }
        tr:nth-child(even) { background:#f9f9f9; }
        tr:hover { background:#dce6f1; }
        .summary { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
        .card { flex:1 1 150px; padding:15px; border-radius:10px; color:white; font-weight:600; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
        .card:hover { opacity:0.9; transform:scale(1.02); }
        .faturadas { background: linear-gradient(45deg,#2d9cdb,#1b7ecf); }
        .emaberto { background: linear-gradient(45deg,#e94e77,#d43d5c); }
        .pix { background: linear-gradient(45deg,#27ae60,#1e8449); }
        .dinheiro { background: linear-gradient(45deg,#f1c40f,#d4ac0d); }
        .debito { background: linear-gradient(45deg,#f39c12,#d68910); }
        .credito { background: linear-gradient(45deg,#9b59b6,#8e44ad); }
        .maodeobra { background: linear-gradient(45deg, #7b1fa2, #4a148c); } 
        .edit { background:#27ae60; }
        .delete { background:#e74c3c; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:20px; border-radius:10px; width:95%; max-width:480px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { color:#4a90e2; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin-bottom:12px; width:100%; box-sizing:border-box; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index:2000; font-size: 18px; font-weight: 600; color: #4a90e2; }
    </style>
</head>
<body>

<div id="loadingOverlay" style="display:none;">Processando...</div>

<div id="loginModal" class="modal" style="display: flex;">
    <div class="modal-content">
        <h2>Acesso VDI - Frente de Caixa</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Senha">
        <button onclick="handleLogin()">Entrar</button>
    </div>
</div>

<div id="appContent" style="display:none;">
    <header>
        <h1>VDI TACÓGRAFOS — Frente de Caixa</h1>
        <button onclick="handleLogout()" style="position: absolute; top: 20px; right: 20px; background: #c0392b;">Sair</button>
    </header>

    <div class="container">
        <div class="buttons">
            <button onclick="abrirForm()">+ Nova O.S</button>
            <button onclick="exportExcel()">Excel</button>
            <button onclick="imprimirPDF()">PDF Geral</button>
        </div>

        <div class="filters">
            <select id="unidade" onchange="atualizarTabelaTodas()">
                <option value="">Todas Unidades</option>
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <select id="tecnicoFiltro" onchange="atualizarTabelaTodas()">
                <option value="">Todos Técnicos</option>
            </select>
            <input type="date" id="dataInicio" onchange="atualizarTabelaTodas()">
            <input type="date" id="dataFim" onchange="atualizarTabelaTodas()">
            <button onclick="limparFiltros()">Limpar</button>
        </div>

        <div class="summary">
            <div class="card maodeobra" id="totalMO" onclick="imprimirPDF('Mão de Obra')">MÃO DE OBRA<br>R$ 0,00</div>
            <div class="card faturadas" id="totalFaturadas" onclick="imprimirPDF('Faturado')">FATURADAS<br>R$ 0,00</div>
            <div class="card emaberto" id="totalAberto" onclick="imprimirPDF('Em Aberto')">EM ABERTO<br>R$ 0,00</div>
            <div class="card pix" id="totalPix" onclick="imprimirPDF('PIX')">PIX<br>R$ 0,00</div>
            <div class="card dinheiro" id="totalDinheiro" onclick="imprimirPDF('Dinheiro')">DINHEIRO<br>R$ 0,00</div>
            <div class="card debito" id="totalDebito" onclick="imprimirPDF('Débito')">DÉBITO<br>R$ 0,00</div>
            <div class="card credito" id="totalCredito" onclick="imprimirPDF('Crédito')">CRÉDITO<br>R$ 0,00</div>
        </div>

        <table id="tabelaTodas">
            <thead>
                <tr>
                    <th>O.S</th><th>DATA</th><th>CLIENTE</th><th>PLACA</th><th>VALOR OS</th><th>VALOR MO</th><th>TOTAL</th><th>PAGAMENTO</th><th>TECNICO</th><th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="formModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nova O.S</h2>
            <input type="text" id="formOS" placeholder="Número O.S">
            <input type="date" id="formData">
            <input type="text" id="formCliente" placeholder="Cliente">
            <input type="text" id="formPlaca" placeholder="Placa">
            <input type="number" id="formValorOS" placeholder="Valor Peças" step="0.01">
            <input type="number" id="formValorMO" placeholder="Valor Mão de Obra" step="0.01">
            <select id="formPagamento">
                <option value="PIX">PIX</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Crédito">Crédito</option>
                <option value="Débito">Débito</option>
                <option value="Em Aberto">Em Aberto</option>
                <option value="Faturado">Faturado</option>
            </select>
            <select id="formUnidade">
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <input type="text" id="formTecnico" placeholder="Técnico">
            <button onclick="salvarForm()">Salvar</button>
            <button onclick="fecharForm()" style="background:#666">Fechar</button>
        </div>
    </div>
</div>

<script>
// CONFIGURAÇÃO FIREBASE (Mesma do seu original)
const firebaseConfig = {
  apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM",
  authDomain: "vditacografosfrentecaixa.firebaseapp.com",
  projectId: "vditacografosfrentecaixa",
  storageBucket: "vditacografosfrentecaixa.appspot.com",
  messagingSenderId: "1008625665373",
  appId: "1:1008625665373:web:1f1870898ecb04b4b854b4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let osData = [];

// AUTH E LISTENERS
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        carregarDados();
    } else {
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('appContent').style.display = 'none';
    }
});

async function handleLogin() {
    const e = document.getElementById('loginEmail').value;
    const p = document.getElementById('loginPassword').value;
    try { await auth.signInWithEmailAndPassword(e, p); } catch(err) { alert("Erro: " + err.message); }
}

function handleLogout() { auth.signOut(); }

function carregarDados() {
    db.collection('ordens_servico').onSnapshot(snap => {
        osData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        atualizarTecnicos();
        atualizarTabelaTodas();
    });
}

function atualizarTecnicos() {
    const lista = [...new Set(osData.map(i => i.tecnico))].sort();
    const select = document.getElementById('tecnicoFiltro');
    select.innerHTML = '<option value="">Todos Técnicos</option>';
    lista.forEach(t => select.innerHTML += `<option value="${t}">${t}</option>`);
}

// LOGICA DE FILTRAGEM (O CORAÇÃO DO PROBLEMA)
function getDadosFiltrados(statusAlvo = null) {
    const unidade = document.getElementById('unidade').value;
    const tecnico = document.getElementById('tecnicoFiltro').value;
    const dInicio = document.getElementById('dataInicio').value;
    const dFim = document.getElementById('dataFim').value;

    return osData.filter(item => {
        const itemData = item.data ? item.data.split('/').reverse().join('-') : '';
        const statusItem = (item.pagamento || '').toLowerCase().trim();
        
        // Filtros Globais
        if (unidade && item.unidade !== unidade) return false;
        if (tecnico && item.tecnico !== tecnico) return false;
        if (dInicio && itemData < dInicio) return false;
        if (dFim && itemData > dFim) return false;
        if ((item.cliente || '').toUpperCase().includes('CANCELADA')) return false;

        // Filtro Específico do Botão/PDF
        if (statusAlvo) {
            const alvo = statusAlvo.toLowerCase().trim();
            if (alvo === 'mão de obra') return parseFloat(item.valor_mo || 0) > 0;
            if (alvo === 'pix' && !statusItem.includes('pix')) return false;
            if (alvo !== 'pix' && alvo !== 'mão de obra' && statusItem !== alvo) return false;
        }
        return true;
    });
}

function atualizarTabelaTodas() {
    const dados = getDadosFiltrados();
    const tbody = document.querySelector('#tabelaTodas tbody');
    tbody.innerHTML = '';
    
    let totais = { mo:0, fat:0, aberto:0, pix:0, din:0, deb:0, cre:0 };

    dados.forEach(item => {
        const vOS = parseFloat(item.valor_os || 0);
        const vMO = parseFloat(item.valor_mo || 0);
        const total = vOS + vMO;
        const pg = (item.pagamento || '').toLowerCase();

        totais.mo += vMO;
        if(pg === 'faturado') totais.fat += total;
        else if(pg === 'em aberto') totais.aberto += total;
        else if(pg.includes('pix')) totais.pix += total;
        else if(pg === 'dinheiro') totais.din += total;
        else if(pg === 'débito' || pg === 'debito') totais.deb += total;
        else if(pg === 'crédito' || pg === 'credito') totais.cre += total;

        tbody.innerHTML += `<tr>
            <td>${item.os}</td><td>${item.data}</td><td>${item.cliente}</td><td>${item.placa}</td>
            <td>R$ ${vOS.toFixed(2)}</td><td>R$ ${vMO.toFixed(2)}</td><td>R$ ${total.toFixed(2)}</td>
            <td>${item.pagamento}</td><td>${item.tecnico}</td>
            <td><button class="delete" onclick="apagarOS('${item.id}')">X</button></td>
        </tr>`;
    });

    document.getElementById('totalMO').innerHTML = `MÃO DE OBRA<br>R$ ${totais.mo.toFixed(2)}`;
    document.getElementById('totalFaturadas').innerHTML = `FATURADAS<br>R$ ${totais.fat.toFixed(2)}`;
    document.getElementById('totalAberto').innerHTML = `EM ABERTO<br>R$ ${totais.aberto.toFixed(2)}`;
    document.getElementById('totalPix').innerHTML = `PIX<br>R$ ${totais.pix.toFixed(2)}`;
    document.getElementById('totalDinheiro').innerHTML = `DINHEIRO<br>R$ ${totais.din.toFixed(2)}`;
    document.getElementById('totalDebito').innerHTML = `DÉBITO<br>R$ ${totais.deb.toFixed(2)}`;
    document.getElementById('totalCredito').innerHTML = `CRÉDITO<br>R$ ${totais.cre.toFixed(2)}`;
}

// PDF CORRIGIDO
function imprimirPDF(status = null) {
    const dados = getDadosFiltrados(status);
    if (dados.length === 0) return alert("Sem dados para este filtro!");

    const doc = new jspdf.jsPDF('l', 'mm', 'a4');
    const titulo = status ? `RELATÓRIO - ${status.toUpperCase()}` : "RELATÓRIO GERAL";
    
    let somaTotal = 0;
    const rows = dados.map(i => {
        const vOS = parseFloat(i.valor_os || 0);
        const vMO = parseFloat(i.valor_mo || 0);
        const total = vOS + vMO;
        somaTotal += (status === 'Mão de Obra' ? vMO : total);
        
        return [i.os, i.data, i.cliente, i.placa, vOS.toFixed(2), vMO.toFixed(2), total.toFixed(2), i.pagamento, i.tecnico];
    });

    doc.setFontSize(16);
    doc.text(titulo, 14, 15);
    doc.setFontSize(10);
    doc.text(`Unidade: ${document.getElementById('unidade').value || 'Todas'} | Técnico: ${document.getElementById('tecnicoFiltro').value || 'Todos'}`, 14, 22);

    doc.autoTable({
        head: [['O.S', 'DATA', 'CLIENTE', 'PLACA', 'PEÇAS', 'M.O', 'TOTAL', 'PAGTO', 'TECNICO']],
        body: rows,
        startY: 30,
        theme: 'grid',
        foot: [['', '', '', '', '', '', `TOTAL: R$ ${somaTotal.toFixed(2)}`, '', '']],
        footStyles: { fillColor: [40, 40, 40], fontStyle: 'bold' }
    });

    doc.save(`${titulo}.pdf`);
}

// FORMULÁRIO E AÇÕES
function abrirForm() { document.getElementById('formModal').style.display='flex'; }
function fecharForm() { document.getElementById('formModal').style.display='none'; }

async function salvarForm() {
    const data = {
        os: document.getElementById('formOS').value,
        data: document.getElementById('formData').value.split('-').reverse().join('/'),
        cliente: document.getElementById('formCliente').value,
        placa: document.getElementById('formPlaca').value,
        valor_os: document.getElementById('formValorOS').value,
        valor_mo: document.getElementById('formValorMO').value,
        pagamento: document.getElementById('formPagamento').value,
        unidade: document.getElementById('formUnidade').value,
        tecnico: document.getElementById('formTecnico').value
    };
    await db.collection('ordens_servico').add(data);
    fecharForm();
}

async function apagarOS(id) { if(confirm("Apagar?")) await db.collection('ordens_servico').doc(id).delete(); }

function limparFiltros() {
    document.getElementById('unidade').value = '';
    document.getElementById('tecnicoFiltro').value = '';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    atualizarTabelaTodas();
}
</script>
</body>
</html>
