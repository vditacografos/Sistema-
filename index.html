<script>
    // =========================================================================//
    //           CONFIGURA√á√ÉO FIREBASE E CONEX√ÉO FIRESTORE - CREDENCIAIS
    // =========================================================================//
    // ATEN√á√ÉO: A nova API Key √© cr√≠tica para corrigir o erro 400 (Chave Bloqueada)
    const firebaseConfig = {
      // NOVA API KEY SEM RESTRI√á√ïES DE DOM√çNIO (CORRE√á√ÉO DO ERRO 400)
      apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM",
      authDomain: "vditacografosfrentecaixa.firebaseapp.com",
      databaseURL: "https://vditacografosfrentecaixa-default-rtdb.firebaseio.com",
      projectId: "vditacografosfrentecaixa",
      storageBucket: "vditacografosfrentecaixa.firebasestorage.app",
      messagingSenderId: "1008625665373",
      // NOVO APP ID
      appId: "1:1008625665373:web:1f1870898ecb04b4b854b4",
      measurementId: "G-9SYYV1VLNY"
    };

    // Inicializa o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const auth = firebase.auth(app); // Novo: Refer√™ncia para autentica√ß√£o
    const osCollection = db.collection('ordens_servico');

    let osData = [];
    // VARI√ÅVEL GLOBAL PARA CONTROLE DE EDI√á√ÉO
    let osEditandoId = null;

    // =================================================================
    // üîê FUN√á√ïES DE AUTENTICA√á√ÉO FIREBASE
    // =================================================================

    /**
     * Tenta fazer o login com e-mail e senha.
     */
    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        if (!email || !password) {
            errorDiv.textContent = "Preencha e-mail e senha.";
            errorDiv.style.display = 'block';
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
            // O monitoramento do estado (onAuthStateChanged) far√° o resto
        } catch (error) {
            console.error("Erro de Login:", error);
            let errorMessage = "Erro desconhecido.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                errorMessage = "E-mail ou senha inv√°lidos.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Formato de e-mail inv√°lido.";
            }
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        }
    }

    /**
     * Encerra a sess√£o do usu√°rio.
     */
    function logout() {
        auth.signOut();
    }

    /**
     * Monitora o estado de autentica√ß√£o (logado/deslogado).
     */
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usu√°rio logado: esconde login, mostra loading, inicia dados.
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingOverlay').innerHTML = 'Conectando √† Nuvem...';
            setupFirestoreListener();
        } else {
            // Usu√°rio deslogado: mostra login, esconde tudo.
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }
    });

    // =================================================================
    // ‚öôÔ∏è FUN√á√ïES FIREBASE E SISTEMA (CORRIGIDAS E COMPLETAS)
    // =================================================================

    /**
     * Inicia a escuta em tempo real da cole√ß√£o 'ordens_servico' no Firestore.
     */
    function setupFirestoreListener() {
        osCollection.onSnapshot(snapshot => {
            const changes = snapshot.docChanges();

            changes.forEach(change => {
                const docData = { ...change.doc.data(), id: change.doc.id };

                if (change.type === "added" || change.type === "modified") {
                    const existingIndex = osData.findIndex(item => item.id === docData.id);
                    if (existingIndex > -1) {
                        osData[existingIndex] = docData;
                    } else {
                        osData.push(docData);
                    }
                }
                if (change.type === "removed") {
                    osData = osData.filter(item => item.id !== docData.id);
                }
            });

            osData.sort((a, b) => {
                const parseDate = (dateStr) => {
                    const parts = dateStr.split('/');
                    // Formato DD/MM/AAAA. Cria a data como AAAA, MM-1, DD
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                };
                // Caso 'data' esteja vazio, usa uma data antiga para n√£o quebrar a ordena√ß√£o
                const dateA = parseDate(a.data || '01/01/2000');
                const dateB = parseDate(b.data || '01/01/2000');
                return dateB - dateA; // Mais recente primeiro
            });

            // Oculta o loading e mostra o app
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';

            getTecnicosUnicos();
            atualizarTabelaTodas();
        }, error => {
            console.error("Erro CR√çTICO ao conectar ao Firestore:", error);
            // Mensagem clara de erro de regras
            document.getElementById('loadingOverlay').innerHTML = 'ERRO: Falha ao conectar ao banco de dados na nuvem. VERIFIQUE AS REGRAS DO FIREBASE. (' + error.code + ')';
        });
    }

    /**
     * Converte data de ISO (AAAA-MM-DD) para BR (DD/MM/AAAA)
     */
    function formatDate(iso){
        const parts=iso.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    /**
     * Popula o filtro de t√©cnicos com base nos dados.
     */
    function getTecnicosUnicos() {
        const tecnicos = [...new Set(osData.map(item => item.tecnico).filter(t => t && t.trim() !== ''))].sort();
        const select = document.getElementById('tecnicoFiltro');
        const valorAtual = select.value;

        select.innerHTML = '<option value="">Todos T√©cnicos</option>';

        tecnicos.forEach(tecnico => {
            const option = document.createElement('option');
            option.value = tecnico;
            option.textContent = tecnico;
            select.appendChild(option);
        });
        if (tecnicos.includes(valorAtual)) {
            select.value = valorAtual;
        } else if (valorAtual && !tecnicos.includes(valorAtual)) {
            select.value = '';
        }
    }

    /**
     * Abre o modal do formul√°rio, configurado para Nova O.S. ou Edi√ß√£o.
     * @param {Object} [item=null] - O objeto de O.S. a ser editado.
     */
    function abrirForm(item = null){
        const modal = document.getElementById('formModal');
        const salvarBtn = modal.querySelector('.modal-content button:first-of-type'); // O primeiro bot√£o √© o Salvar/Atualizar
        osEditandoId = null; // Zera para Nova O.S.

        // Limpa o formul√°rio
        document.getElementById('formOS').value = '';
        document.getElementById('formData').value = '';
        document.getElementById('formCliente').value = '';
        document.getElementById('formPlaca').value = '';
        document.getElementById('formValor').value = '';
        document.getElementById('formPagamento').value = '';
        document.getElementById('formTecnico').value = '';
        document.getElementById('formUnidade').value = ''; // Limpa antes de preencher
        
        if (item) {
            // Modo Edi√ß√£o
            osEditandoId = item.id;
            modal.querySelector('h2').textContent = "Editar O.S. Existente";
            salvarBtn.textContent = "Atualizar O.S.";
            salvarBtn.setAttribute('onclick', 'atualizarOS()'); // Chama a fun√ß√£o de atualiza√ß√£o

            // Pr√©-preenche os campos
            document.getElementById('formOS').value = item.os || '';
            // Converte data 'DD/MM/AAAA' para 'AAAA-MM-DD' para o input type="date"
            const dataParts = (item.data || '01/01/2000').split('/');
            document.getElementById('formData').value = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
            document.getElementById('formCliente').value = item.cliente || '';
            document.getElementById('formPlaca').value = item.placa || '';
            document.getElementById('formValor').value = parseFloat(item.valor || 0).toFixed(2);
            document.getElementById('formPagamento').value = item.pagamento || '';
            document.getElementById('formUnidade').value = item.unidade || '';
            document.getElementById('formTecnico').value = item.tecnico || '';

        } else {
            // Modo Nova O.S.
            modal.querySelector('h2').textContent = "Nova O.S";
            salvarBtn.textContent = "Salvar O.S";
            salvarBtn.setAttribute('onclick', 'salvarForm()'); // Chama a fun√ß√£o de salvar

            // Mant√©m a unidade selecionada no filtro como padr√£o para nova OS
            const unidadeSelecionada = document.getElementById('unidade').value;
            document.getElementById('formUnidade').value = unidadeSelecionada || '';
        }

        // Abre o modal
        modal.style.display = 'flex';
    }

    /**
     * Fecha o modal do formul√°rio.
     */
    function fecharForm(){
        document.getElementById('formModal').style.display='none';
    }

    /**
     * Salva uma NOVA O.S. no Firebase.
     */
    async function salvarForm(){
        const os=document.getElementById('formOS').value.trim();
        const dataInput=document.getElementById('formData').value;
        const cliente=document.getElementById('formCliente').value.trim();
        const placa=document.getElementById('formPlaca').value.trim();
        const valor=parseFloat(document.getElementById('formValor').value).toFixed(2);
        const pagamento=document.getElementById('formPagamento').value;
        const tecnico=document.getElementById('formTecnico').value.trim();
        const unidade=document.getElementById('formUnidade').value;

        if(!os || !dataInput || !cliente || !placa || !valor || !pagamento || !tecnico || !unidade){
              alert("Preencha todos os campos!");
              return;
        }

        const dataFormatada = formatDate(dataInput);

        const novaOS = {
            os,
            data: dataFormatada,
            cliente,
            placa,
            valor,
            pagamento,
            tecnico,
            unidade,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
         };

        try {
            await osCollection.add(novaOS);
            alert("O.S. salva na nuvem com sucesso!");
        } catch (e) {
            console.error("Erro ao salvar O.S.: ", e);
            alert("Erro ao salvar O.S. na nuvem. Verifique a conex√£o e as regras do Firebase.");
        }

        fecharForm();
    }
    
    /**
     * ATUALIZA uma O.S. existente no Firebase. (Nova fun√ß√£o de corre√ß√£o)
     */
    async function atualizarOS(){
        if (!osEditandoId) {
            alert("ID da O.S. para edi√ß√£o n√£o encontrado.");
            return;
        }

        const os=document.getElementById('formOS').value.trim();
        const dataInput=document.getElementById('formData').value;
        const cliente=document.getElementById('formCliente').value.trim();
        const placa=document.getElementById('formPlaca').value.trim();
        const valor=parseFloat(document.getElementById('formValor').value).toFixed(2);
        const pagamento=document.getElementById('formPagamento').value;
        const tecnico=document.getElementById('formTecnico').value.trim();
        const unidade=document.getElementById('formUnidade').value;

        if(!os || !dataInput || !cliente || !placa || !valor || !pagamento || !tecnico || !unidade){
            alert("Preencha todos os campos!");
            return;
        }

        const dataFormatada = formatDate(dataInput);

        const osAtualizada = {
            os,
            data: dataFormatada,
            cliente,
            placa,
            valor,
            pagamento,
            tecnico,
            unidade,
            // N√£o alteramos o timestamp de cria√ß√£o, apenas os campos.
        };

        try {
            await osCollection.doc(osEditandoId).update(osAtualizada);
            alert("O.S. atualizada na nuvem com sucesso!");
        } catch (e) {
            console.error("Erro ao atualizar O.S.: ", e);
            alert("Erro ao atualizar O.S. na nuvem. Verifique a conex√£o e as regras do Firebase.");
        }

        fecharForm();
    }


    /**
     * Filtra e atualiza a tabela e os resumos.
     */
    function atualizarTabelaTodas(){
        const unidade = document.getElementById('unidade').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const termoBusca = document.getElementById('busca').value.toLowerCase();
        const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;

        const tbody = document.querySelector("#tabelaTodas tbody");
        tbody.innerHTML = '';
        let totalF=0, totalAberto=0, totalPix=0, totalDin=0, totalDeb=0, totalCred=0;

        const dadosFiltrados = osData.filter(item => {
            // Convers√£o da data de DD/MM/AAAA para AAAA-MM-DD para compara√ß√£o
            const itemDate = item.data ? item.data.split('/').reverse().join('-') : '01/01/2000';
            const itemValor = parseFloat(item.valor) || 0;
            const itemPagamento = item.pagamento ? item.pagamento.toLowerCase().trim() : '';

            if(unidade && item.unidade !== unidade) return false;
            if(tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
            if(dataInicio && itemDate < dataInicio) return false;
            if(dataFim && itemDate > dataFim) return false;
            if ((item.cliente || '').toUpperCase().includes('CANCELADA')) return false;
            if (termoBusca && !(item.cliente.toLowerCase().includes(termoBusca) || item.placa.toLowerCase().includes(termoBusca) || item.os.toLowerCase().includes(termoBusca))) return false;

            if(itemPagamento === 'faturado') totalF += itemValor;
            if(itemPagamento === 'em aberto') totalAberto += itemValor;
            if(itemPagamento === 'pix') totalPix += itemValor;
            if(itemPagamento === 'dinheiro') totalDin += itemValor;
            if(itemPagamento === 'd√©bito') totalDeb += itemValor;
            if(itemPagamento === 'cr√©dito') totalCred += itemValor;

            return true;
        });

        dadosFiltrados.forEach((item,i)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.os}</td><td>${item.data}</td><td>${item.cliente}</td><td>${item.placa}</td><td>R$ ${parseFloat(item.valor).toFixed(2)}</td><td>${item.pagamento}</td><td>${item.tecnico}</td><td>${item.unidade}</td><td><button class="edit" onclick="editarOS('${item.id}')">Editar</button> <button class="delete" onclick="apagarOS('${item.id}')">Apagar</button></td>`;
            tbody.appendChild(tr);
        });

        document.getElementById('totalFaturadas').innerHTML=`FATURADAS<br>R$ ${totalF.toFixed(2)}`;
        document.getElementById('totalAberto').innerHTML=`EM ABERTO<br>R$ ${totalAberto.toFixed(2)}`;
        document.getElementById('totalPix').innerHTML=`PIX<br>R$ ${totalPix.toFixed(2)}`;
        document.getElementById('totalDinheiro').innerHTML=`DINHEIRO<br>R$ ${totalDin.toFixed(2)}`;
        document.getElementById('totalDebito').innerHTML=`D√âBITO<br>R$ ${totalDeb.toFixed(2)}`;
        document.getElementById('totalCredito').innerHTML=`CR√âDITO<br>R$ ${totalCred.toFixed(2)}`;
    }

    /**
     * CORRIGIDA: Fun√ß√£o para abrir o modal no modo Edi√ß√£o.
     */
    function editarOS(id){
        const item = osData.find(d => d.id === id);
        if (!item) {
            alert("O.S. n√£o encontrada para edi√ß√£o.");
            return;
        }
        abrirForm(item); // Chama a fun√ß√£o unificada para abrir o modal de edi√ß√£o
    }

    /**
     * Apaga uma O.S. no Firebase.
     */
    async function apagarOS(id){
          if(confirm("Deseja apagar esta O.S?")){
              try {
                await osCollection.doc(id).delete();
                alert("O.S. apagada da nuvem!");
            } catch (e) {
                console.error("Erro ao apagar O.S.: ", e);
                alert("Erro ao apagar O.S. na nuvem.");
            }
          }
    }

    /**
     * Limpa todos os filtros e atualiza a tabela. (Nova fun√ß√£o de corre√ß√£o)
     */
    function limparFiltros(){
        document.getElementById('unidade').value = '';
        document.getElementById('tecnicoFiltro').value = '';
        document.getElementById('dataInicio').value = '';
        document.getElementById('dataFim').value = '';
        document.getElementById('busca').value = '';
        atualizarTabelaTodas(); // Recarrega a tabela com todos os dados
    }

    // Fun√ß√µes de Filtro e Busca que chamam apenas atualizarTabelaTodas()
    function filtrar(){ atualizarTabelaTodas(); }
    function buscar(){ atualizarTabelaTodas(); }

    /**
     * Apaga todos os dados da cole√ß√£o.
     */
    async function limparDados(){
          if(confirm("Deseja limpar TODOS os dados NA NUVEM? Esta a√ß√£o √© irrevers√≠vel.")){
              const snapshot = await osCollection.get();
              const batch = db.batch();
              snapshot.docs.forEach((doc) => {
                  batch.delete(doc.ref);
              });

                            try {
                  await batch.commit();
                  alert("TODOS os dados foram apagados da nuvem.");
              } catch (e) {
                  console.error("Erro ao apagar todos os dados: ", e);
                  alert("Erro ao apagar todos os dados da nuvem.");
              }
          }
    }

    // =================================================================
    // üìä FUN√á√ïES DE EXPORTA√á√ÉO (MANTIDAS)
    // =================================================================
    function exportExcel(){
            const wb=XLSX.utils.book_new();
            const ws=XLSX.utils.json_to_sheet(osData.map(item => {
                const { id, ...rest } = item;
                return rest;
            }));
            XLSX.utils.book_append_sheet(wb,ws,"O.S");
            XLSX.writeFile(wb,"OS_FrenteCaixa.xlsx");
    }

    function importExcel(){ document.getElementById('inputExcel').click(); }

    function lerExcel(event) {
        const files = event.target.files;
        if (files.length === 0) {
              document.getElementById('inputExcel').value = null;
              return;
          }

        let dadosCombinados = [];
        let arquivosProcessados = 0;

        function processarArquivo(file) {
            const reader = new FileReader();
            const fileName = file.name.toUpperCase();
            let unidade = '';
            if (fileName.includes('BARUERI')) {
                  unidade = 'Barueri';
              } else if (fileName.includes('COTIA')) {
                  unidade = 'Cotia';
              } else if (fileName.includes('EMBU')) {
                  unidade = 'Embu';
              }
            reader.onload = function(e) {
                const data = e.target.result;
                try {
                    const workbook = XLSX.read(data, { type: 'binary', raw: true, cellDates: true, dateNF: 'yyyy-mm-dd' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const sheetData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true, defval: '' });

                    let isCapturingData = false;

                    for (let i = 0; i < sheetData.length; i++) {
                        const row = sheetData[i].map(c => String(c).trim().toUpperCase());
                        const rowContainsHeader = row.some(cell => cell === 'O S' || cell === 'O.S') && row.some(cell => cell === 'DATA');

                        if (rowContainsHeader) {
                            isCapturingData = true;
                            continue;
                        }
                        if (isCapturingData) {
                            const isSummaryRow = row.some(cell => cell.includes('TOTAL') || cell.includes('RESUMO') || cell.includes('SAIDAS') || cell.includes('INICIO DE CX'));
                            if (isSummaryRow || row[0] === '') {
                                  isCapturingData = false;
                                  continue;
                            }

                            if (row.length >= 7 && row[0] !== '') {
                                // Tenta obter a data no formato AAAA-MM-DD
                                let dataInputExcel = '';
                                if (sheetData[i][1] instanceof Date) {
                                    dataInputExcel = sheetData[i][1].toISOString().split('T')[0];
                                } else if (typeof sheetData[i][1] === 'string' && sheetData[i][1].match(/^\d{4}-\d{2}-\d{2}/)) {
                                    dataInputExcel = sheetData[i][1].split('T')[0];
                                }

                                const osItem = {
                                    os: String(sheetData[i][0] || ''),
                                    data: formatDate(dataInputExcel || '2000-01-01'), // Usa '01/01/2000' se a data for inv√°lida
                                    cliente: String(sheetData[i][2] || ''),
                                    placa: String(sheetData[i][3] || ''),
                                    valor: parseFloat(String(sheetData[i][4] || 0).replace(',', '.')).toFixed(2),
                                    pagamento: String(sheetData[i][5] || ''),
                                    tecnico: String(sheetData[i][6] || ''),
                                    unidade: unidade,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                  };
                                dadosCombinados.push(osItem);
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Erro ao processar o arquivo ${file.name}:`, error);
                    alert(`Erro ao ler o arquivo ${file.name}. Verifique se o formato est√° correto.`);
                } finally {
                    arquivosProcessados++;
                    if (arquivosProcessados === files.length) {

                        const novosRegistros = dadosCombinados.filter(item =>
                            item.os && item.data && item.cliente.toUpperCase().trim() !== 'CANCELADA'
                        );

                        const batch = db.batch();
                        let registrosAdicionados = 0;

                        novosRegistros.forEach(novoItem => {
                            const newDocRef = osCollection.doc();
                            batch.set(newDocRef, novoItem);
                            registrosAdicionados++;
                        });

                        batch.commit().then(() => {
                            alert(`Sucesso! ${files.length} arquivos combinados e ${registrosAdicionados} novos registros importados para a nuvem.`);
                        }).catch(e => {
                            console.error("Erro ao importar dados para o Firebase:", e);
                            alert("Erro ao importar dados para a nuvem.");
                        });

                        document.getElementById('inputExcel').value = null;
                      }
                }
            };
            reader.readAsBinaryString(file);
        }
        for (let i = 0; i < files.length; i++) {
            processarArquivo(files[i]);
        }
    }

    const paymentColors = { 'Faturado': [173, 216, 230], 'Em Aberto': [255, 192, 203], 'PIX': [175, 223, 175], 'Dinheiro': [255, 239, 173], 'D√©bito': [253, 222, 173], 'Cr√©dito': [210, 180, 222]};
    const totalColors = { 'Faturado': [45, 156, 219], 'Em Aberto': [233, 78, 119], 'PIX': [39, 174, 96], 'Dinheiro': [241, 196, 15], 'D√©bito': [243, 156, 18], 'Cr√©dito': [155, 89, 182]};

    function imprimirPDF(tipoFiltro = '') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

        const unidadeSelecionada = document.getElementById('unidade').value;
        const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const termoBusca = document.getElementById('busca').value.toLowerCase();

        let tituloFiltro = tipoFiltro || 'Todos';
        if(tecnicoFiltro) tituloFiltro += ` (T√©cnico: ${tecnicoFiltro})`;
        if(termoBusca) tituloFiltro += ` (Busca: "${termoBusca}")`;

        let dados = osData.slice();

         if (unidadeSelecionada) { dados = dados.filter(d => d.unidade === unidadeSelecionada); }
        if (tecnicoFiltro) { dados = dados.filter(d => d.tecnico === tecnicoFiltro); }
        if (tipoFiltro) { dados = dados.filter(d => (d.pagamento || '').toLowerCase().trim() === tipoFiltro.toLowerCase().trim()); }
        if (dataInicio) { dados = dados.filter(d => (d.data || '').split('/').reverse().join('-') >= dataInicio); }
        if (dataFim) { dados = dados.filter(d => (d.data || '').split('/').reverse().join('-') <= dataFim); }
        if (termoBusca) {
            dados = dados.filter(d =>
                (d.cliente || '').toLowerCase().includes(termoBusca) ||
                (d.placa || '').toLowerCase().includes(termoBusca) ||
                (d.os || '').toLowerCase().includes(termoBusca)
            );
        }
        dados = dados.filter(d => !(d.cliente || '').toUpperCase().includes('CANCELADA'));

        const headers = ['O.S', 'DATA', 'CLIENTE', 'PLACA', 'VALOR', 'PAGAMENTO', 'TECNICO', 'UNIDADE'];
        let total = 0;

        const bodyData = dados.map(item => {
            const valorNum = parseFloat(item.valor || 0);
            total += valorNum;
            return [
                String(item.os || ''),
                String(item.data || ''),
                String(item.cliente || ''),
                String(item.placa || ''),
                'R$ ' + valorNum.toFixed(2),
                String(item.pagamento || ''),
                String(item.tecnico || ''),
                String(item.unidade || '')
            ];
        });

        const headerColor = [74, 144, 226]; // #4a90e2

        doc.autoTable({
            head: [headers],
            body: bodyData,
            startY: 35,
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: headerColor, textColor: 255, fontStyle: 'bold' },
            columnStyles: {
                4: { cellWidth: 20 },
                5: { cellWidth: 20 },
                6: { cellWidth: 20 },
                7: { cellWidth: 20 }
            },
            didDrawPage: function(data) {
                // Header
                doc.setFontSize(16);
                doc.setTextColor(74, 144, 226); // Azul
                doc.text("VDI TAC√ìGRAFOS ‚Äî Relat√≥rio de O.S.", 14, 15);

                doc.setFontSize(10);
                doc.setTextColor(50);
                doc.text(`Filtro Aplicado: ${tituloFiltro}`, 14, 22);

                if (dataInicio || dataFim) {
                    const dataPeriodo = `Per√≠odo: ${dataInicio ? dataInicio.split('-').reverse().join('/') : 'In√≠cio'} a ${dataFim ? dataFim.split('-').reverse().join('/') : 'Fim'}`;
                    doc.text(dataPeriodo, 14, 27);
                }

                // Total da P√°gina
                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.text(`Total Geral: R$ ${total.toFixed(2)}`, 180, 27, { align: 'right' });
                doc.setFontSize(8);
                doc.text(`P√°gina ${data.pageNumber} de ${doc.internal.pages.length - 1}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
            },
            theme: 'striped',
            alternateRowStyles: { fillColor: [249, 249, 249] }
        });

        doc.save(`Relatorio_OS_${tituloFiltro.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
    }

</script>
