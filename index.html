</tbody>
    </table>
</section>

<section class="totals-container">
    <div class="card" id="totalFaturadas"></div>
    <div class="card" id="totalAberto"></div>
    <div class="card" id="totalPix"></div>
    <div class="card" id="totalDinheiro"></div>
    <div class="card" id="totalDebito"></div>
    <div class="card" id="totalCredito"></div>
    <div class="card mo" id="totalMo"></div>
</section>

<div id="formModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharForm()">&times;</span>
        <h2>Cadastrar / Editar O.S.</h2>
        <input type="text" id="formOS" placeholder="O.S." required>
        <input type="date" id="formData" required>
        <input type="text" id="formCliente" placeholder="Cliente" required>
        <input type="text" id="formPlaca" placeholder="Placa" required>
        <input type="number" id="formValorOS" placeholder="Valor OS (apenas itens)" step="0.01">
        <input type="number" id="formValorMO" placeholder="Valor M.O." step="0.01">
        
        <select id="formPagamento">
            <option value="">Forma de Pagamento</option>
            <option value="Faturado">Faturado</option>
            <option value="Em Aberto">Em Aberto</option>
            <option value="PIX">PIX</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Débito">Débito</option>
            <option value="Crédito">Crédito</option>
        </select>
        
        <input type="text" id="formTecnico" placeholder="Técnico">
        <input type="text" id="formOsTecnico" placeholder="O.S. do Técnico">
        
        <select id="formUnidade">
            <option value="">Unidade</option>
            <option value="Barueri">Barueri</option>
            <option value="Cotia">Cotia</option>
            <option value="Embu">Embu</option>
        </select>
        
        <button id="btnSalvar" onclick="salvarForm()">Salvar O.S</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Carregando dados...</p>
</div>

<input type="file" id="inputExcel" accept=".xlsx, .xls" onchange="lerExcel(event)" style="display: none;">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>

<script>
/* ===========================   Configuração Firebase / DB   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM",
  authDomain: "vditacografosfrentecaixa.firebaseapp.com",
  databaseURL: "https://vditacografosfrentecaixa-default-rtdb.firebaseio.com",
  projectId: "vditacografosfrentecaixa",
  storageBucket: "vditacografosfrentecaixa.firebasestorage.app",
  messagingSenderId: "1008625665373",
  appId: "1:1008625665373:web:1f1870898ecb04b4b854b4",
  measurementId: "G-9SYYV1VLNY"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const osCollection = db.collection('ordens_servico');

let osData = []; // cache local

/* cores (mantive para PDF se quiser usar theming) */
const paymentColors = {
  'Faturado': [173,216,230],
  'Em Aberto': [255,192,203],
  'PIX': [175,223,175],
  'Dinheiro': [255,239,173],
  'Débito': [253,222,173],
  'Crédito': [210,180,222]
};

/* --------------------------   Utilities   -------------------------- */
function formatDate(iso){
    if(!iso) return '01/01/2000';
    const parts = iso.split('-');
    if(parts.length !== 3) return iso;
    return `${parts[2]}/${parts[1]}/${parts[0]}`;}

function normalizeText(s){ return String(s||'').toLowerCase().trim(); }

/* --------------------------   Preenche select técnicos   -------------------------- */
function getTecnicosUnicos(){
    const select = document.getElementById('tecnicoFiltro');
    const current = select.value;
    const tecnicos = [...new Set(osData.map(i=> (i.tecnico||'').toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b, 'pt-BR'));
    // rebuild options
    select.innerHTML = '<option value="">Todos Técnicos</option>';
    tecnicos.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
    });
    // restore previous if still present
    if(current && Array.from(select.options).some(o=>o.value===current)) select.value = current;}

/* --------------------------   Firestore listener   -------------------------- */
function setupFirestoreListener(){
    osCollection.onSnapshot(snapshot => {
        const changes = snapshot.docChanges();
        changes.forEach(change => {
            const docData = {...change.doc.data(), id: change.doc.id};
            if(change.type === 'added' || change.type === 'modified'){
                const idx = osData.findIndex(i=>i.id===docData.id);
                if(idx>-1) osData[idx] = docData;
                else osData.push(docData);
            }
            if(change.type === 'removed'){
                osData = osData.filter(i=>i.id!==docData.id);
            }
        });

        // ordenar por data (DD/MM/YYYY)
        osData.sort((a,b)=>{
            const pa = a.data ? a.data.split('/') : ['01','01','2000'];
            const pb = b.data ? b.data.split('/') : ['01','01','2000'];
            const da = new Date(pa[2], pa[1]-1, pa[0]);
            const db = new Date(pb[2], pb[1]-1, pb[0]);
            return db - da;
        });

        // atualizar tecnicos e tabela
        getTecnicosUnicos();
        atualizarTabelaTodas();

        document.getElementById('loadingOverlay').style.display = 'none';
    }, err=>{
        console.error('Erro Firestore:', err);
        document.getElementById('loadingOverlay').style.display = 'none';
    });
}
setupFirestoreListener();

/* --------------------------   Modal open/close / salvar (suporta edição)   -------------------------- */
function abrirForm(item=null){
    const modal = document.getElementById('formModal');
    // clear / populate
    document.getElementById('formOS').value = item ? (item.os||'') : '';
    if(item && item.data){
        const parts = item.data.split('/');
        document.getElementById('formData').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
    } else document.getElementById('formData').value = '';

    document.getElementById('formCliente').value = item ? (item.cliente||'') : '';
    document.getElementById('formPlaca').value = item ? (item.placa||'') : '';
    document.getElementById('formValorOS').value = item ? (item.valor_os ? parseFloat(item.valor_os).toFixed(2) : '') : '';
    document.getElementById('formValorMO').value = item ? (item.valor_mo ? parseFloat(item.valor_mo).toFixed(2) : '') : '';
    document.getElementById('formPagamento').value = item ? (item.pagamento||'') : '';
    document.getElementById('formUnidade').value = item ? (item.unidade||'') : '';
    document.getElementById('formTecnico').value = item ? (item.tecnico||'') : '';
    document.getElementById('formOsTecnico').value = item ? (item.os_tecnico||'') : '';

    // set edit id marker
    if(item && item.id) {
        modal.dataset.editId = item.id;
        document.getElementById('btnSalvar').textContent = 'Atualizar O.S';
    } else {
        delete modal.dataset.editId;
        document.getElementById('btnSalvar').textContent = 'Salvar O.S';
    }

    modal.style.display = 'flex';
}

function fecharForm(){
    const modal = document.getElementById('formModal');
    modal.style.display = 'none';
    delete modal.dataset.editId;
    // limpa campos (opcional)
}

async function salvarForm(){
    const modal = document.getElementById('formModal');
    const editId = modal.dataset.editId || null;

    const os = document.getElementById('formOS').value.trim();
    const dataInput = document.getElementById('formData').value;
    const cliente = document.getElementById('formCliente').value.trim();
    const placa = document.getElementById('formPlaca').value.trim();
    const valorOS = parseFloat(document.getElementById('formValorOS').value || 0);
    const valorMO = parseFloat(document.getElementById('formValorMO').value || 0);
    const pagamento = document.getElementById('formPagamento').value;
    const tecnico = document.getElementById('formTecnico').value.trim();
    const unidade = document.getElementById('formUnidade').value;
    const osTecnico = document.getElementById('formOsTecnico').value.trim();

    if(!os || !dataInput || !cliente || !placa){
        alert('Preencha os campos mínimos: O.S, DATA, CLIENTE, PLACA');
        return;
    }

    const dataFormatada = formatDate(dataInput);
    const registro = {
        os,
        data: dataFormatada,
        cliente,
        placa,
        valor_os: valorOS.toFixed(2),
        valor_mo: valorMO.toFixed(2),
        valor: (valorOS + valorMO).toFixed(2), // VALOR TOTAL é mantido no DB
        pagamento,
        tecnico,
        os_tecnico: osTecnico,
        unidade,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        if(editId){
            await osCollection.doc(editId).update(registro);
            alert('O.S. atualizada com sucesso!');
        } else {
            await osCollection.add(registro);
            alert('O.S. salva com sucesso!');
        }
        fecharForm();
        // atualizar UI (listener fará)
        getTecnicosUnicos();
    } catch(e){
        console.error(e);
        alert('Erro ao salvar na nuvem');
    }}

/* --------------------------   Atualizar tabela e totais (filtra por técnico corretamente, case-insensitive)   -------------------------- */
function atualizarTabelaTodas(){
    const unidade = document.getElementById('unidade').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const termoBusca = document.getElementById('busca').value.toLowerCase();
    const tecnicoFiltroRaw = document.getElementById('tecnicoFiltro').value;
    const tecnicoFiltro = tecnicoFiltroRaw ? tecnicoFiltroRaw.toString().toLowerCase().trim() : '';

    const tbody = document.querySelector('#tabelaTodas tbody');
    tbody.innerHTML = '';

    let totalF = 0, totalAberto = 0, totalPix = 0, totalDin = 0, totalDeb = 0, totalCred = 0, totalMo = 0;

    const dadosFiltrados = osData.filter(item => {
        const itemDate = item.data ? item.data.split('/').reverse().join('-') : '2000-01-01';
        const itemValor = parseFloat(item.valor) || (parseFloat(item.valor_os||0) + parseFloat(item.valor_mo||0));
        const itemPagamento = (item.pagamento || '').toString().toLowerCase().trim();
        const itemTecnico = (item.tecnico || '').toString().toLowerCase().trim();

        if(unidade && item.unidade !== unidade) return false;
        if(tecnicoFiltro && itemTecnico !== tecnicoFiltro) return false;
        if(dataInicio && itemDate < dataInicio) return false;
        if(dataFim && itemDate > dataFim) return false;
        if((item.cliente||'').toUpperCase().includes('CANCELADA')) return false;
        if(termoBusca && !((item.cliente||'').toLowerCase().includes(termoBusca) || (item.placa||'').toLowerCase().includes(termoBusca) || (item.os||'').toLowerCase().includes(termoBusca))) return false;

        // acumula por pagamento
        if(itemPagamento === 'faturado') totalF += itemValor;
        if(itemPagamento === 'em aberto') totalAberto += itemValor;
        if(itemPagamento === 'pix') totalPix += itemValor;
        if(itemPagamento === 'dinheiro') totalDin += itemValor;
        if(itemPagamento === 'débito' || itemPagamento === 'debito') totalDeb += itemValor;
        if(itemPagamento === 'crédito' || itemPagamento === 'credito') totalCred += itemValor;

        // acumula mão de obra
        totalMo += parseFloat(item.valor_mo || 0);

        return true;
    });

    dadosFiltrados.forEach(item => {
        const valorOs = parseFloat(item.valor_os || 0);
        const valorMo = parseFloat(item.valor_mo || 0);
        // const valorTotal = parseFloat(item.valor || (valorOs + valorMo)).toFixed(2); // Variável não utilizada no display

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.os || ''}</td>
                        <td>${item.data || ''}</td>
                        <td>${item.cliente || ''}</td>
                        <td>${item.placa || ''}</td>
                        <td style="text-align:right;">R$ ${valorOs.toFixed(2)}</td>
                        <td style="text-align:right;">R$ ${valorMo.toFixed(2)}</td>
                        <td>${item.pagamento || ''}</td>
                        <td>${item.tecnico || ''}</td>
                        <td>${item.os_tecnico || ''}</td>
                        <td>${item.unidade || ''}</td>
                        <td><button class="edit" onclick="abrirFormForEdit('${item.id}')">Editar</button> <button class="delete" onclick="apagarOS('${item.id}')">Apagar</button></td>`;
        tbody.appendChild(tr);
    });

    // Os totais nos cards permanecem, pois são úteis
    document.getElementById('totalFaturadas').innerHTML = `FATURADAS<br>R$ ${totalF.toFixed(2)}`;
    document.getElementById('totalAberto').innerHTML = `EM ABERTO<br>R$ ${totalAberto.toFixed(2)}`;
    document.getElementById('totalPix').innerHTML = `PIX<br>R$ ${totalPix.toFixed(2)}`;
    document.getElementById('totalDinheiro').innerHTML = `DINHEIRO<br>R$ ${totalDin.toFixed(2)}`;
    document.getElementById('totalDebito').innerHTML = `DÉBITO<br>R$ ${totalDeb.toFixed(2)}`;
    document.getElementById('totalCredito').innerHTML = `CRÉDITO<br>R$ ${totalCred.toFixed(2)}`;
    document.getElementById('totalMo').innerHTML = `MÃO DE OBRA<br>R$ ${totalMo.toFixed(2)}`;
}

/* abrir modal direto em edição (helper) */
function abrirFormForEdit(id){
    const item = osData.find(d => d.id === id);
    if(!item){ alert('Registro não encontrado'); return; }
    abrirForm(item);
}

/* apagar */
async function apagarOS(id){
    if(!confirm('Deseja apagar esta O.S? Esta ação é irreversível.')) return;
    try{
        await osCollection.doc(id).delete();
        alert('O.S. apagada');
    } catch(e){
        console.error(e);
        alert('Erro ao apagar');
    }}

/* limpar filtros */
function limparFiltros(){
    document.getElementById('unidade').value = '';
    document.getElementById('tecnicoFiltro').value = '';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('busca').value = '';
    atualizarTabelaTodas();}

function filtrar(){ atualizarTabelaTodas(); }
function buscar(){ atualizarTabelaTodas(); }

/* limpar todos os dados (cuidado!) */
async function limparDados(){
    if(!confirm('Deseja limpar TODOS os dados NA NUVEM?')) return;
    const snapshot = await osCollection.get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => batch.delete(doc.ref));
    try {
        await batch.commit();
        alert('Dados apagados');
    } catch(e){
        console.error(e);
        alert('Erro ao apagar dados');
    }}

/* --------------------------   Export / Import Excel (VALOR TOTAL REMOVIDO)   -------------------------- */
function exportExcel(){
    const items = osData.map(it => ({
        'O S': it.os || '',
        'DATA': it.data || '',
        'CLIENTE': it.cliente || '',
        'PLACA': it.placa || '',
        'VALOR OS': it.valor_os || '',
        'VALOR MO': it.valor_mo || '',
        // 'VALOR TOTAL': it.valor || (parseFloat(it.valor_os||0)+parseFloat(it.valor_mo||0)).toFixed(2), // REMOVIDO
        'PAGAMENTO': it.pagamento || '',
        'TECNICO': it.tecnico || '',
        'OS TECNICO': it.os_tecnico || '',
        'UNIDADE': it.unidade || ''
    }));

    // Cabeçalho do Excel para exclusão de VALOR TOTAL
    const excelHeaders = ['O S','DATA','CLIENTE','PLACA','VALOR OS','VALOR MO','PAGAMENTO','TECNICO','OS TECNICO','UNIDADE']; 

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(items, {header: excelHeaders});
    XLSX.utils.book_append_sheet(wb, ws, 'O.S');
    XLSX.writeFile(wb, 'OS_FrenteCaixa_Export.xlsx');
}

function importExcel(){ document.getElementById('inputExcel').click(); }

function lerExcel(event){
    const files = event.target.files;
    if(!files || files.length === 0){ event.target.value = null; return; }

    let arquivosProcessados = 0;
    let dadosCombinados = [];

    function normalizeHeader(cell){
        return String(cell||'').toUpperCase().replace(/\s+/g,' ').trim();
    }
    function parseDateCell(cell){
        if(!cell && cell !== 0) return null;
        if (cell instanceof Date) return cell.toISOString().split('T')[0];
        const txt = String(cell).trim();
        if(/^\d{4}-\d{2}-\d{2}/.test(txt)) return txt.split('T')[0];
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(txt)){
            const [d,m,y] = txt.split('/');
            return `${y}-${m}-${d}`;
        }
        const dt = new Date(txt);
        if(!isNaN(dt)) return dt.toISOString().split('T')[0];
        return null;
    }
    function parseMoneyCell(cell){
        if(cell === null || cell === undefined || cell === '') return 0;
        let txt = String(cell).replace(/\s/g,'').replace(/\u00A0/g,'');
        if(/^\d{1,3}(\.\d{3})+,\d{2}$/.test(txt) || (txt.indexOf(',')>-1 && txt.indexOf('.')>-1)){
            txt = txt.replace(/\./g,'').replace(',', '.');
        } else txt = txt.replace(',', '.');
        const val = parseFloat(txt);
        return isNaN(val) ? 0 : val;
    }

    function processarArquivo(file){
        const reader = new FileReader();
        const fileName = file.name.toUpperCase();
        let unidadeDetect = '';
        if(fileName.includes('BARUERI')) unidadeDetect = 'Barueri';
        if(fileName.includes('COTIA')) unidadeDetect = 'Cotia';
        if(fileName.includes('EMBU')) unidadeDetect = 'Embu';

        reader.onload = function(e){
            const data = e.target.result;
            try{
                const workbook = XLSX.read(data, {type:'binary', raw:true, cellDates:true});
                const first = workbook.Sheets[workbook.SheetNames[0]];
                const sheet = XLSX.utils.sheet_to_json(first, {header:1, raw:true, defval:''});

                let headerMap = null;
                let capturing = false;

                for(let i=0;i<sheet.length;i++){
                    const rawRow = sheet[i] || [];
                    const normalizedRow = rawRow.map(c => normalizeHeader(c));
                    const hasData = normalizedRow.some(c => c === 'DATA');
                    const hasOS = normalizedRow.some(c => c === 'O S' || c === 'O.S' || c === 'OS');
                    const hasCliente = normalizedRow.some(c => c === 'CLIENTE');
                    if(!headerMap && hasData && hasOS && hasCliente){
                        headerMap = {};
                        normalizedRow.forEach((cellText, idx) => {
                            if(cellText === 'O S' || cellText === 'O.S' || cellText === 'OS') headerMap.os = idx;
                            else if(cellText === 'DATA') headerMap.data = idx;
                            else if(cellText === 'CLIENTE') headerMap.cliente = idx;
                            else if(cellText === 'PLACA') headerMap.placa = idx;
                            else if(cellText === 'VALOR OS' || cellText === 'VALOR_OS' || cellText === 'VALOR') headerMap.valor_os = idx;
                            else if(cellText === 'VALOR MO' || cellText === 'VALOR_MO') headerMap.valor_mo = idx;
                            else if(cellText === 'PAGAMENTO') headerMap.pagamento = idx;
                            else if(cellText === 'TECNICO') headerMap.tecnico = idx;
                            else if(cellText === 'OS TECNICO' || cellText === 'OS_TECNICO') headerMap.os_tecnico = idx;
                            else if(cellText === 'UNIDADE') headerMap.unidade = idx;
                        });
                        capturing = true;
                        continue;
                    }

                    if(capturing){
                        const rowText = normalizedRow.join(' ');
                        if(rowText.includes('TOTAL') || rowText.includes('RESUMO') || rowText.includes('SAIDAS') || rowText.includes('INICIO DE CX') || (!rawRow || rawRow.length===0)){
                            capturing = false;
                            continue;
                        }
                        if(headerMap){
                            const rawOS = rawRow[headerMap.os] || rawRow[0];
                            if(!rawOS || String(rawOS).trim()==='') continue;

                            let dataCell = headerMap.data !== undefined ? rawRow[headerMap.data] : rawRow[1];
                            let dateISO = parseDateCell(dataCell) || null;
                            if(!dateISO && String(dataCell).trim().length===10 && /^\d{2}\/\d{2}\/\d{4}$/.test(String(dataCell))) dateISO = parseDateCell(dataCell);

                            const valorOsCell = headerMap.valor_os!==undefined ? rawRow[headerMap.valor_os] : rawRow[4];
                            const valorMoCell = headerMap.valor_mo!==undefined ? rawRow[headerMap.valor_mo] : rawRow[5];
                            const pagamentoCell = headerMap.pagamento!==undefined ? rawRow[headerMap.pagamento] : '';
                            const tecnicoCell = headerMap.tecnico!==undefined ? rawRow[headerMap.tecnico] : '';
                            const osTecnicoCell = headerMap.os_tecnico!==undefined ? rawRow[headerMap.os_tecnico] : '';
                            const unidadeCell = headerMap.unidade!==undefined ? rawRow[headerMap.unidade] : unidadeDetect;

                            const vOs = parseMoneyCell(valorOsCell);
                            const vMo = parseMoneyCell(valorMoCell);
                            const totalValor = (vOs + vMo);

                            const item = {
                                os: String(rawOS || ''),
                                data: formatDate(dateISO || '2000-01-01'),
                                cliente: String(rawRow[ headerMap.cliente !== undefined ? headerMap.cliente : 2 ] || ''),
                                placa: String(rawRow[ headerMap.placa !== undefined ? headerMap.placa : 3 ] || ''),
                                valor_os: vOs.toFixed(2),
                                valor_mo: vMo.toFixed(2),
                                valor: totalValor.toFixed(2), // VALOR TOTAL é lido, mas não mostrado na tabela
                                pagamento: String(pagamentoCell || '').trim(),
                                tecnico: String(tecnicoCell || '').trim(),
                                os_tecnico: String(osTecnicoCell || '').trim(),
                                unidade: String(unidadeCell || unidadeDetect || '').trim(),
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            dadosCombinados.push(item);
                        } else {
                            // fallback old style
                            if(rawRow.length >= 7 && rawRow[0] !== ''){
                                const dataCell = rawRow[1];
                                const dateISO = parseDateCell(dataCell);
                                const v = parseMoneyCell(rawRow[4]);
                                const item = {
                                    os: String(rawRow[0] || ''),
                                    data: formatDate(dateISO || '2000-01-01'),
                                    cliente: String(rawRow[2] || ''),
                                    placa: String(rawRow[3] || ''),
                                    valor_os: v.toFixed(2),
                                    valor_mo: '0.00',
                                    valor: v.toFixed(2),
                                    pagamento: String(rawRow[5] || ''),
                                    tecnico: String(rawRow[6] || ''),
                                    os_tecnico: '',
                                    unidade: unidadeDetect,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                dadosCombinados.push(item);
                            }
                        }
                    }
                } // end rows
            } catch(err){
                console.error('Erro processar', file.name, err);
                alert('Erro ao ler ' + file.name);
            } finally {
                arquivosProcessados++;
                if(arquivosProcessados === files.length){
                    const novos = dadosCombinados.filter(it => it.os && it.data && (it.cliente||'').toUpperCase().trim() !== 'CANCELADA');
                    if(novos.length === 0){
                        alert('Nenhum registro válido encontrado nos arquivos importados.');
                        document.getElementById('inputExcel').value = null;
                        return;
                    }

                    if(!confirm(`Deseja salvar ${novos.length} novos registros na nuvem? Registros existentes com o mesmo número de OS serão sobrescritos.`)) return;

                    // Salvar novos dados no Firestore (logica de importacao)
                    const batch = db.batch();
                    novos.forEach(item => {
                        // Procura por OS já existente para fazer update ao invés de add (simplificado)
                        const existente = osData.find(d => d.os === item.os && d.data === item.data);
                        if(existente){
                            batch.update(osCollection.doc(existente.id), item);
                        } else {
                            batch.set(osCollection.doc(), item);
                        }
                    });

                    document.getElementById('loadingOverlay').style.display = 'flex';

                    batch.commit().then(() => {
                        alert(`${novos.length} O.S. importadas/atualizadas com sucesso!`);
                        document.getElementById('inputExcel').value = null; // reset input
                        // A UI será atualizada pelo listener do Firestore
                    }).catch(err => {
                        console.error('Erro ao salvar batch', err);
                        alert('Erro ao salvar dados importados na nuvem.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                    });

                }
            }
        };

        reader.onerror = (err) => {
            console.error(err);
            alert('Erro na leitura do arquivo');
            arquivosProcessados++;
            if(arquivosProcessados === files.length) document.getElementById('inputExcel').value = null;
        };

        reader.readAsBinaryString(file);
    }

    Array.from(files).forEach(processarArquivo);
    event.target.value = null;
}

/* --------------------------   Imprimir PDF / Exportar (VALOR TOTAL REMOVIDO)   -------------------------- */
function imprimirPDF(filtroPagamento=''){
    const unidade = document.getElementById('unidade').value;
    const tecnicoFiltroRaw = document.getElementById('tecnicoFiltro').value;
    const tecnicoFiltro = tecnicoFiltroRaw ? tecnicoFiltroRaw.toString().toLowerCase().trim() : '';
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;

    const dadosParaPDF = osData.filter(item => {
        const itemDate = item.data ? item.data.split('/').reverse().join('-') : '2000-01-01';
        const itemPagamento = (item.pagamento || '').toString().toLowerCase().trim();
        const itemTecnico = (item.tecnico || '').toString().toLowerCase().trim();

        if(unidade && item.unidade !== unidade) return false;
        if(tecnicoFiltro && itemTecnico !== tecnicoFiltro) return false;
        if(dataInicio && itemDate < dataInicio) return false;
        if(dataFim && itemDate > dataFim) return false;
        if((item.cliente||'').toUpperCase().includes('CANCELADA')) return false;
        if(filtroPagamento && item.pagamento !== filtroPagamento) return false;

        return true;
    }).map(item => {
        const valorOs = parseFloat(item.valor_os || 0).toFixed(2);
        const valorMo = parseFloat(item.valor_mo || 0).toFixed(2);
        // const valorTotal = (parseFloat(valorOs) + parseFloat(valorMo)).toFixed(2); // Variável não utilizada na linha

        // Retorna as colunas na ordem desejada para o PDF (VALOR TOTAL REMOVIDO)
        return [
            item.os || '',
            item.data || '',
            item.cliente || '',
            item.placa || '',
            `R$ ${valorOs}`,
            `R$ ${valorMo}`,
            item.pagamento || '',
            item.tecnico || '',
            item.os_tecnico || '',
            item.unidade || ''
        ];
    });

    if(dadosParaPDF.length === 0){ alert('Nenhum dado para imprimir/salvar.'); return; }

    // Colunas do PDF (VALOR TOTAL REMOVIDO)
    const headers = ['O.S','DATA','CLIENTE','PLACA','VALOR OS','VALOR MO','PAGAMENTO','TECNICO','OS TECNICO','UNIDADE'];

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape'); // paisagem para caber mais colunas
    let y = 10;

    doc.setFontSize(16);
    doc.text('Relatório de Ordens de Serviço', 14, y);
    y+= 8;

    const filtrosAplicados = [];
    if(unidade) filtrosAplicados.push(`Unidade: ${unidade}`);
    if(tecnicoFiltroRaw) filtrosAplicados.push(`Técnico: ${tecnicoFiltroRaw}`);
    if(dataInicio && dataFim) filtrosAplicados.push(`Período: ${formatDate(dataInicio)} a ${formatDate(dataFim)}`);
    else if(dataInicio) filtrosAplicados.push(`A partir de: ${formatDate(dataInicio)}`);
    else if(dataFim) filtrosAplicados.push(`Até: ${formatDate(dataFim)}`);
    if(filtroPagamento) filtrosAplicados.push(`Pagamento: ${filtroPagamento}`);

    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Filtros: ${filtrosAplicados.join(' | ') || 'Nenhum'}`, 14, y);
    y+= 6;

    // Coluna 4 (VALOR OS) e 5 (VALOR MO)
    doc.autoTable({
        head: [headers],
        body: dadosParaPDF,
        startY: y,
        theme: 'striped',
        headStyles: { fillColor: [74, 144, 226] },
        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
        columnStyles: { 4: { halign: 'right' }, 5: { halign: 'right' } }, // Alinha Valores à direita (colunas 4 e 5)
        didDrawCell: function(data) {
            // Lógica de cor de fundo (mantida, mas o índice da coluna de Pagamento mudou para 6)
            // if (data.column.index === 6 && data.cell.section === 'body') {
            //     const paymentType = dadosParaPDF[data.row.index][6]; 
            //     const color = paymentColors[paymentType] || [200, 200, 200];
            //     doc.setFillColor(color[0], color[1], color[2]);
            //     doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
            //     doc.text(data.cell.text, data.cell.x + data.cell.padding('left'), data.cell.y + data.cell.height / 2, { valign: 'middle' });
            // }
        },
        didParseCell: function(data){
            if(data.section === 'body'){
                // Ajusta valor de Pagamento para destaque (novo índice 6)
                if(data.column.index === 6){ 
                    // Se precisar de cor de fundo, você pode reativar a lógica em didDrawCell
                }
            }
        }
    });

    const finalY = doc.autoTable.previous.finalY;
    doc.setFontSize(10);
    doc.setTextColor(0);

    // Calcular totais dos cartões (utiliza o valor total do banco de dados) para o resumo
    let totalFPDF = 0, totalAbertoPDF = 0, totalPixPDF = 0, totalDinPDF = 0, totalDebPDF = 0, totalCredPDF = 0, totalMoPDF = 0;
    
    // Filtra e totaliza o valor total para o resumo, mesmo que não esteja na tabela do PDF
    osData.filter(item => {
        const itemDate = item.data ? item.data.split('/').reverse().join('-') : '2000-01-01';
        const itemPagamento = (item.pagamento || '').toString().toLowerCase().trim();
        const itemTecnico = (item.tecnico || '').toString().toLowerCase().trim();

        if(unidade && item.unidade !== unidade) return false;
        if(tecnicoFiltro && itemTecnico !== tecnicoFiltro) return false;
        if(dataInicio && itemDate < dataInicio) return false;
        if(dataFim && itemDate > dataFim) return false;
        if((item.cliente||'').toUpperCase().includes('CANCELADA')) return false;
        if(filtroPagamento && item.pagamento !== filtroPagamento) return false;
        return true;
    }).forEach(item => {
        const valorOs = parseFloat(item.valor_os || 0);
        const valorMo = parseFloat(item.valor_mo || 0);
        const valorTotal = valorOs + valorMo;
        const pagamento = (item.pagamento || '').toLowerCase().trim();

        if(pagamento === 'faturado') totalFPDF += valorTotal;
        if(pagamento === 'em aberto') totalAbertoPDF += valorTotal;
        if(pagamento === 'pix') totalPixPDF += valorTotal;
        if(pagamento === 'dinheiro') totalDinPDF += valorTotal;
        if(pagamento === 'débito' || pagamento === 'debito') totalDebPDF += valorTotal;
        if(pagamento === 'crédito' || pagamento === 'credito') totalCredPDF += valorTotal;
        totalMoPDF += valorMo;
    });

    doc.text(`Total Faturadas: R$ ${totalFPDF.toFixed(2)}`, 14, finalY + 5);
    doc.text(`Total Em Aberto: R$ ${totalAbertoPDF.toFixed(2)}`, 14, finalY + 10);
    doc.text(`Total PIX: R$ ${totalPixPDF.toFixed(2)}`, 14, finalY + 15);
    doc.text(`Total Dinheiro: R$ ${totalDinPDF.toFixed(2)}`, 14, finalY + 20);
    doc.text(`Total Débito: R$ ${totalDebPDF.toFixed(2)}`, 14, finalY + 25);
    doc.text(`Total Crédito: R$ ${totalCredPDF.toFixed(2)}`, 14, finalY + 30);
    doc.text(`Total Mão de Obra: R$ ${totalMoPDF.toFixed(2)}`, 14, finalY + 35);

    doc.save(`Relatorio_OS_${filtroPagamento || 'Geral'}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`);
}
</script>
</body>
</html>
