<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VDI Tac√≥grafos ‚Äî Frente de Caixa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* Estilos CSS */
        body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f4f6f9; }
        header { background: linear-gradient(90deg,#4a90e2,#9013fe); color:white; padding:20px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
        .container { padding:20px; max-width:1200px; margin:auto; }
        .buttons, .filters, .search { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
        button { background:#4a90e2; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; display:flex; align-items:center; gap:5px; }
        button:hover { background:#357ABD; }
        input, select { padding:10px 12px; border-radius:6px; border:1px solid #ccc; box-sizing: border-box;}
        table { width:100%; border-collapse:collapse; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding:12px 15px; text-align:left; }
        th { background:#4a90e2; color:white; }
        tr:nth-child(even) { background:#f9f9f9; }
        tr:hover { background:#dce6f1; }
        .summary { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
        .card { flex:1 1 150px; padding:15px; border-radius:10px; color:white; font-weight:600; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
        .card:hover { opacity:0.9; transform:scale(1.02); }
        .faturadas { background: linear-gradient(45deg,#2d9cdb,#1b7ecf); }
        .emaberto { background: linear-gradient(45deg,#e94e77,#d43d5c); }
        .pix { background: linear-gradient(45deg,#27ae60,#1e8449); }
        .dinheiro { background: linear-gradient(45deg,#f1c40f,#d4ac0d); }
        .debito { background: linear-gradient(45deg,#f39c12,#d68910); }
        .credito { background: linear-gradient(45deg,#9b59b6,#8e44ad); }
        .edit, .delete { border:none; padding:5px 10px; border-radius:6px; color:white; cursor:pointer; margin-right:5px; }
        .edit { background:#27ae60; }
        .delete { background:#e74c3c; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; border-radius:10px; width:90%; max-width:400px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { color:#4a90e2; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin-bottom:15px; width:100%; box-sizing:border-box; }
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 24px; font-weight: 600;
            color: #4a90e2;
        }
        /* Estilo da tela de login */
        #loginScreen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg,#e0e7ff 0%,#f0f2f5 100%);
        }
        #loginBox {
            background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 300px; text-align: center;
        }
        #loginBox h2 { color: #4a90e2; margin-bottom: 25px; }
        #loginBox input { margin-bottom: 15px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; }
        #loginBox button { background: #4a90e2; color: white; padding: 12px; border: none; border-radius: 8px; width: 100%; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        #loginBox button:hover { background: #357ABD; }
        #loginError { color: #e74c3c; margin-top: 10px; font-size: 14px; }
        @media(max-width:600px){
            .buttons, .filters, .search { flex-direction:column; }
            table th, table td { font-size:12px; padding:8px; }
        }
        /* ESTILO CORRIGIDO PARA O LOGO E O T√çTULO */
        #headerLogo {
            max-height: 50px; 
            width: auto;
            display: block;
            margin: 0 auto 5px auto; /* Centraliza e adiciona margem abaixo do logo */
        }
        #headerTitle {
            margin: 0; /* Remove a margem padr√£o do h1 */
            font-size: 24px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div id="loginBox">
        <h2>Acesso Restrito VDI</h2>
        <input type="email" id="loginEmail" placeholder="E-mail" required>
        <input type="password" id="loginPassword" placeholder="Senha" required>
        <button onclick="login()">Entrar no Sistema</button>
        <div id="loginError" style="display:none;"></div>
    </div>
</div>

<div id="loadingOverlay" style="display:none;">
    Conectando √† Nuvem...
</div>

<div id="appContent" style="display:none;">
    <header>
        <img src="logo.png" alt="Logo VDI Tac√≥grafos" id="headerLogo">
        <h1 id="headerTitle">VDI TAC√ìGRAFOS ‚Äî Frente de Caixa (Barueri ¬∑ Cotia ¬∑ Embu)</h1>
    </header>
    <div class="container">
        <div class="buttons">
            <button onclick="abrirForm()">+ Nova O.S</button>
            <button onclick="exportExcel()">Exportar Excel</button>
            <button onclick="importExcel()">Importar Excel</button>
            <button onclick="imprimirPDF()">Imprimir / Salvar PDF</button>
            <button onclick="limparDados()">Limpar dados</button>
            <button onclick="logout()" style="background:#e74c3c;">Sair do Sistema</button>
         </div>
        <input type="file" id="inputExcel" accept=".xlsx,.csv" style="display:none" onchange="lerExcel(event)" multiple>
        <div class="filters">
            <select id="unidade" onchange="atualizarTabelaTodas()">
                <option value="">Todas Unidades</option>
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <select id="tecnicoFiltro" onchange="atualizarTabelaTodas()">
                <option value="">Todos T√©cnicos</option>
                </select>
            <input type="date" id="dataInicio">
            <input type="date" id="dataFim">
            <button onclick="filtrar()">Filtrar</button>
            <button onclick="limparFiltros()">Limpar filtros</button>
        </div>
        <div class="search">
            <input type="text" id="busca" placeholder="Buscar cliente, placa ou O.S">
            <button onclick="buscar()">Buscar</button>
        </div>
        <h3>Todas as O.S</h3>
        <table id="tabelaTodas">
            <thead>
            <tr>
                <th>O.S</th><th>DATA</th><th>CLIENTE</th><th>PLACA</th><th>VALOR</th><th>PAGAMENTO</th><th>TECNICO</th><th>UNIDADE</th><th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Resumo ‚Äî Controle de Caixa Di√°rio</h3>
        <div class="summary">
            <div class="card faturadas" id="totalFaturadas" onclick="imprimirPDF('Faturado')">FATURADAS<br>R$ 0,00</div>
            <div class="card emaberto" id="totalAberto" onclick="imprimirPDF('Em Aberto')">EM ABERTO<br>R$ 0,00</div>
            <div class="card pix" id="totalPix" onclick="imprimirPDF('PIX')">PIX<br>R$ 0,00</div>
            <div class="card dinheiro" id="totalDinheiro" onclick="imprimirPDF('Dinheiro')">DINHEIRO<br>R$ 0,00</div>
            <div class="card debito" id="totalDebito" onclick="imprimirPDF('D√©bito')">D√âBITO<br>R$ 0,00</div>
            <div class="card credito" id="totalCredito" onclick="imprimirPDF('Cr√©dito')">CR√âDITO<br>R$ 0,00</div>
        </div>
    </div>
    
    <div id="formModal" class="modal">
        <div class="modal-content">
            <h2>Nova O.S</h2>
            <input type="text" id="formOS" placeholder="N√∫mero da O.S" required>
            <input type="date" id="formData" required>
            <input type="text" id="formCliente" placeholder="Cliente" required>
            <input type="text" id="formPlaca" placeholder="Placa" required>
            <input type="number" id="formValor" placeholder="Valor (R$)" step="0.01" required>
            <select id="formPagamento" required>
                <option value="">Selecione pagamento</option>
                <option value="PIX">PIX</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cr√©dito">Cr√©dito</option>
                <option value="D√©bito">D√©bito</option>
                <option value="Em Aberto">Em Aberto</option>
                <option value="Faturado">Faturado</option>
            </select>
            <select id="formUnidade" required>
                <option value="">Selecione a Unidade</option>
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <input type="text" id="formTecnico" placeholder="T√©cnico" required>
            <button onclick="salvarForm()">Salvar O.S</button> 
            <button onclick="fecharForm()" style="margin-top:5px;background:#e74c3c;">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // =========================================================================//
    //             CONFIGURA√á√ÉO FIREBASE E CONEX√ÉO FIRESTORE - CREDENCIAIS
    // =========================================================================//
    const firebaseConfig = {
      apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM",
      authDomain: "vditacografosfrentecaixa.firebaseapp.com",
      databaseURL: "https://vditacografosfrentecaixa-default-rtdb.firebaseio.com",
      projectId: "vditacografosfrentecaixa",
      storageBucket: "vditacografosfrentecaixa.firebasestorage.app",
      messagingSenderId: "1008625665373",
      appId: "1:1008625665373:web:1f1870898ecb04b4b854b4",
      measurementId: "G-9SYYV1VLNY"
    };

    // Inicializa o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const auth = firebase.auth(app); 
    const osCollection = db.collection('ordens_servico');

    let osData = [];
    // VARI√ÅVEL GLOBAL PARA CONTROLE DE EDI√á√ÉO
    let osEditandoId = null;
    // VARI√ÅVEL GLOBAL PARA LOGO EM PDF
    let logoBase64 = null; 
    
    // üé® CORES SUAVES/PASTEL PARA O FUNDO DA LINHA DO PDF
    const paymentColors = { 
        'Faturado': [173, 216, 230], // Azul Claro
        'Em Aberto': [255, 192, 203], // Rosa Claro
        'PIX': [175, 223, 175], // Verde Menta
        'Dinheiro': [255, 239, 173], // Amarelo Claro
        'D√©bito': [253, 222, 173], // Laranja Claro
        'Cr√©dito': [210, 180, 222] // Lil√°s Claro
    };
    
    // =================================================================
    // üñºÔ∏è FUN√á√ÉO PARA CARREGAR O LOGO PARA PDF
    // =================================================================

    function loadLogoForPDF() {
        const img = new Image();
        img.crossOrigin = 'Anonymous'; 
        img.onload = function () {
            const canvas = document.createElement('canvas');
            canvas.height = img.naturalHeight;
            canvas.width = img.naturalWidth;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            logoBase64 = canvas.toDataURL('image/png');
            console.log("Logo carregado para PDF.");
        };
        img.onerror = function() {
             console.error("Erro ao carregar o logo para o PDF. Verifique o caminho 'logo.png'.");
             logoBase64 = 'PLACEHOLDER_ERROR'; // Evita quebrar o PDF
        };
        img.src = 'logo.png'; 
    }
    
    // Chama o carregamento do logo no in√≠cio
    loadLogoForPDF(); 


    // =================================================================
    // üîê FUN√á√ïES DE AUTENTICA√á√ÉO FIREBASE
    // =================================================================

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        if (!email || !password) {
            errorDiv.textContent = "Preencha e-mail e senha.";
            errorDiv.style.display = 'block';
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error("Erro de Login:", error);
            let errorMessage = "E-mail ou senha inv√°lidos.";
            if (error.code === 'auth/invalid-email') {
                errorMessage = "Formato de e-mail inv√°lido.";
            }
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        }
    }

    function logout() {
        auth.signOut();
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingOverlay').innerHTML = 'Conectando √† Nuvem...';
            setupFirestoreListener();
        } else {
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }
    });

    // =================================================================
    // ‚öôÔ∏è FUN√á√ïES FIREBASE E SISTEMA 
    // =================================================================

    function setupFirestoreListener() {
        osCollection.onSnapshot(snapshot => {
            const changes = snapshot.docChanges();

            changes.forEach(change => {
                const docData = { ...change.doc.data(), id: change.doc.id };

                if (change.type === "added" || change.type === "modified") {
                    const existingIndex = osData.findIndex(item => item.id === docData.id);
                    if (existingIndex > -1) {
                        osData[existingIndex] = docData;
                    } else {
                        osData.push(docData);
                    }
                }
                if (change.type === "removed") {
                    osData = osData.filter(item => item.id !== docData.id);
                }
            });

            osData.sort((a, b) => {
                const parseDate = (dateStr) => {
                    const parts = dateStr.split('/');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                };
                const dateA = parseDate(a.data || '01/01/2000');
                const dateB = parseDate(b.data || '01/01/2000');
                return dateB - dateA; 
            });

            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';

            getTecnicosUnicos();
            atualizarTabelaTodas();
        }, error => {
            console.error("Erro CR√çTICO ao conectar ao Firestore:", error);
            document.getElementById('loadingOverlay').innerHTML = 'ERRO: Falha ao conectar ao banco de dados na nuvem. VERIFIQUE AS REGRAS DO FIREBASE. (' + error.code + ')';
        });
    }

    /**
     * Converte data de ISO (AAAA-MM-DD) para BR (DD/MM/AAAA)
     */
    function formatDate(iso){
        const parts=iso.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    function getTecnicosUnicos() {
        const tecnicos = [...new Set(osData.map(item => item.tecnico).filter(t => t && t.trim() !== ''))].sort();
        const select = document.getElementById('tecnicoFiltro');
        const valorAtual = select.value;

        select.innerHTML = '<option value="">Todos T√©cnicos</option>';

        tecnicos.forEach(tecnico => {
            const option = document.createElement('option');
            option.value = tecnico;
            option.textContent = tecnico;
            select.appendChild(option);
        });
        if (tecnicos.includes(valorAtual)) {
            select.value = valorAtual;
        } else if (valorAtual && !tecnicos.includes(valorAtual)) {
            select.value = '';
        }
    }

    /**
     * Abre o modal do formul√°rio, configurado para Nova O.S. ou Edi√ß√£o.
     */
    function abrirForm(item = null){
        const modal = document.getElementById('formModal');
        const salvarBtn = modal.querySelector('.modal-content button:first-of-type'); 
        osEditandoId = null; 

        // Limpa o formul√°rio
        document.getElementById('formOS').value = '';
        document.getElementById('formData').value = '';
        document.getElementById('formCliente').value = '';
        document.getElementById('formPlaca').value = '';
        document.getElementById('formValor').value = '';
        document.getElementById('formPagamento').value = '';
        document.getElementById('formTecnico').value = '';
        document.getElementById('formUnidade').value = ''; 
        
        if (item) {
            // MODO EDI√á√ÉO
            osEditandoId = item.id;
            modal.querySelector('h2').textContent = "Editar O.S. Existente";
            salvarBtn.textContent = "Atualizar O.S.";
            salvarBtn.setAttribute('onclick', 'atualizarOS()'); 

            // Pr√©-preenche os campos
            document.getElementById('formOS').value = item.os || '';
            const dataParts = (item.data || '01/01/2000').split('/');
            document.getElementById('formData').value = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`; 
            document.getElementById('formCliente').value = item.cliente || '';
            document.getElementById('formPlaca').value = item.placa || '';
            document.getElementById('formValor').value = parseFloat(item.valor || 0).toFixed(2);
            document.getElementById('formPagamento').value = item.pagamento || '';
            document.getElementById('formUnidade').value = item.unidade || '';
            document.getElementById('formTecnico').value = item.tecnico || '';

        } else {
            // MODO NOVA O.S.
            modal.querySelector('h2').textContent = "Nova O.S";
            salvarBtn.textContent = "Salvar O.S";
            salvarBtn.setAttribute('onclick', 'salvarForm()');

            const unidadeSelecionada = document.getElementById('unidade').value;
            document.getElementById('formUnidade').value = unidadeSelecionada || '';
        }

        // Abertura do modal
        modal.style.display = 'flex';
    }

    function fecharForm(){
        document.getElementById('formModal').style.display='none';
    }

    async function salvarForm(){
        const os=document.getElementById('formOS').value.trim();
        const dataInput=document.getElementById('formData').value;
        const cliente=document.getElementById('formCliente').value.trim();
        const placa=document.getElementById('formPlaca').value.trim();
        const valor=parseFloat(document.getElementById('formValor').value).toFixed(2);
        const pagamento=document.getElementById('formPagamento').value;
        const tecnico=document.getElementById('formTecnico').value.trim();
        const unidade=document.getElementById('formUnidade').value;

        if(!os || !dataInput || !cliente || !placa || !valor || !pagamento || !tecnico || !unidade){
             alert("Preencha todos os campos!");
             return;
        }

        const dataFormatada = formatDate(dataInput);

        const novaOS = {
            os, data: dataFormatada, cliente, placa, valor, pagamento, tecnico, unidade,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
           };

        try {
            await osCollection.add(novaOS);
            alert("O.S. salva na nuvem com sucesso!");
        } catch (e) {
            console.error("Erro ao salvar O.S.: ", e);
            alert("Erro ao salvar O.S. na nuvem. Verifique a conex√£o e as regras do Firebase.");
        }

        fecharForm();
    }
    
    /**
     * Salva as altera√ß√µes da O.S. no Firebase (Modo Edi√ß√£o)
     */
    async function atualizarOS(){
        if (!osEditandoId) {
            alert("ID da O.S. para edi√ß√£o n√£o encontrado.");
            return;
        }

        const os=document.getElementById('formOS').value.trim();
        const dataInput=document.getElementById('formData').value;
        const cliente=document.getElementById('formCliente').value.trim();
        const placa=document.getElementById('formPlaca').value.trim();
        const valor=parseFloat(document.getElementById('formValor').value).toFixed(2);
        const pagamento=document.getElementById('formPagamento').value;
        const tecnico=document.getElementById('formTecnico').value.trim();
        const unidade=document.getElementById('formUnidade').value;

        if(!os || !dataInput || !cliente || !placa || !valor || !pagamento || !tecnico || !unidade){
            alert("Preencha todos os campos!");
            return;
        }

        const dataFormatada = formatDate(dataInput);

        const osAtualizada = {
            os, data: dataFormatada, cliente, placa, valor, pagamento, tecnico, unidade,
        };

        try {
            await osCollection.doc(osEditandoId).update(osAtualizada);
            alert("O.S. atualizada na nuvem com sucesso!");
        } catch (e) {
            console.error("Erro ao atualizar O.S.: ", e);
            alert("Erro ao atualizar O.S. na nuvem. Verifique a conex√£o e as regras do Firebase.");
        }

        fecharForm();
    }


    function atualizarTabelaTodas(){
        const unidade = document.getElementById('unidade').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const termoBusca = document.getElementById('busca').value.toLowerCase();
        const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;

        const tbody = document.querySelector("#tabelaTodas tbody");
        tbody.innerHTML = '';
        let totalF=0, totalAberto=0, totalPix=0, totalDin=0, totalDeb=0, totalCred=0;

        const dadosFiltrados = osData.filter(item => {
            const itemDate = item.data ? item.data.split('/').reverse().join('-') : '01/01/2000';
            const itemValor = parseFloat(item.valor) || 0;
            const itemPagamento = item.pagamento ? item.pagamento.toLowerCase().trim() : '';

            if(unidade && item.unidade !== unidade) return false;
            if(tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
            if(dataInicio && itemDate < dataInicio) return false;
            if(dataFim && itemDate > dataFim) return false;
            if ((item.cliente || '').toUpperCase().includes('CANCELADA')) return false;
            if (termoBusca && !(item.cliente.toLowerCase().includes(termoBusca) || item.placa.toLowerCase().includes(termoBusca) || item.os.toLowerCase().includes(termoBusca))) return false;

            if(itemPagamento === 'faturado') totalF += itemValor;
            if(itemPagamento === 'em aberto') totalAberto += itemValor;
            if(itemPagamento === 'pix') totalPix += itemValor;
            if(itemPagamento === 'dinheiro') totalDin += itemValor;
            if(itemPagamento === 'd√©bito') totalDeb += itemValor;
            if(itemPagamento === 'cr√©dito') totalCred += itemValor;

            return true;
        });

        dadosFiltrados.forEach((item,i)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.os}</td><td>${item.data}</td><td>${item.cliente}</td><td>${item.placa}</td><td>R$ ${parseFloat(item.valor).toFixed(2)}</td><td>${item.pagamento}</td><td>${item.tecnico}</td><td>${item.unidade}</td><td><button class="edit" onclick="editarOS('${item.id}')">Editar</button> <button class="delete" onclick="apagarOS('${item.id}')">Apagar</button></td>`;
            tbody.appendChild(tr);
        });

        document.getElementById('totalFaturadas').innerHTML=`FATURADAS<br>R$ ${totalF.toFixed(2)}`;
        document.getElementById('totalAberto').innerHTML=`EM ABERTO<br>R$ ${totalAberto.toFixed(2)}`;
        document.getElementById('totalPix').innerHTML=`PIX<br>R$ ${totalPix.toFixed(2)}`;
        document.getElementById('totalDinheiro').innerHTML=`DINHEIRO<br>R$ ${totalDin.toFixed(2)}`;
        document.getElementById('totalDebito').innerHTML=`D√âBITO<br>R$ ${totalDeb.toFixed(2)}`;
        document.getElementById('totalCredito').innerHTML=`CR√âDITO<br>R$ ${totalCred.toFixed(2)}`;
    }

    /**
     * Fun√ß√£o para abrir o modal no modo Edi√ß√£o (chama abrirForm com o item)
     */
    function editarOS(id){
        const item = osData.find(d => d.id === id);
        if (!item) {
            alert("O.S. n√£o encontrada para edi√ß√£o.");
            return;
        }
        abrirForm(item); 
    }

    async function apagarOS(id){
          if(confirm("Deseja apagar esta O.S?")){
              try {
                await osCollection.doc(id).delete();
                alert("O.S. apagada da nuvem!");
            } catch (e) {
                console.error("Erro ao apagar O.S.: ", e);
                alert("Erro ao apagar O.S. na nuvem.");
            }
          }
    }

    /**
     * Limpa todos os filtros e atualiza a tabela.
     */
    function limparFiltros(){
        document.getElementById('unidade').value = '';
        document.getElementById('tecnicoFiltro').value = '';
        document.getElementById('dataInicio').value = '';
        document.getElementById('dataFim').value = '';
        document.getElementById('busca').value = '';
        atualizarTabelaTodas(); 
    }

    // Fun√ß√µes de Filtro e Busca que chamam apenas atualizarTabelaTodas()
    function filtrar(){ atualizarTabelaTodas(); }
    function buscar(){ atualizarTabelaTodas(); }

    async function limparDados(){
          if(confirm("Deseja limpar TODOS os dados NA NUVEM? Esta a√ß√£o √© irrevers√≠vel.")){
              const snapshot = await osCollection.get();
              const batch = db.batch();
              snapshot.docs.forEach((doc) => {
                  batch.delete(doc.ref);
              });

                try {
                  await batch.commit();
                  alert("TODOS os dados foram apagados da nuvem.");
              } catch (e) {
                  console.error("Erro ao apagar todos os dados: ", e);
                  alert("Erro ao apagar todos os dados da nuvem.");
              }
          }
    }

    // =================================================================
    // üìä FUN√á√ïES DE EXPORTA√á√ÉO E PDF (COMPLETAS)
    // =================================================================
    function exportExcel(){
              const wb=XLSX.utils.book_new();
              const ws=XLSX.utils.json_to_sheet(osData.map(item => {
                  const { id, ...rest } = item;
                  return rest;
              }));
              XLSX.utils.book_append_sheet(wb,ws,"O.S");
              XLSX.writeFile(wb,"OS_FrenteCaixa.xlsx");
    }

    function importExcel(){ document.getElementById('inputExcel').click(); }

    function lerExcel(event) {
        const files = event.target.files;
        if (files.length === 0) {
              document.getElementById('inputExcel').value = null;
              return;
            }

        let dadosCombinados = [];
        let arquivosProcessados = 0;

        function processarArquivo(file) {
            const reader = new FileReader();
            const fileName = file.name.toUpperCase();
            let unidade = '';
            if (fileName.includes('BARUERI')) {
                  unidade = 'Barueri';
              } else if (fileName.includes('COTIA')) {
                  unidade = 'Cotia';
              } else if (fileName.includes('EMBU')) {
                  unidade = 'Embu';
              }
            reader.onload = function(e) {
                const data = e.target.result;
                try {
                    const workbook = XLSX.read(data, { type: 'binary', raw: true, cellDates: true, dateNF: 'yyyy-mm-dd' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const sheetData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true, defval: '' });

                    let isCapturingData = false;

                    for (let i = 0; i < sheetData.length; i++) {
                        const row = sheetData[i].map(c => String(c).trim().toUpperCase());
                        const rowContainsHeader = row.some(cell => cell === 'O S' || cell === 'O.S') && row.some(cell => cell === 'DATA');

                        if (rowContainsHeader) {
                            isCapturingData = true;
                            continue;
                        }
                        if (isCapturingData) {
                            const isSummaryRow = row.some(cell => cell.includes('TOTAL') || cell.includes('RESUMO') || cell.includes('SAIDAS') || cell.includes('INICIO DE CX'));
                            if (isSummaryRow || row[0] === '') {
                                 isCapturingData = false;
                                 continue;
                            }

                            if (row.length >= 7 && row[0] !== '') {
                                let dataInputExcel = '';
                                if (sheetData[i][1] instanceof Date) {
                                     dataInputExcel = sheetData[i][1].toISOString().split('T')[0];
                                } else if (typeof sheetData[i][1] === 'string' && sheetData[i][1].match(/^\d{4}-\d{2}-\d{2}/)) {
                                     dataInputExcel = sheetData[i][1].split('T')[0];
                                }

                                const osItem = {
                                    os: String(sheetData[i][0] || ''),
                                    data: formatDate(dataInputExcel || '2000-01-01'), 
                                    cliente: String(sheetData[i][2] || ''),
                                    placa: String(sheetData[i][3] || ''),
                                    valor: parseFloat(String(sheetData[i][4] || 0).replace(',', '.')).toFixed(2),
                                    pagamento: String(sheetData[i][5] || ''),
                                    tecnico: String(sheetData[i][6] || ''),
                                    unidade: unidade,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                  };
                                dadosCombinados.push(osItem);
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Erro ao processar o arquivo ${file.name}:`, error);
                    alert(`Erro ao ler o arquivo ${file.name}. Verifique se o formato est√° correto.`);
                } finally {
                    arquivosProcessados++;
                    if (arquivosProcessados === files.length) {

                        const novosRegistros = dadosCombinados.filter(item =>
                            item.os && item.data && item.cliente.toUpperCase().trim() !== 'CANCELADA'
                        );

                        const batch = db.batch();
                        let registrosAdicionados = 0;

                        novosRegistros.forEach(novoItem => {
                            const newDocRef = osCollection.doc();
                            batch.set(newDocRef, novoItem);
                            registrosAdicionados++;
                        });

                        batch.commit().then(() => {
                            alert(`Sucesso! ${files.length} arquivos combinados e ${registrosAdicionados} novos registros importados para a nuvem.`);
                        }).catch(e => {
                            console.error("Erro ao importar dados para o Firebase:", e);
                            alert("Erro ao importar dados para a nuvem.");
                        });

                        document.getElementById('inputExcel').value = null;
                      }
                }
            };
            reader.readAsBinaryString(file)
        }
        Array.from(files).forEach(processarArquivo);
    }
    
    // Fun√ß√µes PDF - Vers√£o 3.x
    function imprimirPDF(filtroPagamento = null) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem (Landscape)
        const margin = 10;
        let y = margin;
        
        // Dados filtrados
        const dadosTabela = osData.filter(item => {
            const itemDate = item.data ? item.data.split('/').reverse().join('-') : '01/01/2000';
            const unidade = document.getElementById('unidade').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;
            const termoBusca = document.getElementById('busca').value.toLowerCase();
            const itemPagamento = item.pagamento ? item.pagamento.toLowerCase().trim() : '';

            if(unidade && item.unidade !== unidade) return false;
            if(tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
            if(dataInicio && itemDate < dataInicio) return false;
            if(dataFim && itemDate > dataFim) return false;
            if ((item.cliente || '').toUpperCase().includes('CANCELADA')) return false;
            if (termoBusca && !(item.cliente.toLowerCase().includes(termoBusca) || item.placa.toLowerCase().includes(termoBusca) || item.os.toLowerCase().includes(termoBusca))) return false;
            if (filtroPagamento && itemPagamento !== filtroPagamento.toLowerCase()) return false;

            return true;
        });

        // T√≠tulo
        let titulo = 'RELAT√ìRIO DE ORDENS DE SERVI√áO';
        if (filtroPagamento) {
            titulo = `RESUMO DE CAIXA: ${filtroPagamento.toUpperCase()}`;
        }
        
        // 1. ADICIONAR LOGO E T√çTULO NO PDF
        const logoWidth = 20; // Largura do logo em mm
        const logoHeight = 20; // Altura do logo em mm
        const titleText = titulo; 

        if (logoBase64 && logoBase64 !== 'PLACEHOLDER_ERROR') {
            const xPos = margin; 
            
            doc.addImage(logoBase64, 'PNG', xPos, y, logoWidth, logoHeight);
            
            doc.setFontSize(14);
            // Posi√ß√£o: 5mm de dist√¢ncia do logo na horizontal, 10mm de dist√¢ncia do topo na vertical
            doc.text(titleText, xPos + logoWidth + 5, y + 10); 
            y += 25; // Avan√ßa a posi√ß√£o Y para depois do bloco logo/t√≠tulo
        } else {
            // Fallback: Se o logo n√£o carregar, apenas coloca o t√≠tulo
            doc.setFontSize(16);
            doc.text(titleText, margin, y + 5);
            y += 10;
        }

        // Cabe√ßalho dos filtros aplicados
        doc.setFontSize(10);
        const filtros = [
            `Unidade: ${document.getElementById('unidade').value || 'Todas'}`,
            `T√©cnico: ${document.getElementById('tecnicoFiltro').value || 'Todos'}`,
            `Per√≠odo: ${document.getElementById('dataInicio').value ? formatDate(document.getElementById('dataInicio').value) : 'In√≠cio'} a ${document.getElementById('dataFim').value ? formatDate(document.getElementById('dataFim').value) : 'Fim'}`,
            `Busca: ${document.getElementById('busca').value || 'Nenhuma'}`,
        ].join(' | ');
        doc.text(filtros, margin, y);
        y += 5;

        // Preparar dados e totais
        const corpoTabela = dadosTabela.map(item => [
            item.os,
            item.data,
            item.cliente,
            item.placa,
            `R$ ${parseFloat(item.valor).toFixed(2)}`,
            item.pagamento,
            item.tecnico,
            item.unidade
        ]);

        const totalGeral = dadosTabela.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
        const corpoTabelaComTotal = corpoTabela.concat([
            ['', '', '', '', 'TOTAL GERAL:', `R$ ${totalGeral.toFixed(2)}`, '', '']
        ]);

        const headStyles = { fillColor: [74, 144, 226], textColor: [255, 255, 255], fontStyle: 'bold' };
        
        // Estilos para o corpo da tabela
        const styles = { fontSize: 8, cellPadding: 3, halign: 'left' };
        
        // Gera√ß√£o do AutoTable
        doc.autoTable({
            head: [['O.S', 'DATA', 'CLIENTE', 'PLACA', 'VALOR', 'PAGAMENTO', 'TECNICO', 'UNIDADE']],
            body: corpoTabelaComTotal,
            startY: y + 3,
            headStyles: headStyles,
            styles: styles,
            columnStyles: {
                4: { halign: 'right' },
                5: { halign: 'center' }
            },
            didParseCell: (data) => {
                // Colore a linha do total
                if (data.row.index === corpoTabela.length) {
                    data.cell.styles.fillColor = [220, 220, 220]; // Cinza claro
                    data.cell.styles.textColor = [0, 0, 0];
                    data.cell.styles.fontStyle = 'bold';
                }
                
                // Colore as linhas de acordo com o pagamento (apenas se for relat√≥rio geral)
                if (!filtroPagamento && data.row.index < corpoTabela.length) {
                    const pagamento = dadosTabela[data.row.index].pagamento;
                    const color = paymentColors[pagamento] || [255, 255, 255]; 
                    data.cell.styles.fillColor = color;
                    data.cell.styles.textColor = [0, 0, 0]; 
                }
            },
            didDrawPage: function(data) {
                // Rodap√© com n√∫mero da p√°gina
                doc.setFontSize(8);
                doc.text("P√°gina " + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - margin, doc.internal.pageSize.height - margin);
                doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, margin, doc.internal.pageSize.height - margin);
            }
        });
        
        doc.save(`Relatorio_VDI_${filtroPagamento || 'Geral'}.pdf`);
    }

    // Inicializa√ß√£o (Certifica que o login est√° sempre checando o estado)
    // O setupFirestoreListener() √© chamado dentro do onAuthStateChanged(user)
    // para garantir que a tabela s√≥ seja carregada ap√≥s o login ser confirmado.

</script>
</body>
</html>
