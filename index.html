<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDI TACÃ“GRAFOS - Frente de Caixa</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        /* ------------------------- Layout Principal ------------------------- */
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .logout-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .container {
            padding: 20px;
        }

        /* ------------------------- Controles e AÃ§Ãµes ------------------------- */
        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .action-bar button, .action-bar input[type="file"] {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .action-bar button:nth-child(1) { /* Novo O.S */
            background-color: #4CAF50;
            color: white;
        }
        .action-bar button:nth-child(1):hover {
            background-color: #45a049;
        }
        .action-bar button:not(:first-child) {
            background-color: #e0e0e0;
            color: #333;
        }
        .action-bar button:not(:first-child):hover {
            background-color: #ccc;
        }

        /* ------------------------- Filtros ------------------------- */
        .filters-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .filters-bar select, .filters-bar input[type="date"], .filters-bar button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .filters-bar button {
            background-color: #2196F3;
            color: white;
            font-weight: normal;
        }
        .filters-bar button:hover {
            background-color: #0b7dda;
        }

        /* ------------------------- Busca ------------------------- */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 0 15px;
        }
        .search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .search-bar button {
            background-color: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ------------------------- Resumo - Cards ------------------------- */
        .resumo-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .card {
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 14px;
            line-height: 1.4;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Cores dos Cards */
        /* NOVO: TOTAL GERAL (Valor OS) */
        #totalOSCard { background-color: #007bff; } 
        #totalMO { background-color: #794BC4; } /* Roxo */
        #totalFaturadas { background-color: #38A0F2; } /* Azul */
        #totalAberto { background-color: #E9577D; } /* Rosa/Vermelho */
        #totalPix { background-color: #3BB16B; } /* Verde */
        #totalDinheiro { background-color: #FFC107; } /* Amarelo */
        #totalDebito { background-color: #F8941C; } /* Laranja */
        #totalCreditoContainer {
            grid-column: 1 / -1; /* Ocupa a largura total */
            background-color: #A064B9; /* Roxo mais claro */
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        #totalCreditoContainer:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* ------------------------- Tabela ------------------------- */
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 10px;
        }
        .table-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table th, table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background-color: #4a90e2;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }
        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        table tr:hover {
            background-color: #f1f1f1;
        }
        .edit, .delete {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        .edit {
            background-color: #4CAF50;
            color: white;
        }
        .delete {
            background-color: #f44336;
            color: white;
        }

        /* ------------------------- Modal Form (Novo/Editar O.S.) ------------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #4a90e2;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-actions {
            text-align: right;
            margin-top: 20px;
        }
        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
        #btnSalvar {
            background-color: #4CAF50;
            color: white;
        }
        #btnSalvar:hover {
            background-color: #45a049;
        }
        #btnCancelar {
            background-color: #f44336;
            color: white;
        }

        /* ------------------------- Loading Overlay ------------------------- */
        .loading-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 18px;
            color: #2196F3;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ------------------------- Login Modal ------------------------- */
        #loginModal {
            display: flex;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .login-box h2 {
            color: #2575fc;
            margin-bottom: 25px;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .login-box button {
            background-color: #2575fc;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover {
            background-color: #1a56cc;
        }

        /* ------------------------- Responsividade ------------------------- */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }
            .action-bar, .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .cards-row {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            .card {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <h2>VDI TACÃ“GRAFOS</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Senha" required>
            <button onclick="handleLogin()">Entrar</button>
        </div>
    </div>

    <div id="appContent" style="display: none;">

        <div class="header">
            <h1>VDI TACÃ“GRAFOS - Frente de Caixa (Barueri - Cotia - Embu)</h1>
            <button class="logout-btn" onclick="handleLogout()">Sair</button>
        </div>

        <div class="container">
            
            <div class="action-bar">
                <button onclick="abrirForm()">+ Nova O.S</button>
                <button onclick="exportExcel()">Exportar Excel</button>
                <button onclick="importExcel()">Importar Excel</button>
                <input type="file" id="inputExcel" accept=".xlsx, .xls" style="display: none;" onchange="lerExcel(event)">
                <button onclick="imprimirPDF()">Imprimir / Salvar PDF Geral</button>
                <button onclick="limparDados()">Limpar dados</button>
            </div>

            <div class="filters-bar">
                <select id="unidade" onchange="filtrar()">
                    <option value="">Todas Unidades</option>
                    <option value="BARUERI">Barueri</option>
                    <option value="COTIA">Cotia</option>
                    <option value="EMBU">Embu</option>
                </select>
                <select id="tecnicoFiltro" onchange="filtrar()">
                    <option value="">Todos TÃ©cnicos</option>
                    </select>
                <input type="date" id="dataInicio" onchange="filtrar()">
                <input type="date" id="dataFim" onchange="filtrar()">
                <button onclick="filtrar()">Filtrar</button>
                <button onclick="limparFiltros()">Limpar filtros</button>
            </div>

            <div class="search-bar">
                <input type="text" id="busca" placeholder="Buscar cliente, placa ou O.S" onkeyup="buscar()">
                <button onclick="buscar()">Buscar</button>
            </div>

            <div class="resumo-title">Resumo â€” Controle de Caixa DiÃ¡rio</div>
            <div class="cards-row">
                <div class="card" id="totalOSCard" onclick="imprimirPDF('ValorOS')">TOTAL GERAL<br>R$ 0,00</div>
                <div class="card" id="totalMO" onclick="imprimirPDF('MÃ£oDeObra')">MÃƒO DE OBRA<br>R$ 0,00</div>
                <div class="card" id="totalFaturadas" onclick="imprimirPDF('Faturado')">FATURADAS<br>R$ 0,00</div>
                <div class="card" id="totalAberto" onclick="imprimirPDF('Em Aberto')">EM ABERTO<br>R$ 0,00</div>
                <div class="card" id="totalPix" onclick="imprimirPDF('PIX')">PIX<br>R$ 0,00</div>
                <div class="card" id="totalDinheiro" onclick="imprimirPDF('Dinheiro')">DINHEIRO<br>R$ 0,00</div>
                <div class="card" id="totalDebito" onclick="imprimirPDF('DÃ©bito')">DÃ‰BITO<br>R$ 0,00</div>
            </div>
            <div class="cards-row" style="margin-top: -15px;">
                <div id="totalCreditoContainer" onclick="imprimirPDF('CrÃ©dito')">CRÃ‰DITO<br>R$ 0,00</div>
            </div>
            
            <div class="table-container">
                <div class="table-title">Todas as O.S</div>
                <table id="tabelaTodas">
                    <thead>
                        <tr>
                            <th>O.S</th>
                            <th>DATA</th>
                            <th>CLIENTE</th>
                            <th>PLACA</th>
                            <th>VALOR OS</th>
                            <th>VALOR MO</th>
                            <th>VALOR (TOTAL)</th>
                            <th>PAGAMENTO</th>
                            <th>TECNICO</th>
                            <th>OS TECNICO</th>
                            <th>UNIDADE</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="formModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="fecharForm()">&times;</span>
                <h2>Cadastro de Ordem de ServiÃ§o</h2>
                <div id="osForm">
                    <div class="form-group">
                        <label for="formOS">O.S:</label>
                        <input type="text" id="formOS" required>
                    </div>
                    <div class="form-group">
                        <label for="formData">Data:</label>
                        <input type="date" id="formData" required>
                    </div>
                    <div class="form-group">
                        <label for="formCliente">Cliente:</label>
                        <input type="text" id="formCliente" required>
                    </div>
                    <div class="form-group">
                        <label for="formPlaca">Placa:</label>
                        <input type="text" id="formPlaca" required>
                    </div>
                    <div class="form-group">
                        <label for="formValorOS">Valor O.S (PeÃ§as):</label>
                        <input type="number" id="formValorOS" step="0.01" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="formValorMO">Valor M.O (MÃ£o de Obra):</label>
                        <input type="number" id="formValorMO" step="0.01" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="formPagamento">Pagamento:</label>
                        <select id="formPagamento">
                            <option value="">Selecione</option>
                            <option value="Faturado">Faturado</option>
                            <option value="Em Aberto">Em Aberto</option>
                            <option value="PIX">PIX</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="DÃ©bito">DÃ©bito</option>
                            <option value="CrÃ©dito">CrÃ©dito</option>
                            <option value="TransferÃªncia">TransferÃªncia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formTecnico">TÃ©cnico:</label>
                        <input type="text" id="formTecnico">
                    </div>
                    <div class="form-group">
                        <label for="formOsTecnico">O.S TÃ©cnico:</label>
                        <input type="text" id="formOsTecnico">
                    </div>
                    <div class="form-group">
                        <label for="formUnidade">Unidade:</label>
                        <select id="formUnidade">
                            <option value="COTIA">Cotia</option>
                            <option value="BARUERI">Barueri</option>
                            <option value="EMBU">Embu</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button id="btnCancelar" type="button" onclick="fecharForm()">Cancelar</button>
                        <button id="btnSalvar" type="button" onclick="salvarForm()">Salvar O.S</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <div>Conectando Ã  Nuvem...</div>
        </div>

    </div>

    <script>
    /* =============================================
    ConfiguraÃ§Ãµes Firebase (VersÃ£o 8)
    ============================================= */
    // ðŸ›‘ ðŸ›‘ ðŸ›‘ IMPORTANTE: VERIFIQUE SE ESTA CHAVE API Ã‰ REAL E VÃLIDA PARA SEU PROJETO! ðŸ›‘ ðŸ›‘ ðŸ›‘
    const firebaseConfig = {
      apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM", 
      authDomain: "vditacografosfrentecaixa.firebaseapp.com",
      databaseURL: "https://vditacografosfrentecaixa-default-rtdb.firebaseio.com",
      projectId: "vditacografosfrentecaixa",
      storageBucket: "vditacografosfrentecaixa.firebasestorage.app", 
      messagingSenderId: "1008625665373",
      appId: "1:1008625665373:web:1f1870898ecb04b4b854b4",
      measurementId: "G-9SYYV1VLNY"
    };

    // InicializaÃ§Ã£o dos serviÃ§os (VersÃ£o 8)
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const auth = firebase.auth(); // Inicializa o Auth
    const osCollection = db.collection('ordens_servico');

    let osData = [];
    window.firestoreListenerStarted = false; // Flag para garantir que o listener sÃ³ inicie uma vez

    /* cores para pdf (seu original) */
    const paymentColors = {
        'Faturado': [173, 216, 230],
        'Em Aberto': [255, 192, 203],
        'PIX': [175, 223, 175],
        'Dinheiro': [255, 239, 173],
        'DÃ©bito': [253, 222, 173],
        'CrÃ©dito': [210, 180, 222]
    };

    /* -------------------------   Helpers (seu original)   ------------------------- */
    function formatDate(iso){
        if(!iso) return '01/01/2000';
        const parts = iso.split('-');
        if(parts.length !== 3) return iso;
        return `${parts[2]}/${parts[1]}/${parts[0]}`
    }
    function normalizeHeader(s){
        return String(s || '').toUpperCase().replace(/\s+/g, ' ').trim();
    }
    function parseDateCell(cell){
        if(!cell && cell !== 0) return null;
        if (cell instanceof Date) {
            return cell.toISOString().split('T')[0];
        }
        const txt = String(cell).trim();
        if(/^\d{4}-\d{2}-\d{2}/.test(txt)) return txt.split('T')[0];
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(txt)){
            const [d,m,y] = txt.split('/');
            return `${y}-${m}-${d}`;
        }
        const dt = new Date(txt);
        if(!isNaN(dt)) return dt.toISOString().split('T')[0];
        return null;
    }
    function parseMoneyCell(cell){
        if(cell === null || cell === undefined || cell === '') return 0;
        let txt = String(cell).replace(/\s/g,'').replace(/\u00A0/g,'');
        if(/^\d{1,3}(\.\d{3})+,\d{2}$/.test(txt) || (txt.indexOf(',')>-1 && txt.indexOf('.')>-1)){
            txt = txt.replace(/\./g,'').replace(',', '.');
        } else {
            txt = txt.replace(',', '.');
        }
        const val = parseFloat(txt);
        return isNaN(val) ? 0 : val;
    }

    /* -------------------------   FunÃ§Ãµes Firebase AUTH   ------------------------- */

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            alert('Preencha email e senha.');
            return;
        }

        try {
            document.getElementById('loadingOverlay').style.display = 'flex';
            await auth.signInWithEmailAndPassword(email, password);
            // onAuthStateChanged irÃ¡ lidar com o restante
        } catch (error) {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert(`Erro de Login: Verifique suas credenciais. (${error.message})`);
        }
    }

    function handleLogout() {
        if (confirm('Deseja sair do sistema?')) {
            auth.signOut();
        }
    }

    function checkAuthState() {
        auth.onAuthStateChanged(user => {
            if (user) {
                // USUÃRIO LOGADO: Mostra o app e carrega os dados
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                            if (!window.firestoreListenerStarted) {
                    setupFirestoreListener();
                    window.firestoreListenerStarted = true;
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            } else {
                // USUÃRIO DESLOGADO: Mostra a tela de login
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    }

    /* -------------------------   Firestore listener   ------------------------- */
    function setupFirestoreListener(){
        document.getElementById('loadingOverlay').style.display = 'flex';
        osCollection.orderBy('data', 'desc').onSnapshot(snapshot => {
            osData = [];
            snapshot.forEach(doc => {
                osData.push({ id: doc.id, ...doc.data() });
            });
            // ApÃ³s carregar, popular o filtro de tÃ©cnicos e aplicar o filtro
            popularTecnicos();
            filtrar(); 
            document.getElementById('loadingOverlay').style.display = 'none';
        }, error => {
            console.error("Erro ao carregar dados do Firestore:", error);
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("Erro ao carregar dados. Verifique a conexÃ£o ou permissÃµes.");
        });
    }

    /* -------------------------   CRUD - Salvar e Deletar   ------------------------- */
    let currentEditId = null;

    function abrirForm(id = null) {
        currentEditId = id;
        const modal = document.getElementById('formModal');
        const h2 = modal.querySelector('h2');
        const btnSalvar = document.getElementById('btnSalvar');
        
        // Limpa o formulÃ¡rio
        document.getElementById('formOS').value = '';
        document.getElementById('formData').value = new Date().toISOString().split('T')[0];
        document.getElementById('formCliente').value = '';
        document.getElementById('formPlaca').value = '';
        document.getElementById('formValorOS').value = '0.00';
        document.getElementById('formValorMO').value = '0.00';
        document.getElementById('formPagamento').value = '';
        document.getElementById('formTecnico').value = '';
        document.getElementById('formOsTecnico').value = '';
        document.getElementById('formUnidade').value = 'COTIA';

        if (id) {
            h2.textContent = 'Editar Ordem de ServiÃ§o';
            btnSalvar.textContent = 'Atualizar O.S';
            const os = osData.find(o => o.id === id);
            if (os) {
                document.getElementById('formOS').value = os.os || '';
                document.getElementById('formData').value = os.data || '';
                document.getElementById('formCliente').value = os.cliente || '';
                document.getElementById('formPlaca').value = os.placa || '';
                document.getElementById('formValorOS').value = os.valor_os ? os.valor_os.toFixed(2) : '0.00';
                document.getElementById('formValorMO').value = os.valor_mo ? os.valor_mo.toFixed(2) : '0.00';
                document.getElementById('formPagamento').value = os.pagamento || '';
                document.getElementById('formTecnico').value = os.tecnico || '';
                document.getElementById('formOsTecnico').value = os.os_tecnico || '';
                document.getElementById('formUnidade').value = os.unidade || 'COTIA';
            }
        } else {
            h2.textContent = 'Cadastro de Ordem de ServiÃ§o';
            btnSalvar.textContent = 'Salvar O.S';
        }
        
        modal.style.display = 'flex';
    }

    function fecharForm() {
        document.getElementById('formModal').style.display = 'none';
        currentEditId = null;
    }

    async function salvarForm() {
        const os = document.getElementById('formOS').value.trim();
        const data = document.getElementById('formData').value.trim();
        const cliente = document.getElementById('formCliente').value.trim();
        const placa = document.getElementById('formPlaca').value.trim();
        const valor_os = parseMoneyCell(document.getElementById('formValorOS').value);
        const valor_mo = parseMoneyCell(document.getElementById('formValorMO').value);
        const pagamento = document.getElementById('formPagamento').value.trim();
        const tecnico = document.getElementById('formTecnico').value.trim();
        const os_tecnico = document.getElementById('formOsTecnico').value.trim();
        const unidade = document.getElementById('formUnidade').value.trim();

        if (!os || !data || !cliente || !pagamento || !unidade) {
            alert('Por favor, preencha os campos obrigatÃ³rios (O.S, Data, Cliente, Pagamento, Unidade).');
            return;
        }

        const osDataToSave = {
            os: os,
            data: data,
            cliente: cliente,
            placa: placa,
            valor_os: valor_os, // MantÃ©m como nÃºmero (PeÃ§as)
            valor_mo: valor_mo, // MantÃ©m como nÃºmero (MÃ£o de Obra)
            valor: valor_os + valor_mo, // Calcula o total completo
            pagamento: pagamento,
            tecnico: tecnico,
            os_tecnico: os_tecnico,
            unidade: unidade,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            if (currentEditId) {
                // Atualizar
                await osCollection.doc(currentEditId).update(osDataToSave);
                alert('Ordem de ServiÃ§o atualizada com sucesso!');
            } else {
                // Novo
                await osCollection.add(osDataToSave);
                alert('Ordem de ServiÃ§o salva com sucesso!');
            }
            fecharForm();
        } catch (error) {
            console.error("Erro ao salvar O.S.:", error);
            alert("Erro ao salvar a O.S. Tente novamente.");
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    async function deletarOS(id) {
        if (confirm('Tem certeza que deseja deletar esta Ordem de ServiÃ§o? Esta aÃ§Ã£o Ã© irreversÃ­vel.')) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                await osCollection.doc(id).delete();
                alert('Ordem de ServiÃ§o deletada com sucesso!');
            } catch (error) {
                console.error("Erro ao deletar O.S.:", error);
                alert("Erro ao deletar a O.S. Tente novamente.");
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
    }

    /* -------------------------   Filtros e Busca   ------------------------- */

    function popularTecnicos() {
        const tecnicoSet = new Set();
        osData.forEach(item => {
            if (item.tecnico) tecnicoSet.add(item.tecnico.toUpperCase());
        });
        
        const select = document.getElementById('tecnicoFiltro');
        const currentValue = select.value;
        select.innerHTML = '<option value="">Todos TÃ©cnicos</option>';
        
        const sortedTecnicos = Array.from(tecnicoSet).sort();
        sortedTecnicos.forEach(tecnico => {
            const option = document.createElement('option');
            option.value = tecnico;
            option.textContent = tecnico;
            select.appendChild(option);
        });

        // Tenta manter o valor selecionado apÃ³s a atualizaÃ§Ã£o
        if (currentValue && tecnicoSet.has(currentValue)) {
            select.value = currentValue;
        }
    }

    function filtrar() {
        // Pega os valores dos filtros
        const unidadeFiltro = document.getElementById('unidade').value.toUpperCase();
        const dataInicioFiltro = document.getElementById('dataInicio').value;
        const dataFimFiltro = document.getElementById('dataFim').value;
        const tecnicoFiltro = document.getElementById('tecnicoFiltro').value.toUpperCase();
        const buscaTermo = document.getElementById('busca').value.toLowerCase().trim();

        let dadosFiltrados = osData;

        // 1. Filtro por Unidade
        if (unidadeFiltro) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                (item.unidade || '').toUpperCase() === unidadeFiltro
            );
        }

        // 2. Filtro por TÃ©cnico
        if (tecnicoFiltro) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                (item.tecnico || '').toUpperCase() === tecnicoFiltro
            );
        }

        // 3. Filtro por Data
        if (dataInicioFiltro && dataFimFiltro) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                item.data >= dataInicioFiltro && item.data <= dataFimFiltro
            );
        } else if (dataInicioFiltro) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                item.data >= dataInicioFiltro
            );
        } else if (dataFimFiltro) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                item.data <= dataFimFiltro
            );
        }

        // 4. Busca por Termo (aplicada APÃ“S os filtros principais)
        if (buscaTermo) {
            dadosFiltrados = dadosFiltrados.filter(item => 
                (item.cliente || '').toLowerCase().includes(buscaTermo) ||
                (item.placa || '').toLowerCase().includes(buscaTermo) ||
                (item.os || '').toLowerCase().includes(buscaTermo)
            );
        }

        atualizarTabelaTodas(dadosFiltrados);
        atualizarCards(dadosFiltrados);
    }

    function buscar() {
        // A funÃ§Ã£o buscar apenas chama o filtrar para aplicar o termo de busca junto com os outros filtros
        filtrar();
    }

    function limparFiltros() {
        document.getElementById('unidade').value = '';
        document.getElementById('tecnicoFiltro').value = '';
        document.getElementById('dataInicio').value = '';
        document.getElementById('dataFim').value = '';
        document.getElementById('busca').value = '';
        filtrar();
    }

    /* -------------------------   AtualizaÃ§Ã£o da Tabela e Cards   ------------------------- */

    function atualizarTabelaTodas(dados) {
        const tbody = document.getElementById('tabelaTodas').querySelector('tbody');
        tbody.innerHTML = ''; // Limpa a tabela

        dados.forEach(item => {
            const tr = document.createElement('tr');
            
            // Valores monetÃ¡rios seguros e formatados
            const valorOS = item.valor_os || 0;
            const valorMO = item.valor_mo || 0;
            const valorTotal = valorOS + valorMO;

            tr.innerHTML = `
                <td>${item.os || ''}</td>
                <td>${formatDate(item.data) || ''}</td>
                <td>${item.cliente || ''}</td>
                <td>${item.placa || ''}</td>
                <td>R$ ${valorOS.toFixed(2).replace('.', ',')}</td>
                <td>R$ ${valorMO.toFixed(2).replace('.', ',')}</td>
                <td>R$ ${valorTotal.toFixed(2).replace('.', ',')}</td>
                <td>${item.pagamento || ''}</td>
                <td>${item.tecnico || ''}</td>
                <td>${item.os_tecnico || ''}</td>
                <td>${item.unidade || ''}</td>
                <td>
                    <button class="edit" onclick="abrirForm('${item.id}')">Editar</button>
                    <button class="delete" onclick="deletarOS('${item.id}')">Deletar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function atualizarCards(dados) {
        let totais = {
            valorOS: 0,
            maoDeObra: 0,
            Faturado: 0,
            EmAberto: 0,
            PIX: 0,
            Dinheiro: 0,
            Debito: 0,
            Credito: 0
        };

        dados.forEach(item => {
            const valorOS = item.valor_os || 0;
            const valorMO = item.valor_mo || 0;
            const valorCompleto = valorOS + valorMO;
            const pagamento = (item.pagamento || '').trim();

            // Totalizadores Principais
            totais.valorOS += valorOS;
            totais.maoDeObra += valorMO;

            // Totalizadores por Pagamento (usando o valor COMPLETO da O.S.)
            switch (pagamento) {
                case 'Faturado':
                    totais.Faturado += valorCompleto;
                    break;
                case 'Em Aberto':
                    totais.EmAberto += valorCompleto;
                    break;
                case 'PIX':
                    totais.PIX += valorCompleto;
                    break;
                case 'Dinheiro':
                    totais.Dinheiro += valorCompleto;
                    break;
                case 'DÃ©bito':
                    totais.Debito += valorCompleto;
                    break;
                case 'CrÃ©dito':
                    totais.Credito += valorCompleto;
                    break;
                // Outras formas de pagamento como TransferÃªncia nÃ£o sÃ£o contadas nos cards
            }
        });

        // FunÃ§Ã£o para formatar o valor (R$ 0,00)
        const formatarReal = valor => `R$ ${valor.toFixed(2).replace('.', ',')}`;

        // Atualiza os Cards
        // NOVO BOTÃƒO: TOTAL GERAL (Valor OS)
        document.getElementById('totalOSCard').innerHTML = `TOTAL GERAL<br>${formatarReal(totais.valorOS)}`;
        
        document.getElementById('totalMO').innerHTML = `MÃƒO DE OBRA<br>${formatarReal(totais.maoDeObra)}`;
        document.getElementById('totalFaturadas').innerHTML = `FATURADAS<br>${formatarReal(totais.Faturado)}`;
        document.getElementById('totalAberto').innerHTML = `EM ABERTO<br>${formatarReal(totais.EmAberto)}`;
        document.getElementById('totalPix').innerHTML = `PIX<br>${formatarReal(totais.PIX)}`;
        document.getElementById('totalDinheiro').innerHTML = `DINHEIRO<br>${formatarReal(totais.Dinheiro)}`;
        document.getElementById('totalDebito').innerHTML = `DÃ‰BITO<br>${formatarReal(totais.Debito)}`;
        document.getElementById('totalCreditoContainer').innerHTML = `CRÃ‰DITO<br>${formatarReal(totais.Credito)}`;
    }


    /* -------------------------   PDF e Excel   ------------------------- */

    async function imprimirPDF(filtro = null) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        let dadosFiltrados = [...osData]; // ComeÃ§a com todos os dados
        let titulo = 'RelatÃ³rio Geral de Ordens de ServiÃ§o';
        let colunas = ['O.S', 'Data', 'Cliente', 'Placa', 'Valor O.S', 'Valor M.O', 'Total', 'Pagamento', 'TÃ©cnico', 'Unidade'];
        
        const dataInicioFiltro = document.getElementById('dataInicio').value;
        const dataFimFiltro = document.getElementById('dataFim').value;
        const unidadeFiltro = document.getElementById('unidade').value.toUpperCase();
        const tecnicoFiltro = document.getElementById('tecnicoFiltro').value.toUpperCase();
        
        // 1. Aplica Filtros de Busca/Data/Unidade/TÃ©cnico antes do filtro de Card
        let dadosBase = osData;

        if (unidadeFiltro) {
            dadosBase = dadosBase.filter(item => 
                (item.unidade || '').toUpperCase() === unidadeFiltro
            );
        }

        if (tecnicoFiltro) {
            dadosBase = dadosBase.filter(item => 
                (item.tecnico || '').toUpperCase() === tecnicoFiltro
            );
        }

        if (dataInicioFiltro && dataFimFiltro) {
            dadosBase = dadosBase.filter(item => 
                item.data >= dataInicioFiltro && item.data <= dataFimFiltro
            );
        } else if (dataInicioFiltro) {
            dadosBase = dadosBase.filter(item => 
                item.data >= dataInicioFiltro
            );
        } else if (dataFimFiltro) {
            dadosBase = dadosBase.filter(item => 
                item.data <= dataFimFiltro
            );
        }
        
        dadosFiltrados = dadosBase; // ComeÃ§a com os dados filtrados pela interface

        // 2. Aplica Filtro especÃ­fico do Card (Pagamento ou Valor)
        let totalizador = 0;
        let totalGeral = 0;

        switch (filtro) {
            case 'ValorOS':
                dadosFiltrados = dadosFiltrados.filter(item => (item.valor_os || 0) > 0);
                titulo = 'RelatÃ³rio TOTAL GERAL (VALOR OS - PEÃ‡AS)';
                totalizador = dadosFiltrados.reduce((sum, item) => sum + (item.valor_os || 0), 0);
                break;
            case 'MÃ£oDeObra':
                dadosFiltrados = dadosFiltrados.filter(item => (item.valor_mo || 0) > 0);
                titulo = 'RelatÃ³rio de O.S. (MÃƒO DE OBRA)';
                totalizador = dadosFiltrados.reduce((sum, item) => sum + (item.valor_mo || 0), 0);
                break;
            case 'Faturado':
            case 'Em Aberto':
            case 'PIX':
            case 'Dinheiro':
            case 'DÃ©bito':
            case 'CrÃ©dito':
                dadosFiltrados = dadosFiltrados.filter(item => (item.pagamento || '').trim() === filtro);
                titulo = `RelatÃ³rio de O.S. Pagas em ${filtro}`;
                totalizador = dadosFiltrados.reduce((sum, item) => sum + (item.valor || 0), 0);
                break;
            default:
                // Filtro geral
                totalGeral = dadosFiltrados.reduce((sum, item) => sum + (item.valor || 0), 0);
                break;
        }


        // 3. Prepara os dados para a tabela do PDF
        const dataTable = dadosFiltrados.map(item => {
            const valorOS = item.valor_os || 0;
            const valorMO = item.valor_mo || 0;
            const valorTotal = valorOS + valorMO;
            
            return [
                item.os || '',
                formatDate(item.data) || '',
                item.cliente || '',
                item.placa || '',
                `R$ ${valorOS.toFixed(2).replace('.', ',')}`,
                `R$ ${valorMO.toFixed(2).replace('.', ',')}`,
                `R$ ${valorTotal.toFixed(2).replace('.', ',')}`,
                item.pagamento || '',
                item.tecnico || '',
                item.unidade || ''
            ];
        });

        // 4. Configura o jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem (landscape), mm, A4

        let finalY = 20;

        // TÃ­tulo e filtros aplicados
        doc.setFontSize(16);
        doc.text(titulo, 14, 15);
        
        doc.setFontSize(10);
        const filtrosAplicados = [
            `PerÃ­odo: ${dataInicioFiltro ? formatDate(dataInicioFiltro) : 'InÃ­cio'} a ${dataFimFiltro ? formatDate(dataFimFiltro) : 'Fim'}`,
            `Unidade: ${unidadeFiltro || 'Todas'}`,
            `TÃ©cnico: ${tecnicoFiltro || 'Todos'}`,
        ];
        doc.text(filtrosAplicados.join(' | '), 14, 22);
        finalY = 30;


        // Adiciona a tabela
        doc.autoTable({
            startY: finalY,
            head: [colunas],
            body: dataTable,
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [74, 144, 226] },
            columnStyles: {
                4: { cellWidth: 20, halign: 'right' }, // Valor OS
                5: { cellWidth: 20, halign: 'right' }, // Valor MO
                6: { cellWidth: 20, halign: 'right' }  // Total
            },
            didParseCell: function(data) {
                // Colore a linha baseada na forma de pagamento
                if (data.section === 'body') {
                    const pagamento = dadosFiltrados[data.row.index].pagamento;
                    if (paymentColors[pagamento]) {
                        data.cell.styles.fillColor = paymentColors[pagamento];
                    }
                }
            },
            didDrawPage: function(data) {
                // Footer
                doc.setFontSize(8);
                const pageCount = doc.internal.getNumberOfPages();
                doc.text(`PÃ¡gina ${data.pageNumber} de ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 5);
            },
            willDrawCell: function(data) {
                // Desenha a linha de total
                if (data.row.section === 'body' && data.row.index === dataTable.length - 1) {
                    if (data.column.index === 0) {
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.5);
                        doc.line(data.settings.margin.left, data.cell.y + data.cell.height + 0.5, doc.internal.pageSize.width - data.settings.margin.right, data.cell.y + data.cell.height + 0.5);
                    }
                }
            }
        });

        // Adiciona o total no final
        finalY = doc.autoTable.previous.finalY + 3;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        
        if (filtro === null) {
            // RelatÃ³rio Geral (sem clique em card) - Soma do valor completo de todas as O.S. filtradas
            doc.text(`TOTAL GERAL DE TODAS AS O.S. (O.S. + M.O.): R$ ${totalGeral.toFixed(2).replace('.', ',')}`, 14, finalY);
        } else if (filtro === 'ValorOS' || filtro === 'MÃ£oDeObra') {
            // RelatÃ³rio de Valor OS ou MÃ£o de Obra
            doc.text(`TOTAL CALCULADO: R$ ${totalizador.toFixed(2).replace('.', ',')}`, 14, finalY);
        } else {
            // RelatÃ³rios por Pagamento (soma dos totais de O.S.)
            doc.text(`TOTAL PAGO/FATURADO em ${filtro}: R$ ${totalizador.toFixed(2).replace('.', ',')}`, 14, finalY);
        }

        doc.save(`${titulo.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        document.getElementById('loadingOverlay').style.display = 'none';
    }


    function exportExcel() {
        if (osData.length === 0) {
            alert('NÃ£o hÃ¡ dados para exportar.');
            return;
        }

        const dataForExport = osData.map(item => ({
            OS: item.os || '',
            Data: formatDate(item.data) || '',
            Cliente: item.cliente || '',
            Placa: item.placa || '',
            'Valor OS (PeÃ§as)': (item.valor_os || 0).toFixed(2).replace('.', ','),
            'Valor MO': (item.valor_mo || 0).toFixed(2).replace('.', ','),
            'Valor Total': (item.valor || 0).toFixed(2).replace('.', ','),
            Pagamento: item.pagamento || '',
            TÃ©cnico: item.tecnico || '',
            'OS TÃ©cnico': item.os_tecnico || '',
            Unidade: item.unidade || ''
        }));

        const ws = XLSX.utils.json_to_sheet(dataForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "OrdensServico");
        XLSX.writeFile(wb, "Relatorio_VDI_Tacografos.xlsx");
    }

    function importExcel() {
        document.getElementById('inputExcel').click();
    }

    function lerExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById('loadingOverlay').style.display = 'flex';

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (json.length < 2) {
                    alert("O arquivo Excel estÃ¡ vazio ou nÃ£o possui cabeÃ§alho.");
                    return;
                }

                const headers = json[0].map(h => normalizeHeader(h));
                const records = json.slice(1).map(row => {
                    const record = {};
                    headers.forEach((header, index) => {
                        let value = row[index];
                        if(header.includes('VALOR OS') || header.includes('VALOR MO') || header.includes('VALOR TOTAL')){
                            record[header.includes('VALOR OS') ? 'valor_os' : header.includes('VALOR MO') ? 'valor_mo' : 'valor'] = parseMoneyCell(value);
                        } else if(header.includes('DATA')){
                            record.data = parseDateCell(value);
                        } else {
                            // Mapeamento simples de cabeÃ§alhos
                            if(header.includes('OS TÃ‰CNICO')) record.os_tecnico = String(value || '').trim();
                            else if(header.includes('TÃ‰CNICO')) record.tecnico = String(value || '').trim();
                            else if(header.includes('PAGAMENTO')) record.pagamento = String(value || '').trim();
                            else if(header.includes('UNIDADE')) record.unidade = String(value || '').trim();
                            else if(header.includes('PLACA')) record.placa = String(value || '').trim();
                            else if(header.includes('CLIENTE')) record.cliente = String(value || '').trim();
                            else if(header.includes('OS')) record.os = String(value || '').trim();
                        }
                    });
                    
                    // Garante que o campo 'valor' (total) Ã© calculado corretamente, mesmo se nÃ£o vier no Excel
                    const finalValorOS = record.valor_os || 0;
                    const finalValorMO = record.valor_mo || 0;
                    record.valor = finalValorOS + finalValorMO;
                    record.timestamp = firebase.firestore.FieldValue.serverTimestamp();

                    return record;
                }).filter(record => record.os && record.data); // Filtra registros invÃ¡lidos

                if (records.length === 0) {
                    alert("Nenhum registro vÃ¡lido encontrado para importaÃ§Ã£o. Verifique se as colunas estÃ£o corretas (OS, Data, Cliente, Valor OS, Valor MO).");
                    return;
                }

                // InÃ­cio da importaÃ§Ã£o
                const batch = db.batch();
                let importCount = 0;

                records.forEach(record => {
                    // Crie um novo documento. VocÃª pode adicionar lÃ³gica para evitar duplicatas se necessÃ¡rio.
                    const newDocRef = osCollection.doc(); 
                    batch.set(newDocRef, record);
                    importCount++;
                });

                await batch.commit();
                alert(`${importCount} Ordens de ServiÃ§o importadas com sucesso!`);
                event.target.value = null; // Limpa o input file
                // A atualizaÃ§Ã£o da interface serÃ¡ feita automaticamente pelo listener do Firestore
            } catch (error) {
                console.error("Erro durante a importaÃ§Ã£o do Excel:", error);
                alert(`Erro ao processar o arquivo. Verifique se Ã© um formato .xlsx vÃ¡lido. Detalhe: ${error.message}`);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // FunÃ§Ã£o para limpar todos os dados (USO EXTREMO - APENAS ADMIN)
    async function limparDados() {
        if (!confirm('ATENÃ‡ÃƒO: VocÃª tem certeza que deseja APAGAR TODAS as Ordens de ServiÃ§o do Firestore? Esta aÃ§Ã£o Ã© IRREVERSÃVEL!')) {
            return;
        }

        document.getElementById('loadingOverlay').style.display = 'flex';
        const collectionRef = osCollection;
        const query = collectionRef.limit(100);

        try {
            while (true) {
                const snapshot = await query.get();
                if (snapshot.size === 0) break;

                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
            }
            alert('Todos os dados foram apagados com sucesso!');
        } catch (error) {
            console.error("Erro ao apagar dados:", error);
            alert("Erro ao apagar dados. Tente novamente.");
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }


    /* -------------------------   InicializaÃ§Ã£o   ------------------------- */

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa o processo de autenticaÃ§Ã£o
        checkAuthState(); 
    });
    </script>
</body>
</html>
