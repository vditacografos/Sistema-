<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  Â  <title>VDI TacÃ³grafos â€” Frente de Caixa Colaborativo</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  Â  <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â Â 
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* CSS COMPLETO: Mantenha aqui */
Â  Â  Â  Â  body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f4f6f9; }
Â  Â  Â  Â  header { background: linear-gradient(90deg,#4a90e2,#9013fe); color:white; padding:20px; text-align:center; font-size:24px; font-weight:600; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .container { padding:20px; max-width:1200px; margin:auto; }
Â  Â  Â  Â  .buttons, .filters, .search { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
Â  Â  Â  Â  button { background:#4a90e2; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; display:flex; align-items:center; gap:5px; }
Â  Â  Â  Â  button:hover { background:#357ABD; }
Â  Â  Â  Â  input, select { padding:10px 12px; border-radius:6px; border:1px solid #ccc; box-sizing: border-box;}
Â  Â  Â  Â  table { width:100%; border-collapse:collapse; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
Â  Â  Â  Â  th, td { padding:12px 15px; text-align:left; }
Â  Â  Â  Â  th { background:#4a90e2; color:white; }
Â  Â  Â  Â  tr:nth-child(even) { background:#f9f9f9; }
Â  Â  Â  Â  tr:hover { background:#dce6f1; }
Â  Â  Â  Â  .summary { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
Â  Â  Â  Â  .card { flex:1 1 150px; padding:15px; border-radius:10px; color:white; font-weight:600; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
Â  Â  Â  Â  .card:hover { opacity:0.9; transform:scale(1.02); }
Â  Â  Â  Â  .faturadas { background: linear-gradient(45deg,#2d9cdb,#1b7ecf); }
Â  Â  Â  Â  .emaberto { background: linear-gradient(45deg,#e94e77,#d43d5c); }
Â  Â  Â  Â  .pix { background: linear-gradient(45deg,#27ae60,#1e8449); }
Â  Â  Â  Â  .dinheiro { background: linear-gradient(45deg,#f1c40f,#d4ac0d); }
Â  Â  Â  Â  .debito { background: linear-gradient(45deg,#f39c12,#d68910); }
Â  Â  Â  Â  .credito { background: linear-gradient(45deg,#9b59b6,#8e44ad); }
Â  Â  Â  Â  .edit, .delete { border:none; padding:5px 10px; border-radius:6px; color:white; cursor:pointer; margin-right:5px; }
Â  Â  Â  Â  .edit { background:#27ae60; }
Â  Â  Â  Â  .delete { background:#e74c3c; }
Â  Â  Â  Â  #formModal, #loginModal, #userModal {Â 
Â  Â  Â  Â  Â  Â  display:none;
Â  Â  Â  Â  Â  Â  position:fixed;Â 
Â  Â  Â  Â  Â  Â  top:0;Â 
Â  Â  Â  Â  Â  Â  left:0;Â 
Â  Â  Â  Â  Â  Â  width:100%;Â 
Â  Â  Â  Â  Â  Â  height:100%;Â 
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.5);Â 
Â  Â  Â  Â  Â  Â  justify-content:center;Â 
Â  Â  Â  Â  Â  Â  align-items:center;Â 
Â  Â  Â  Â  Â  Â  z-index: 1000;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #formContent { background:white; padding:20px; border-radius:10px; width:400px; max-width:90%; }
Â  Â  Â  Â  #formContent h2 { margin-top:0; color:#4a90e2; }
Â  Â  Â  Â  #formContent input, #formContent select { width:100%; margin-bottom:10px; }
Â  Â  Â  Â  #formContent button { width:100%; }
Â  Â  Â  Â  #loginModal { z-index: 2000; background: #f4f6f9; }
Â  Â  Â  Â  #loginContent {Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  padding: 30px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  width: 300px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);Â 
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loginContent h2 { color: #4a90e2; margin-bottom: 20px;}
Â  Â  Â  Â  #loginContent input { width: 100%; margin-bottom: 15px; }
Â  Â  Â  Â  #loginContent button { width: 100%; padding: 12px;}
Â  Â  Â  Â  #userModal { z-index: 1500; }
Â  Â  Â  Â  #userContent {Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 10px;Â 
Â  Â  Â  Â  Â  Â  width: 400px;Â 
Â  Â  Â  Â  Â  Â  max-width: 90%;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #userList li {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 8px 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  }
Â  Â  Â  Â  #userList button {
Â  Â  Â  Â  Â  Â  background:#e74c3c;Â 
Â  Â  Â  Â  Â  Â  padding:3px 8px;Â 
Â  Â  Â  Â  Â  Â  margin-left:10px;Â 
Â  Â  Â  Â  Â  Â  font-size:12px;Â 
Â  Â  Â  Â  Â  Â  width:auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media(max-width:600px){
Â  Â  Â  Â  Â  Â  .buttons, .filters, .search { flex-direction:column; }
Â  Â  Â  Â  Â  Â  table th, table td { font-size:12px; padding:8px; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div id="loginModal">
Â  Â  <div id="loginContent">
Â  Â  Â  Â  <h2>Acesso ao Sistema</h2>
Â  Â  Â  Â  <form onsubmit="loginAttempt(); return false;">
Â  Â  Â  Â  Â  Â  Â <input type="text" id="loginUser" placeholder="UsuÃ¡rio" required>
Â  Â  Â  Â  Â  Â  <input type="password" id="loginPass" placeholder="Senha" required>
Â  Â  Â  Â  Â  Â  <button type="submit">Entrar</button>
Â  Â  Â  Â  Â  Â  <p id="loginError" style="color:#e74c3c; display:none; margin-top:10px; font-weight:600;">UsuÃ¡rio ou senha invÃ¡lidos.</p>
Â  Â  Â  Â  </form>
Â  Â  </div>
</div>

<div id="userModal">
Â  Â  <div id="userContent">
Â  Â  Â  Â  <h2>Gerenciar UsuÃ¡rios</h2>
Â  Â  Â  Â  <h3 style="color:#4a90e2; margin-top:10px;">Cadastrar Novo UsuÃ¡rio</h3>
Â  Â  Â  Â  <input type="text" id="newUser" placeholder="Novo UsuÃ¡rio" required>
Â  Â  Â  Â  <input type="password" id="newPass" placeholder="Nova Senha" required>
Â  Â  Â  Â  <button onclick="registerUser()">Cadastrar</button>
Â  Â  Â  Â  <h3 style="color:#4a90e2; margin-top:20px;">UsuÃ¡rios Cadastrados</h3>
Â  Â  Â  Â  <ul id="userList" style="list-style-type:none; padding:0;">
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  <button onclick="closeUserModal()" style="margin-top:20px;background:#e74c3c;">Fechar</button>
Â  Â  </div>
</div>

<div id="appContent" style="display:none;">
Â  Â  <header>VDI TACÃ“GRAFOS â€” Frente de Caixa Colaborativo (Barueri Â· Cotia Â· Embu)</header>
Â  Â  <div class="container">
Â  Â  Â  Â  <div class="buttons">
Â  Â  Â  Â  Â  Â  <button onclick="abrirForm()">+ Nova O.S</button>
Â  Â  Â  Â  Â  Â  <button onclick="exportExcel()">Exportar Excel</button>
Â  Â  Â  Â  Â  Â  <button onclick="importExcel()">Importar Excel</button>
Â  Â  Â  Â  Â  Â  <button onclick="imprimirPDF()">Imprimir / Salvar PDF</button>
Â  Â  Â  Â  Â  Â  <button onclick="limparDados()" style="background:#e74c3c;">Limpar TODOS os dados</button>
Â  Â  Â  Â  Â  Â  <button onclick="openUserModal()" style="background:#9b59b6;">Gerenciar UsuÃ¡rios</button>
Â </div>
Â  Â  Â  Â  <input type="file" id="inputExcel" accept=".xlsx,.csv" style="display:none" onchange="lerExcel(event)" multiple>

Â  Â  Â  Â  <div class="filters">
Â  Â  Â  Â  Â  Â  <select id="unidade" onchange="atualizarTabelaTodas()">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todas Unidades</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Barueri">Barueri</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cotia">Cotia</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Embu">Embu</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <select id="tecnicoFiltro" onchange="atualizarTabelaTodas()">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos TÃ©cnicos</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <input type="date" id="dataInicio">
Â  Â  Â  Â  Â  Â  <input type="date" id="dataFim">
Â  Â  Â  Â  Â  Â  <button onclick="filtrar()">Filtrar</button>
Â  Â  Â  Â  Â  Â  <button onclick="limparFiltros()">Limpar filtros</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="search">
Â  Â  Â  Â  Â  Â  <input type="text" id="busca" placeholder="Buscar cliente, placa ou O.S">
Â  Â  Â  Â  Â  Â  <button onclick="buscar()">Buscar</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h3>Todas as O.S</h3>
Â  Â  Â  Â  <table id="tabelaTodas">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th>O.S</th><th>DATA</th><th>CLIENTE</th><th>PLACA</th><th>VALOR</th><th>PAGAMENTO</th><th>TECNICO</th><th>UNIDADE</th><th>AÃ§Ãµes</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  </table>

Â  Â  Â  Â  <h3>Resumo â€” Controle de Caixa DiÃ¡rio</h3>
Â  Â  Â  Â  <div class="summary">
Â  Â  Â  Â  Â  Â  <div class="card faturadas" id="totalFaturadas" onclick="imprimirPDF('Faturado')">FATURADAS<br>R$ 0,00</div>
Â  Â  Â  Â  Â  Â  <div class="card emaberto" id="totalAberto" onclick="imprimirPDF('Em Aberto')">EM ABERTO<br>R$ 0,00</div>
Â  Â  Â  Â  Â  Â  <div class="card pix" id="totalPix" onclick="imprimirPDF('PIX')">PIX<br>R$ 0,00</div>
Â  Â  Â  Â  Â  Â  <div class="card dinheiro" id="totalDinheiro" onclick="imprimirPDF('Dinheiro')">DINHEIRO<br>R$ 0,00</div>
Â  Â  Â  Â  Â  Â  <div class="card debito" id="totalDebito" onclick="imprimirPDF('DÃ©bito')">DÃ‰BITO<br>R$ 0,00</div>
Â  Â  Â  Â  Â  Â  <div class="card credito" id="totalCredito" onclick="imprimirPDF('CrÃ©dito')">CRÃ‰DITO<br>R$ 0,00</div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="formModal">
Â  Â  Â  Â  <div id="formContent">
Â  Â  Â  Â  Â  Â  <h2>Nova O.S</h2>
Â  Â  Â  Â  Â  Â  <input type="text" id="formOS" placeholder="NÃºmero da O.S" required>
Â  Â  Â  Â  Â  Â  <input type="date" id="formData" required>
Â  Â  Â  Â  Â  Â  <input type="text" id="formCliente" placeholder="Cliente" required>
Â  Â  Â  Â  Â  Â  <input type="text" id="formPlaca" placeholder="Placa" required>
Â  Â  Â  Â  Â  Â  <input type="number" id="formValor" placeholder="Valor (R$)" step="0.01" required>
Â  Â  Â  Â  Â  Â  <select id="formPagamento" required>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione pagamento</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="PIX">PIX</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Dinheiro">Dinheiro</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="CrÃ©dito">CrÃ©dito</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="DÃ©bito">DÃ©bito</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Em Aberto">Em Aberto</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Faturado">Faturado</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <select id="formUnidade" required>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione a Unidade</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Barueri">Barueri</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cotia">Cotia</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Embu">Embu</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <input type="text" id="formTecnico" placeholder="TÃ©cnico" required>
Â  Â  Â  Â  Â  Â  <button onclick="salvarForm()">Salvar O.S</button>
Â  Â  Â  Â  Â  Â  <button onclick="fecharForm()" style="margin-top:5px;background:#e74c3c;">Cancelar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â Â 
Â  Â  // =================================================================
Â  Â  // ðŸŸ¢ CONFIGURAÃ‡ÃƒO E INICIALIZAÃ‡ÃƒO DO FIREBASE (PASSO 1)
Â  Â  // ðŸ›‘ ATENÃ‡ÃƒO: SUBSTITUA O BLOCO ABAIXO PELO SEU firebaseConfig REAL
Â  Â  // =================================================================
Â  Â  const firebaseConfig = {
  apiKey: "AIzaSyCmhzcNKDWZzTB4DVU0_KMKDQGYbNNhBA",
  authDomain: "vditacografossistema.firebaseapp.com",
  projectId: "vditacografossistema",
  storageBucket: "vditacografossistema.appspot.com",
  messagingSenderId: "955187054075",
  appId: "1:955187054075:web:7b7878262490989349f75e",
  measurementId: "G-N12LKH5WJZ"
};

Â  Â  // Inicializa o Firebase
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();

Â  Â  // ReferÃªncias das coleÃ§Ãµes
Â  Â  const osCollection = db.collection('ordens_servico');
Â  Â  const usersCollection = db.collection('usuarios');

Â  Â  // Array local para armazenar os dados sincronizados
Â  Â  let osData = [];
Â  Â  let appUsers = [];
Â  Â Â 
Â  Â  // =================================================================
Â  Â  // ðŸŸ¢ FUNÃ‡Ã•ES DO FIREBASE (Substituindo localStorage)
Â  Â  // =================================================================
Â  Â Â 
Â  Â  // ONSNAPSHOT: Sincroniza dados em tempo real (Substitui a leitura de localStorage)
Â  Â  function startDataListener() {
Â  Â  Â  Â  // Ouve a coleÃ§Ã£o de O.S. e atualiza a variÃ¡vel local (osData) e a tabela
Â  Â  Â  Â  osCollection.orderBy('dataOS', 'desc').onSnapshot(snapshot => {
Â  Â  Â  Â  Â  Â  osData = snapshot.docs.map(doc => ({
Â  Â  Â  Â  Â  Â  Â  Â  id: doc.id, // O ID do documento Ã© necessÃ¡rio para ediÃ§Ã£o/exclusÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  ...doc.data()
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  getTecnicosUnicos();
Â  Â  Â  Â  Â  Â  atualizarTabelaTodas();
Â  Â  Â  Â  }, error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao sincronizar O.S.:", error);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Ouve a coleÃ§Ã£o de UsuÃ¡rios (necessÃ¡rio para a funÃ§Ã£o de login)
Â  Â  Â  Â  usersCollection.onSnapshot(snapshot => {
Â  Â  Â  Â  Â  Â  appUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  }, error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao sincronizar UsuÃ¡rios:", error);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // ðŸ”‘ FunÃ§Ãµes de Login (Adaptadas para Firestore)
Â  Â  async function setupInitialUsers() {
Â  Â  Â  Â  const defaultUser = { user: 'vdi', pass: '12345' };
Â  Â  Â  Â  const newUser = { user: 'meuacesso', pass: 'minhasenha123' };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Verifica se a coleÃ§Ã£o estÃ¡ vazia
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const snapshot = await usersCollection.get();
Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Configurando usuÃ¡rios iniciais no Firebase...");
Â  Â  Â  Â  Â  Â  Â  Â  await usersCollection.add(defaultUser);
Â  Â  Â  Â  Â  Â  Â  Â  await usersCollection.add(newUser);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â console.error("Erro ao tentar configurar usuÃ¡rios iniciais: Verifique as chaves e as Regras do Firebase.", e);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function loginAttempt() {
Â  Â  Â  Â  const user = document.getElementById('loginUser').value.trim();
Â  Â  Â  Â  const pass = document.getElementById('loginPass').value.trim();
Â  Â  Â  Â  const errorMsg = document.getElementById('loginError');

Â  Â  Â  Â  // Busca o usuÃ¡rio no Firestore (apenas se a lista local estiver carregada)
Â  Â  Â  Â  if (appUsers.length > 0) {
Â  Â  Â  Â  Â  Â  const userFound = appUsers.find(u => u.user === user && u.pass === pass);

Â  Â  Â  Â  Â  Â  if (userFound) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('isLoggedIn', 'true');Â 
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('currentUser', user); // Armazena o usuÃ¡rio logado
Â  Â  Â  Â  Â  Â  Â  Â  showApp();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  errorMsg.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Se appUsers estiver vazio, o Firebase pode ter falhado ao carregar os dados
Â  Â  Â  Â  Â  Â  alert("Aguarde a inicializaÃ§Ã£o do sistema ou verifique as chaves e Regras de SeguranÃ§a do Firebase. (F5 para tentar novamente)");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ðŸ”’ FunÃ§Ãµes de Gerenciamento de UsuÃ¡rios (Adaptadas para Firestore)
Â  Â  async function registerUser() {
Â  Â  Â  Â  const user = document.getElementById('newUser').value.trim();
Â  Â  Â  Â  const pass = document.getElementById('newPass').value.trim();

Â  Â  Â  Â  if (!user || !pass) {
Â  Â  Â  Â  Â  Â  alert('UsuÃ¡rio e Senha sÃ£o obrigatÃ³rios.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (appUsers.some(u => u.user === user)) {
Â  Â  Â  Â  Â  Â  alert('Este usuÃ¡rio jÃ¡ existe.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await usersCollection.add({ user, pass });
Â  Â  Â  Â  Â  Â  document.getElementById('newUser').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('newPass').value = '';
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert("Erro ao cadastrar usuÃ¡rio: " + e.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function deleteUser(id, name) {
Â  Â  Â  Â  if (appUsers.length <= 2 && name !== 'vdi' && name !== 'meuacesso') { // Deixando os 2 padrÃµes como "intocÃ¡veis"
Â  Â  Â  Â  Â  Â  Â alert("Por seguranÃ§a, vocÃª deve manter pelo menos dois usuÃ¡rios no sistema.");
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (name === sessionStorage.getItem('currentUser')) {
Â  Â  Â  Â  Â  Â  Â alert("NÃ£o Ã© possÃ­vel apagar o usuÃ¡rio que estÃ¡ logado no momento.");
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (confirm(`Deseja apagar o usuÃ¡rio ${name}?`)) {
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  await usersCollection.doc(id).delete();
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro ao apagar usuÃ¡rio: " + e.message);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function loadUserList() {
Â  Â  Â  Â  const list = document.getElementById('userList');
Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  appUsers.forEach(userObj => {
Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  const deleteButton = (userObj.user === sessionStorage.getItem('currentUser') || userObj.user === 'vdi' || userObj.user === 'meuacesso')Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? '<button disabled style="background:#ccc; cursor:not-allowed;">Sistema</button>'Â 
Â  Â  Â  Â  Â  Â  Â  Â  : `<button onclick="deleteUser('${userObj.id}', '${userObj.user}')">Apagar</button>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  li.innerHTML = `<span>${userObj.user}</span>${deleteButton}`;
Â  Â  Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // ðŸ“¦ FunÃ§Ãµes de O.S. (Adaptadas para Firestore)
Â  Â  async function salvarForm(id) {
Â  Â  Â  Â  const os=document.getElementById('formOS').value.trim();
Â  Â  Â  Â  const dataInput=document.getElementById('formData').value;
Â  Â  Â  Â  const cliente=document.getElementById('formCliente').value.trim();
Â  Â  Â  Â  const placa=document.getElementById('formPlaca').value.trim();
Â  Â  Â  Â  const valor=parseFloat(document.getElementById('formValor').value).toFixed(2);
Â  Â  Â  Â  const pagamento=document.getElementById('formPagamento').value;
Â  Â  Â  Â  const tecnico=document.getElementById('formTecnico').value.trim();
Â  Â  Â  Â  const unidade=document.getElementById('formUnidade').value;

Â  Â  Â  Â  if(!os || !dataInput || !cliente || !placa || !valor || !pagamento || !tecnico || !unidade){
Â  Â  Â  Â  Â  Â  Â  alert("Preencha todos os campos!");
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const dataObj = {
Â  Â  Â  Â  Â  Â  os,
Â  Â  Â  Â  Â  Â  data: formatDate(dataInput), // Data formatada para exibiÃ§Ã£o
Â  Â  Â  Â  Â  Â  dataOS: dataInput,Â  Â  Â  Â  Â  Â // Data em formato ISO para ordenaÃ§Ã£o e filtro
Â  Â  Â  Â  Â  Â  cliente,
Â  Â  Â  Â  Â  Â  placa,
Â  Â  Â  Â  Â  Â  valor,
Â  Â  Â  Â  Â  Â  pagamento,
Â  Â  Â  Â  Â  Â  tecnico,
Â  Â  Â  Â  Â  Â  unidade
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (id) {
Â  Â  Â  Â  Â  Â  Â  Â  // Se existe ID, atualiza o documento (ediÃ§Ã£o)
Â  Â  Â  Â  Â  Â  Â  Â  await osCollection.doc(id).update(dataObj);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o existe ID, cria um novo documento (nova O.S.)
Â  Â  Â  Â  Â  Â  Â  Â  await osCollection.add(dataObj);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  fecharForm();

Â  Â  Â  Â  Â  Â  document.getElementById('formContent').querySelectorAll('input, select').forEach(f => {
Â  Â  Â  Â  Â  Â  Â  Â  if (f.type !== 'submit' && f.type !== 'button') { f.value = ''; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('formModal').dataset.editId = ''; // Limpa o ID de ediÃ§Ã£o
Â  Â  Â  Â  Â  Â  document.getElementById('formModal').querySelector('button[onclick*="salvarForm"]').textContent = 'Salvar O.S';
Â  Â  Â  Â  Â  Â  document.getElementById('formModal').querySelector('h2').textContent = 'Nova O.S';

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert(`Erro ao salvar O.S.: ${e.message}`);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function apagarOS(id, osNum) {
Â  Â  Â  Â  Â  if(confirm(`Deseja apagar a O.S. ${osNum}?`)){
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await osCollection.doc(id).delete();
Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Erro ao apagar O.S.: ${e.message}`);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  async function limparDados() {
Â  Â  Â  Â  if (!confirm("Tem certeza que deseja limpar TODOS os dados? Esta aÃ§Ã£o Ã© irreversÃ­vel e afetarÃ¡ TODOS os usuÃ¡rios conectados.")) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const snapshot = await osCollection.get();
Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("NÃ£o hÃ¡ dados para limpar.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  Â  Â  snapshot.docs.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  batch.delete(doc.ref);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  alert("Todos os dados de O.S. foram limpos com sucesso!");
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert(`Erro ao limpar dados: ${e.message}`);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // =================================================================
Â  Â  // FUNÃ‡Ã•ES RESTANTES (GeraÃ§Ã£o de Excel/PDF, Filtros e Interface)
Â  Â  // =================================================================
Â  Â Â 
Â  Â  function formatDate(iso){
Â  Â  Â  Â  const parts=iso.split('-');
Â  Â  Â  Â  return `${parts[2]}/${parts[1]}/${parts[0]}`;
Â  Â  }
Â  Â Â 
Â  Â  function getTecnicosUnicos() {
Â  Â  Â  Â  const tecnicos = [...new Set(osData.map(item => item.tecnico).filter(t => t && t.trim() !== ''))].sort();
Â  Â  Â  Â  const select = document.getElementById('tecnicoFiltro');
Â  Â  Â  Â  const valorAtual = select.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  select.innerHTML = '<option value="">Todos TÃ©cnicos</option>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  tecnicos.forEach(tecnico => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = tecnico;
Â  Â  Â  Â  Â  Â  option.textContent = tecnico;
Â  Â  Â  Â  Â  Â  select.appendChild(option);
Â  Â  Â  Â  });
Â  Â  Â  Â  if (tecnicos.includes(valorAtual)) {
Â  Â  Â  Â  Â  Â  Â  Â select.value = valorAtual;
Â  Â  Â  Â  } else if (valorAtual && !tecnicos.includes(valorAtual)) {
Â  Â  Â  Â  Â  Â  Â  select.value = '';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function abrirForm(id) {
Â  Â  Â  Â  const formModal = document.getElementById('formModal');
Â  Â  Â  Â  const h2 = formModal.querySelector('h2');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Configura para Nova O.S.
Â  Â  Â  Â  h2.textContent = 'Nova O.S';
Â  Â  Â  Â  formModal.dataset.editId = '';
Â  Â  Â  Â  document.getElementById('formOS').value = '';
Â  Â  Â  Â  document.getElementById('formData').value = '';
Â  Â  Â  Â  document.getElementById('formCliente').value = '';
Â  Â  Â  Â  document.getElementById('formPlaca').value = '';
Â  Â  Â  Â  document.getElementById('formValor').value = '';
Â  Â  Â  Â  document.getElementById('formPagamento').value = '';
Â  Â  Â  Â  document.getElementById('formTecnico').value = '';

Â  Â  Â  Â  const unidadeSelecionada = document.getElementById('unidade').value;
Â  Â  Â  Â  if (unidadeSelecionada) {
Â  Â  Â  Â  Â  Â  Â  document.getElementById('formUnidade').value = unidadeSelecionada;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  document.getElementById('formUnidade').value = '';Â 
Â  Â  Â  Â  Â }

Â  Â  Â  Â  // Configura para EdiÃ§Ã£o, se um ID for passado
Â  Â  Â  Â  if (id) {
Â  Â  Â  Â  Â  Â  const item = osData.find(d => d.id === id);
Â  Â  Â  Â  Â  Â  if (item) {
Â  Â  Â  Â  Â  Â  Â  Â  h2.textContent = 'Editar O.S.';
Â  Â  Â  Â  Â  Â  Â  Â  formModal.dataset.editId = id;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formOS').value = item.os;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formData').value = item.dataOS; // Usa a data ISO
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formCliente').value = item.cliente;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formPlaca').value = item.placa;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formValor').value = parseFloat(item.valor);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formPagamento').value = item.pagamento;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formUnidade').value = item.unidade;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formTecnico').value = item.tecnico;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  formModal.style.display = 'flex';
Â  Â  Â  Â  formModal.querySelector('button[onclick*="salvarForm"]').setAttribute('onclick', `salvarForm('${id || ''}')`);
Â  Â  }

Â  Â  function fecharForm(){
Â  Â  Â  Â  document.getElementById('formModal').style.display='none';
Â  Â  }

Â  Â  function editarOS(id){
Â  Â  Â  Â  abrirForm(id); // Chama abrirForm passando o ID para ediÃ§Ã£o
Â  Â  }
Â  Â Â 
Â  Â  function atualizarTabelaTodas(){
Â  Â  Â  Â  const unidade = document.getElementById('unidade').value;
Â  Â  Â  Â  const dataInicio = document.getElementById('dataInicio').value;
Â  Â  Â  Â  const dataFim = document.getElementById('dataFim').value;
Â  Â  Â  Â  const termoBusca = document.getElementById('busca').value.toLowerCase();
Â  Â  Â  Â  const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;Â 

Â  Â  Â  Â  const tbody = document.querySelector("#tabelaTodas tbody");
Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  let totalF=0, totalAberto=0, totalPix=0, totalDin=0, totalDeb=0, totalCred=0;

Â  Â  Â  Â  const dadosFiltrados = osData.filter(item => {
Â  Â  Â  Â  Â  Â  const itemDate = item.dataOS;
Â  Â  Â  Â  Â  Â  const itemValor = parseFloat(item.valor) || 0;
Â  Â  Â  Â  Â  Â  const itemPagamento = item.pagamento ? item.pagamento.toLowerCase().trim() : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(unidade && item.unidade !== unidade) return false;
Â  Â  Â  Â  Â  Â  if(tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(dataInicio && itemDate < dataInicio) return false;
Â  Â  Â  Â  Â  Â  if(dataFim && itemDate > dataFim) return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if ((item.cliente || '').toUpperCase().includes('CANCELADA')) return false;

Â  Â  Â  Â  Â  Â  if (termoBusca && !(item.cliente.toLowerCase().includes(termoBusca) || item.placa.toLowerCase().includes(termoBusca) || item.os.toLowerCase().includes(termoBusca))) return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'faturado') totalF += itemValor;
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'em aberto') totalAberto += itemValor;
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'pix') totalPix += itemValor;
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'dinheiro') totalDin += itemValor;
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'dÃ©bito') totalDeb += itemValor;
Â  Â  Â  Â  Â  Â  if(itemPagamento === 'crÃ©dito') totalCred += itemValor;
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  });

Â  Â  Â  Â  dadosFiltrados.forEach((item)=>{
Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  tr.innerHTML = `<td>${item.os}</td><td>${item.data}</td><td>${item.cliente}</td><td>${item.placa}</td><td>R$ ${parseFloat(item.valor).toFixed(2)}</td><td>${item.pagamento}</td><td>${item.tecnico}</td><td>${item.unidade}</td><td><button class="edit" onclick="editarOS('${item.id}')">Editar</button> <button class="delete" onclick="apagarOS('${item.id}', '${item.os}')">Apagar</button></td>`;
Â  Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('totalFaturadas').innerHTML=`FATURADAS<br>R$ ${totalF.toFixed(2)}`;
Â  Â  Â  Â  document.getElementById('totalAberto').innerHTML=`EM ABERTO<br>R$ ${totalAberto.toFixed(2)}`;
Â  Â  Â  Â  document.getElementById('totalPix').innerHTML=`PIX<br>R$ ${totalPix.toFixed(2)}`;
Â  Â  Â  Â  document.getElementById('totalDinheiro').innerHTML=`DINHEIRO<br>R$ ${totalDin.toFixed(2)}`;
Â  Â  Â  Â  document.getElementById('totalDebito').innerHTML=`DÃ‰BITO<br>R$ ${totalDeb.toFixed(2)}`;
Â  Â  Â  Â  document.getElementById('totalCredito').innerHTML=`CRÃ‰DITO<br>R$ ${totalCred.toFixed(2)}`;
Â  Â  }

Â  Â  function filtrar(){ atualizarTabelaTodas(); }
Â  Â  function buscar(){ atualizarTabelaTodas(); }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  function limparFiltros(){
Â  Â  Â  Â  Â  document.getElementById('unidade').value='';
Â  Â  Â  Â  Â  document.getElementById('tecnicoFiltro').value='';
Â  Â  Â  Â  Â document.getElementById('dataInicio').value='';
Â  Â  Â  Â  Â  document.getElementById('dataFim').value='';
Â  Â  Â  Â  Â  document.getElementById('busca').value='';
Â  Â  Â  Â  Â  atualizarTabelaTodas();
Â  Â  }
Â  Â Â 
Â  Â  function showLogin() {
Â  Â  Â  Â  document.getElementById('loginModal').style.display = 'flex';
Â  Â  Â  Â  document.getElementById('appContent').style.display = 'none';
Â  Â  Â  Â  document.getElementById('userModal').style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('loginUser').value = '';
Â  Â  Â  Â  document.getElementById('loginPass').value = '';
Â  Â  Â  Â  document.getElementById('loginError').style.display = 'none';
Â  Â  }

Â  Â  function showApp() {
Â  Â  Â  Â  document.getElementById('loginModal').style.display = 'none';
Â  Â  Â  Â  document.getElementById('userModal').style.display = 'none';
Â  Â  Â  Â  document.getElementById('appContent').style.display = 'block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  startDataListener();Â 
Â  Â  }

Â  Â  function checkLogin() {
Â  Â  Â  Â  if (sessionStorage.getItem('isLoggedIn') === 'true') {
Â  Â  Â  Â  Â  Â  showApp();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showLogin();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function openUserModal() {
Â  Â  Â  Â  if (sessionStorage.getItem('isLoggedIn') !== 'true') return;Â 
Â  Â  Â  Â  loadUserList();
Â  Â  Â  Â  document.getElementById('userModal').style.display = 'flex';
Â  Â  }

Â  Â  function closeUserModal() {
Â  Â  Â  Â  document.getElementById('userModal').style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  // FunÃ§Ãµes de PDF e Excel (MANTIDAS)
Â  Â  function imprimirPDF(filtroPagamento = null) {
Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  const doc = new jsPDF('p', 'pt', 'a4');
Â  Â  Â  Â  const finalY = doc.previousAutoTable.finalY || 10;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let dadosPDF = osData;
Â  Â  Â  Â  let titulo = "RelatÃ³rio Completo de Ordens de ServiÃ§o";

Â  Â  Â  Â  if (filtroPagamento) {
Â  Â  Â  Â  Â  Â  dadosPDF = osData.filter(item => item.pagamento === filtroPagamento);
Â  Â  Â  Â  Â  Â  titulo = `RelatÃ³rio de O.S. (${filtroPagamento})`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const headers = [['O.S', 'DATA', 'CLIENTE', 'PLACA', 'VALOR', 'PAGAMENTO', 'TÃ‰CNICO', 'UNIDADE']];
Â  Â  Â  Â  const body = dadosPDF.map(item => [
Â  Â  Â  Â  Â  Â  item.os,
Â  Â  Â  Â  Â  Â  item.data,
Â  Â  Â  Â  Â  Â  item.cliente,
Â  Â  Â  Â  Â  Â  item.placa,
Â  Â  Â  Â  Â  Â  `R$ ${parseFloat(item.valor).toFixed(2)}`,
Â  Â  Â  Â  Â  Â  item.pagamento,
Â  Â  Â  Â  Â  Â  item.tecnico,
Â  Â  Â  Â  Â  Â  item.unidade
Â  Â  Â  Â  ]);

Â  Â  Â  Â  doc.text(titulo, 40, finalY + 30);
Â  Â  Â  Â  doc.autoTable({
Â  Â  Â  Â  Â  Â  startY: finalY + 40,
Â  Â  Â  Â  Â  Â  head: headers,
Â  Â  Â  Â  Â  Â  body: body,
Â  Â  Â  Â  Â  Â  theme: 'striped',
Â  Â  Â  Â  Â  Â  headStyles: { fillColor: [74, 144, 226] },
Â  Â  Â  Â  Â  Â  styles: { fontSize: 8, cellPadding: 5 }
Â  Â  Â  Â  });

Â  Â  Â  Â  doc.save(titulo.replace(/ /g, '_') + '.pdf');
Â  Â  }
Â  Â Â 
Â  Â  function exportExcel() {
Â  Â  Â  Â  const dadosExcel = osData.map(item => ({
Â  Â  Â  Â  Â  Â  OS: item.os,
Â  Â  Â  Â  Â  Â  DATA: item.data,
Â  Â  Â  Â  Â  Â  CLIENTE: item.cliente,
Â  Â  Â  Â  Â  Â  PLACA: item.placa,
Â  Â  Â  Â  Â  Â  VALOR: parseFloat(item.valor),
Â  Â  Â  Â  Â  Â  PAGAMENTO: item.pagamento,
Â  Â  Â  Â  Â  Â  TECNICO: item.tecnico,
Â  Â  Â  Â  Â  Â  UNIDADE: item.unidade
Â  Â  Â  Â  }));

Â  Â  Â  Â  const ws = XLSX.utils.json_to_sheet(dadosExcel);
Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "Ordens de ServiÃ§o");
Â  Â  Â  Â  XLSX.writeFile(wb, "VDI_OS_Export_" + new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') + ".xlsx");
Â  Â  }

Â  Â  function importExcel() {
Â  Â  Â  Â  document.getElementById('inputExcel').click();
Â  Â  }

Â  Â  function lerExcel(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = async function(e) {
Â  Â  Â  Â  Â  Â  const data = new Uint8Array(e.target.result);
Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(data, { type: 'array' });
Â  Â  Â  Â  Â  Â  const sheetName = workbook.SheetNames[0];
Â  Â  Â  Â  Â  Â  const worksheet = workbook.Sheets[sheetName];
Â  Â  Â  Â  Â  Â  const json = XLSX.utils.sheet_to_json(worksheet);

Â  Â  Â  Â  Â  Â  if (!confirm(`Deseja importar ${json.length} registros? O.S. existentes com o mesmo nÃºmero serÃ£o ignoradas.`)) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Lendo o OS atual para evitar duplicatas ao importar
Â  Â  Â  Â  Â  Â  const osExistentes = new Set(osData.map(item => item.os));
Â  Â  Â  Â  Â  Â  let importadas = 0;

Â  Â  Â  Â  Â  Â  for (const row of json) {
Â  Â  Â  Â  Â  Â  Â  Â  const osNum = String(row.OS).trim();

Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se a OS jÃ¡ existe
Â  Â  Â  Â  Â  Â  Â  Â  if (osExistentes.has(osNum)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Normaliza os campos
Â  Â  Â  Â  Â  Â  Â  Â  const dataOS = row.DATA ? new Date(Math.round((row.DATA - 25569) * 86400 * 1000)).toISOString().split('T')[0] : '';
Â  Â  Â  Â  Â  Â  Â  Â  const dataObj = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  os: osNum,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: formatDate(dataOS),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataOS: dataOS,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cliente: String(row.CLIENTE || ''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placa: String(row.PLACA || ''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor: (parseFloat(row.VALOR) || 0).toFixed(2),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pagamento: String(row.PAGAMENTO || ''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tecnico: String(row.TECNICO || ''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unidade: String(row.UNIDADE || '')
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Salva no Firestore
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await osCollection.add(dataObj);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importadas++;
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao importar item:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } // <-- FIM do loop for

Â  Â  Â  Â  Â  Â  alert(`ImportaÃ§Ã£o concluÃ­da. ${importadas} novos registros importados.`);
Â  Â  Â  Â  Â  Â  document.getElementById('inputExcel').value = ''; // Limpa o input
Â  Â  Â  Â  }; // <-- FIM de reader.onload

Â  Â  Â  Â  reader.readAsArrayBuffer(file);
Â  Â  } // <-- FIM de lerExcel

Â  Â  // =================================================================
Â  Â  // ðŸŸ¢ CHAMADA FINAL PARA INICIAR O SISTEMA
Â  Â  // =================================================================
Â  Â  setupInitialUsers(); 
Â  Â  checkLogin();
</script>
</body>
</html>

