<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VDI Tac√≥grafos ‚Äî Frente de Caixa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* Estilos CSS (inalterados) */
        body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f4f6f9; }
        header { background: linear-gradient(90deg,#4a90e2,#9013fe); color:white; padding:20px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
        .container { padding:20px; max-width:1200px; margin:auto; }
        .buttons, .filters, .search { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
        button { background:#4a90e2; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; display:flex; align-items:center; gap:5px; }
        button:hover { background:#357ABD; }
        input, select { padding:10px 12px; border-radius:6px; border:1px solid #ccc; box-sizing: border-box;}
        table { width:100%; border-collapse:collapse; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding:8px 10px; text-align:left; font-size:13px; }
        th { background:#4a90e2; color:white; }
        tr:nth-child(even) { background:#f9f9f9; }
        tr:hover { background:#dce6f1; }
        .summary { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
        .card { flex:1 1 150px; padding:15px; border-radius:10px; color:white; font-weight:600; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; transition:0.2s; }
        .card:hover { opacity:0.9; transform:scale(1.02); }
        .faturadas { background: linear-gradient(45deg,#2d9cdb,#1b7ecf); }
        .emaberto { background: linear-gradient(45deg,#e94e77,#d43d5c); }
        .pix { background: linear-gradient(45deg,#27ae60,#1e8449); }
        .dinheiro { background: linear-gradient(45deg,#f1c40f,#d4ac0d); }
        .debito { background: linear-gradient(45deg,#f39c12,#d68910); }
        .credito { background: linear-gradient(45deg,#9b59b6,#8e44ad); }
        .maodeobra { background: linear-gradient(45deg, #7b1fa2, #4a148c); } 
         .edit, .delete { border:none; padding:5px 10px; border-radius:6px; color:white; cursor:pointer; margin-right:5px; font-size:12px; }
        .edit { background:#27ae60; }
        .delete { background:#e74c3c; }
        /* Estilo para Modais e Login */
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:20px; border-radius:10px; width:95%; max-width:480px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { color:#4a90e2; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin-bottom:12px; width:100%; box-sizing:border-box; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index:2000; font-size: 18px; font-weight: 600; color: #4a90e2; }
        @media(max-width:900px){ table th, table td { font-size:12px; } .card { font-size:13px; } }
        #headerLogo { max-height: 75px; width: auto; display: block; margin: 0 auto 5px auto; }
        #headerTitle { margin: 0; font-size: 20px; font-weight: 600; text-align:center; }
    </style>
</head>
<body>
<div id="loadingOverlay" style="display:none;">Conectando √† Nuvem...</div>

<div id="loginModal" class="modal" style="display: flex;">
    <div class="modal-content">
        <h2>Acesso VDI - Frente de Caixa</h2>
        <p>Por favor, utilize suas credenciais de usu√°rio.</p>
        <input type="email" id="loginEmail" placeholder="Email do Usu√°rio">
        <input type="password" id="loginPassword" placeholder="Senha do Usu√°rio">
        <button onclick="handleLogin()">Entrar</button>
    </div>
</div>

<div id="appContent" style="display:none;">
    <header>
        <img src="logo.png" alt="Logo VDI Tac√≥grafos" id="headerLogo">
        <h1 id="headerTitle">VDI TAC√ìGRAFOS ‚Äî Frente de Caixa (Barueri ¬∑ Cotia ¬∑ Embu)</h1>
        <button onclick="handleLogout()" style="position: absolute; top: 20px; right: 20px; background: #c0392b;">Sair</button>
    </header>
    <div class="container">
        <div class="buttons">
            <button onclick="abrirForm()">+ Nova O.S</button>
            <button onclick="exportExcel()">Exportar Excel</button>
            <button onclick="importExcel()">Importar Excel</button>
            <button onclick="imprimirPDF()">Imprimir / Salvar PDF</button>
            <button onclick="limparDados()">Limpar dados</button>
        </div>
        <input type="file" id="inputExcel" accept=".xlsx,.csv" style="display:none" onchange="lerExcel(event)" multiple>
        <div class="filters">
            <select id="unidade" onchange="atualizarTabelaTodas()">
                <option value="">Todas Unidades</option>
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <select id="tecnicoFiltro" onchange="atualizarTabelaTodas()">
                <option value="">Todos T√©cnicos</option>
            </select>
            <input type="date" id="dataInicio">
            <input type="date" id="dataFim">
            <button onclick="filtrar()">Filtrar</button>
            <button onclick="limparFiltros()">Limpar filtros</button>
        </div>
        <div class="search">
            <input type="text" id="busca" placeholder="Buscar cliente, placa ou O.S">
            <button onclick="buscar()">Buscar</button>
        </div>
        <h3>Todas as O.S</h3>
        <table id="tabelaTodas">
            <thead>
                <tr>
                    <th>O.S</th>
                    <th>DATA</th>
                    <th>CLIENTE</th>
                    <th>PLACA</th>
                    <th>VALOR OS</th>
                    <th>VALOR MO</th>
                    <th>VALOR (TOTAL)</th>
                    <th>PAGAMENTO</th>
                    <th>TECNICO</th>
                    <th>OS TECNICO</th>
                    <th>UNIDADE</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
                <h3>Resumo ‚Äî Controle de Caixa Di√°rio</h3>
        <div class="summary">
            <div class="card maodeobra" id="totalMO" onclick="imprimirPDF('M√£oDeObra')">M√ÉO DE OBRA<br>R$ 0,00</div>
             <div class="card faturadas" id="totalFaturadas" onclick="imprimirPDF('Faturado')">FATURADAS<br>R$ 0,00</div>
            <div class="card emaberto" id="totalAberto" onclick="imprimirPDF('Em Aberto')">EM ABERTO<br>R$ 0,00</div>
            <div class="card pix" id="totalPix" onclick="imprimirPDF('PIX')">PIX<br>R$ 0,00</div>
            <div class="card dinheiro" id="totalDinheiro" onclick="imprimirPDF('Dinheiro')">DINHEIRO<br>R$ 0,00</div>
            <div class="card debito" id="totalDebito" onclick="imprimirPDF('D√©bito')">D√âBITO<br>R$ 0,00</div>
            <div class="card credito" id="totalCredito" onclick="imprimirPDF('Cr√©dito')">CR√âDITO<br>R$ 0,00</div>
        </div>
    </div>
    <div id="formModal" class="modal">
        <div class="modal-content">
            <h2>Nova O.S</h2>
            <input type="text" id="formOS" placeholder="N√∫mero da O.S">
            <input type="date" id="formData">
            <input type="text" id="formCliente" placeholder="Cliente">
            <input type="text" id="formPlaca" placeholder="Placa">
            <input type="number" id="formValorOS" placeholder="Valor OS (R$)" step="0.01">
            <input type="number" id="formValorMO" placeholder="Valor MO (R$)" step="0.01">
             <select id="formPagamento">
                <option value="">Selecione pagamento</option>
                <option value="PIX">PIX</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cr√©dito">Cr√©dito</option>
                <option value="D√©bito">D√©bito</option>
                <option value="Em Aberto">Em Aberto</option>
                <option value="Faturado">Faturado</option>
            </select>
            <select id="formUnidade">
                <option value="">Selecione a Unidade</option>
                <option value="Barueri">Barueri</option>
                <option value="Cotia">Cotia</option>
                <option value="Embu">Embu</option>
            </select>
            <input type="text" id="formTecnico" placeholder="T√©cnico">
            <input type="text" id="formOsTecnico" placeholder="OS T√©cnico (opcional)">
            <button id="btnSalvar" onclick="salvarForm()">Salvar O.S</button>
            <button onclick="fecharForm()" style="margin-top:8px;background:#e74c3c;">Cancelar</button>
        </div>
    </div>
</div>

<script>
/* =============================================
   Configura√ß√µes Firebase (Vers√£o 8)
   ============================================= */
// üõë üõë üõë IMPORTANTE: VERIFIQUE SE ESTA CHAVE API √â REAL E V√ÅLIDA PARA SEU PROJETO! üõë üõë üõë
const firebaseConfig = {
  apiKey: "AIzaSyC5up-MQFQNeH1ftI8KTMoXI5pY2D2jpgM", 
   authDomain: "vditacografosfrentecaixa.firebaseapp.com",
  databaseURL: "https://vditacografosfrentecaixa-default-rtdb.firebaseio.com",
  projectId: "vditacografosfrentecaixa",
  storageBucket: "vditacografosfrentecaixa.firebasestorage.app", 
   messagingSenderId: "1008625665373",
  appId: "1:1008625665373:web:1f1870898ecb04b4b854b4",
  measurementId: "G-9SYYV1VLNY"
};

// Inicializa√ß√£o dos servi√ßos (Vers√£o 8)
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const auth = firebase.auth(); // Inicializa o Auth
const osCollection = db.collection('ordens_servico');
let osData = [];
window.firestoreListenerStarted = false; // Flag para garantir que o listener s√≥ inicie uma vez

/* cores para pdf (seu original) */
const paymentColors = {
    'Faturado': [173, 216, 230],
    'Em Aberto': [255, 192, 203],
    'PIX': [175, 223, 175],
    'Dinheiro': [255, 239, 173],
    'D√©bito': [253, 222, 173],
    'Cr√©dito': [210, 180, 222]
};

/* -------------------------   Helpers (seu original)   ------------------------- */
function formatDate(iso){
    if(!iso) return '01/01/2000';
    const parts = iso.split('-');
    if(parts.length !== 3) return iso;
    return `${parts[2]}/${parts[1]}/${parts[0]}`
}
function normalizeHeader(s){
    return String(s || '').toUpperCase().replace(/\s+/g, ' ').trim();
}
function parseDateCell(cell){
    if(!cell && cell !== 0) return null;
    if (cell instanceof Date) {
        return cell.toISOString().split('T')[0];
    }
    const txt = String(cell).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(txt)) return txt.split('T')[0];
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(txt)){
        const [d,m,y] = txt.split('/');
        return `${y}-${m}-${d}`;
    }
    const dt = new Date(txt);
    if(!isNaN(dt)) return dt.toISOString().split('T')[0];
    return null;
}
function parseMoneyCell(cell){
    if(cell === null || cell === undefined || cell === '') return 0;
    let txt = String(cell).replace(/\s/g,'').replace(/\u00A0/g,'');
    if(/^\d{1,3}(\.\d{3})+,\d{2}$/.test(txt) || (txt.indexOf(',')>-1 && txt.indexOf('.')>-1)){
        txt = txt.replace(/\./g,'').replace(',', '.');
    } else {
        txt = txt.replace(',', '.');
    }
    const val = parseFloat(txt);
    return isNaN(val) ? 0 : val;
}

/* -------------------------   Fun√ß√µes Firebase AUTH (Novo)   ------------------------- */

async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
        alert('Preencha email e senha.');
        return;
    }

    try {
        document.getElementById('loadingOverlay').style.display = 'flex';
        await auth.signInWithEmailAndPassword(email, password);
        // onAuthStateChanged ir√° lidar com o restante
    } catch (error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert(`Erro de Login: Verifique suas credenciais. (${error.message})`);
    }
}

function handleLogout() {
    if (confirm('Deseja sair do sistema?')) {
        auth.signOut();
    }
}

function checkAuthState() {
    auth.onAuthStateChanged(user => {
        if (user) {
            // USU√ÅRIO LOGADO: Mostra o app e carrega os dados
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
                        if (!window.firestoreListenerStarted) {
                setupFirestoreListener();
                window.firestoreListenerStarted = true;
            } else {
                 document.getElementById('loadingOverlay').style.display = 'none';
            }
        } else {
            // USU√ÅRIO DESLOGADO: Mostra a tela de login
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    });
}

/* -------------------------   Firestore listener (Adaptado para rodar ap√≥s login)   ------------------------- */
function setupFirestoreListener(){
    document.getElementById('loadingOverlay').style.display = 'flex';
    osCollection.onSnapshot(snapshot => {
        const changes = snapshot.docChanges();
        changes.forEach(change => {
            const docData = { ...change.doc.data(), id: change.doc.id };
            if (change.type === "added" || change.type === "modified") {
                const idx = osData.findIndex(i => i.id === docData.id);
                if(idx > -1) osData[idx] = docData;
                else osData.push(docData);
            }
            if (change.type === "removed") {
                osData = osData.filter(i => i.id !== docData.id);
            }
        });
        osData.sort((a,b)=>{
            const pa = a.data ? a.data.split('/') : ['01','01','2000'];
            const pb = b.data ? b.data.split('/') : ['01','01','2000'];
            const da = new Date(pa[2], pa[1]-1, pa[0]);
            const db = new Date(pb[2], pb[1]-1, pb[0]);
            return db - da;
        });
        getTecnicosUnicos(); 
         atualizarTabelaTodas();
        document.getElementById('loadingOverlay').style.display = 'none';
    }, err => {
        console.error('Erro Firestore', err);
        document.getElementById('loadingOverlay').style.display = 'none'; 
         alert('Erro ao carregar dados do Firebase. Verifique sua chave API e Regras de Seguran√ßa.');
    });
}

function getTecnicosUnicos(){
    const select = document.getElementById('tecnicoFiltro');
    const current = select.value;
    const tecnicos = [...new Set(osData.map(i=> (i.tecnico||'').toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b, 'pt-BR'));
    select.innerHTML = '<option value="">Todos T√©cnicos</option>';
    tecnicos.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
    });
    if(current && Array.from(select.options).some(o=>o.value===current)) select.value = current;
}

/* Start listener now */
checkAuthState(); // Substitu√≠do a chamada direta ao listener pela verifica√ß√£o de Auth

/* -------------------------   Form open/close & save (corrigido para MO)   ------------------------- */
function abrirForm(item=null){
    const modal = document.getElementById('formModal');
    const btnSalvar = document.getElementById('btnSalvar');

    // clear fields
    document.getElementById('formOS').value = item ? (item.os || '') : '';
    if(item && item.data){
        const parts = item.data.split('/');
        document.getElementById('formData').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
    } else {
        document.getElementById('formData').value = '';
    }
    document.getElementById('formCliente').value = item ? (item.cliente || '') : '';
    document.getElementById('formPlaca').value = item ? (item.placa || '') : '';
    document.getElementById('formValorOS').value = item ? (parseFloat(item.valor_os || 0).toFixed(2)) : '';
    document.getElementById('formValorMO').value = item ? (parseFloat(item.valor_mo || 0).toFixed(2)) : ''; 
     document.getElementById('formPagamento').value = item ? (item.pagamento || '') : '';
    document.getElementById('formUnidade').value = item ? (item.unidade || '') : '';
    document.getElementById('formTecnico').value = item ? (item.tecnico || '') : '';
    document.getElementById('formOsTecnico').value = item ? (item.os_tecnico || '') : '';

    if(item && item.id) {
        modal.dataset.editId = item.id;
        btnSalvar.textContent = 'Atualizar O.S';
        document.getElementById('formOS').disabled = true; 
     } else {
        delete modal.dataset.editId;
        btnSalvar.textContent = 'Salvar O.S';
        document.getElementById('formOS').disabled = false;
    }
    modal.style.display = 'flex';
}

function fecharForm(){
    document.getElementById('formModal').style.display='none';
    delete document.getElementById('formModal').dataset.editId;
}

async function salvarForm(){
    const modal = document.getElementById('formModal');
    const editId = modal.dataset.editId || null; 

    const os = document.getElementById('formOS').value.trim();
    const dataInput = document.getElementById('formData').value;
    const cliente = document.getElementById('formCliente').value.trim();
    const placa = document.getElementById('formPlaca').value.trim();
    const valorOS = parseFloat(document.getElementById('formValorOS').value || 0);
    const valorMO = parseFloat(document.getElementById('formValorMO').value || 0); 
     const pagamento = document.getElementById('formPagamento').value;
    const tecnico = document.getElementById('formTecnico').value.trim();
    const unidade = document.getElementById('formUnidade').value;
    const osTecnico = document.getElementById('formOsTecnico').value.trim();

    if(!os || !dataInput || !cliente || !placa){
        alert('Preencha os campos m√≠nimos: O.S, DATA, CLIENTE, PLACA');
        return;
    }

    const dataFormatada = formatDate(dataInput);

    const registro = {
        os,
        data: dataFormatada,
        cliente,
        placa,
        valor_os: valorOS.toFixed(2),
        valor_mo: valorMO.toFixed(2), 
         valor: (valorOS + valorMO).toFixed(2), // VALOR TOTAL
        pagamento,
        tecnico,
        os_tecnico: osTecnico,
        unidade,
    };

    try {
        if(editId){
            delete registro.timestamp;
            await osCollection.doc(editId).update(registro);
            alert('O.S. atualizada com sucesso!');
        } else {
            registro.timestamp = firebase.firestore.FieldValue.serverTimestamp();
            await osCollection.add(registro);
            alert('O.S. salva com sucesso!');
        }
        fecharForm();
    } catch(e){
        console.error(e);
        alert('Erro ao salvar na nuvem');
    }
}

/* helper to open modal in edit mode (seu original) */
function abrirFormForEdit(id){
    const item = osData.find(d=>d.id===id);
    if(!item) { alert('Registro n√£o encontrado'); return; }
    abrirForm(item);
    document.getElementById('formModal').dataset.editId = id;
}

/* apagar (seu original) */
async function apagarOS(id){
    if(!confirm('Deseja apagar esta O.S? Esta a√ß√£o √© irrevers√≠vel.')) return;
    try {
        await osCollection.doc(id).delete();
        alert('O.S. apagada');
    } catch(e){
        console.error(e);
        alert('Erro ao apagar');
    }
}


/* -------------------------   Fun√ß√£o Central de Filtro (NOVA)   ------------------------- */
/**
 * Retorna o array de dados filtrados baseado nos filtros de tela E no filtro de pagamento
 * @param {string} filtroPagamento - 'Faturado', 'PIX', 'M√£oDeObra', etc. (null para todos)
 * @param {boolean} aplicarFiltrosDeTela - Se deve aplicar filtros de data, unidade e t√©cnico.
 * @returns {Array} Array de objetos de O.S. filtrados.
 */
function getDadosFiltrados(filtroPagamento = null, aplicarFiltrosDeTela = true) {
    // 1. Capturar os filtros da tela
    const unidade = document.getElementById('unidade').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const tecnicoFiltro = document.getElementById('tecnicoFiltro').value;
    const termoBusca = document.getElementById('busca').value.toLowerCase();
    
    // 2. Aplicar o filtro
    const dadosFiltrados = osData.filter(item => {
        const itemDate = item.data ? item.data.split('/').reverse().join('-') : '2000-01-01';
        const itemPagamento = item.pagamento ? item.pagamento.toString().toLowerCase().trim() : '';

        // Filtros de Tela (Unidade, Data, T√©cnico)
        if (aplicarFiltrosDeTela) {
            if (unidade && item.unidade !== unidade) return false;
            if (tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
            if (dataInicio && itemDate < dataInicio) return false;
            if (dataFim && itemDate > dataFim) return false;
            
            // Filtro de busca (APENAS na tabela, n√£o nos totais/PDF)
            if (filtroPagamento === null && termoBusca && !((item.cliente||'').toLowerCase().includes(termoBusca) || (item.placa||'').toLowerCase().includes(termoBusca) || (item.os||'').toLowerCase().includes(termoBusca))) return false;
        }

        // Excluir canceladas (sempre)
        if((item.cliente||'').toUpperCase().includes('CANCELADA')) return false;

        // Filtro de Pagamento (Se a fun√ß√£o foi chamada por um cart√£o de resumo)
        if (filtroPagamento) {
            const normalizedFiltro = filtroPagamento.toLowerCase().replace(/\s/g, '').replace('√°', 'a').replace('√©', 'e').replace('e', '√©');
            
            if (normalizedFiltro === 'maodeobra') {
                 // Para M√£o de Obra, considera O.S. com valor MO > 0
                 return (parseFloat(item.valor_mo || 0) > 0);
            } else if (normalizedFiltro === 'faturado') {
                 if (itemPagamento !== 'faturado') return false;
            } else if (normalizedFiltro === 'emaberto') {
                 if (itemPagamento !== 'em aberto') return false;
            } else if (normalizedFiltro === 'pix') {
                 if (!itemPagamento.includes('pix')) return false;
            } else if (normalizedFiltro === 'dinheiro') {
                 if (itemPagamento !== 'dinheiro') return false;
            } else if (normalizedFiltro === 'd√©bito' || normalizedFiltro === 'debito') {
                 if (itemPagamento !== 'd√©bito' && itemPagamento !== 'debito') return false;
            } else if (normalizedFiltro === 'cr√©dito' || normalizedFiltro === 'credito') {
                 if (itemPagamento !== 'cr√©dito' && itemPagamento !== 'credito') return false;
            }
        }
        
        return true;
    });

    return dadosFiltrados;
}


/* -------------------------   Atualizar tabela e totais (CORRIGIDO PARA USAR getDadosFiltrados)   ------------------------- */
function atualizarTabelaTodas(){
    const tbody = document.querySelector('#tabelaTodas tbody');
    tbody.innerHTML = '';
    
    // Obt√©m os dados filtrados (incluindo o filtro de busca)
    // Usamos getDadosFiltrados() com applyScreenFilters=true e filterPayment=null para obter o array principal
    const dadosFiltrados = getDadosFiltrados(null, true);

    let totalF = 0, totalAberto = 0, totalPix = 0, totalDin = 0, totalDeb = 0, totalCred = 0;    
    let totalMO = 0;         

    dadosFiltrados.forEach(item => {
        const valorOs = parseFloat(item.valor_os || 0);
        const valorMo = parseFloat(item.valor_mo || 0);
        const valorTotal = parseFloat(item.valor || (valorOs + valorMo));
        const itemPagamento = item.pagamento ? item.pagamento.toString().toLowerCase().trim() : '';

        // C√ÅLCULOS DOS TOTAIS DO RESUMO (devem ser feitos aqui, usando os dados filtrados)
        totalMO += valorMo;                
        if(itemPagamento === 'faturado') totalF += valorTotal;
        if(itemPagamento === 'em aberto') totalAberto += valorTotal;
        if(itemPagamento.includes('pix')) totalPix += valorTotal; 
        if(itemPagamento === 'dinheiro') totalDin += valorTotal;
        if(itemPagamento === 'd√©bito' || itemPagamento === 'debito') totalDeb += valorTotal;
        if(itemPagamento === 'cr√©dito' || itemPagamento === 'credito') totalCred += valorTotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.os || ''}</td>
                        <td>${item.data || ''}</td>
                        <td>${item.cliente || ''}</td>
                        <td>${item.placa || ''}</td>
                        <td style="text-align:right;">R$ ${valorOs.toFixed(2).replace('.', ',')}</td>
                        <td style="text-align:right;">R$ ${valorMo.toFixed(2).replace('.', ',')}</td>
                        <td style="text-align:right;">R$ ${valorTotal.toFixed(2).replace('.', ',')}</td>
                        <td>${item.pagamento || ''}</td>
                        <td>${item.tecnico || ''}</td>
                        <td>${item.os_tecnico || ''}</td>
                        <td>${item.unidade || ''}</td>
                        <td><button class="edit" onclick="abrirFormForEdit('${item.id}')">Editar</button> <button class="delete" onclick="apagarOS('${item.id}')">Apagar</button></td>`;
        tbody.appendChild(tr);
    });

    // ATUALIZA OS CARDS DO RESUMO COM OS TOTAIS CALCULADOS
    document.getElementById('totalMO').innerHTML=`M√ÉO DE OBRA<br>R$ ${totalMO.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalFaturadas').innerHTML=`FATURADAS<br>R$ ${totalF.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalAberto').innerHTML=`EM ABERTO<br>R$ ${totalAberto.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalPix').innerHTML=`PIX<br>R$ ${totalPix.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalDinheiro').innerHTML=`DINHEIRO<br>R$ ${totalDin.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalDebito').innerHTML=`D√âBITO<br>R$ ${totalDeb.toFixed(2).replace('.', ',')}`;
    document.getElementById('totalCredito').innerHTML=`CR√âDITO<br>R$ ${totalCred.toFixed(2).replace('.', ',')}`;
}


/* -------------------------   Fun√ß√£o Imprimir PDF (CORRIGIDA)   ------------------------- */
function imprimirPDF(filtroPagamento = null) {
    // 1. OBT√âM OS DADOS J√Å FILTRADOS PELA TELA
    // Passamos o filtro de pagamento (se houver) e pedimos para aplicar os filtros de tela.
    const dadosParaPDF = getDadosFiltrados(filtroPagamento, true);

    if (dadosParaPDF.length === 0) {
        alert('Nenhuma Ordem de Servi√ßo encontrada para o(s) filtro(s) selecionado(s).');
        return;
    }
    
    // 2. Configura√ß√µes e C√°lculos
    const doc = new window.jspdf.jsPDF();
    const headers = ["O.S", "DATA", "CLIENTE", "PLACA", "VALOR OS", "VALOR MO", "VALOR (TOTAL)", "PAGAMENTO", "TECNICO", "UNIDADE"];
    let totalGeral = 0;
    let totalOS = 0;
    let totalMO = 0;

    const body = dadosParaPDF.map(item => {
        const vOs = parseFloat(item.valor_os || 0);
        const vMo = parseFloat(item.valor_mo || 0);
        const vTotal = parseFloat(item.valor || (vOs + vMo));

        // Acumula os totais
        totalGeral += vTotal;
        totalOS += vOs;
        totalMO += vMo;
        
        // Retorna a linha para o corpo da tabela do PDF
        return [
            item.os || '',
            item.data || '',
            item.cliente || '',
            item.placa || '',
            `R$ ${vOs.toFixed(2).replace('.', ',')}`,
            `R$ ${vMo.toFixed(2).replace('.', ',')}`,
            `R$ ${vTotal.toFixed(2).replace('.', ',')}`,
            item.pagamento || '',
            item.tecnico || '',
            item.unidade || ''
        ];
    });

    // 3. Monta o Rodap√© de Totais
    const foot = [
        ['', '', '', '', 
         `Total OS: R$ ${totalOS.toFixed(2).replace('.', ',')}`, 
         `Total MO: R$ ${totalMO.toFixed(2).replace('.', ',')}`, 
         `Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}`, 
         '', '', '']
    ];

    // 4. Monta o T√≠tulo do Relat√≥rio
    const titulo = filtroPagamento ? `VDI TAC√ìGRAFOS - RELAT√ìRIO ${filtroPagamento.toUpperCase().replace('M√ÉODEOBRA', 'M√ÉO DE OBRA')}` : 'VDI TAC√ìGRAFOS - RELAT√ìRIO GERAL';
    
    // Captura os filtros de data e t√©cnico para o cabe√ßalho do PDF
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const tecnico = document.getElementById('tecnicoFiltro').value || 'Todos';
    const unidade = document.getElementById('unidade').value || 'Todas';

    const infoFiltro = [
        `Per√≠odo: ${dataInicio ? formatDate(dataInicio) : 'In√≠cio'} a ${dataFim ? formatDate(dataFim) : 'Fim'}`,
        `Unidade: ${unidade} | T√©cnico: ${tecnico}`
    ];


    // 5. Gera o PDF com autotable
    doc.text(titulo, 105, 10, null, null, 'center');
    doc.setFontSize(10);
    doc.text(infoFiltro, 105, 15, null, null, 'center');
    
    doc.autoTable({
        head: [headers],
        body: body,
        foot: foot,
        startY: 25,
        theme: 'striped',
        headStyles: { fillColor: [74, 144, 226], halign: 'center' }, // Cor azul (4a90e2)
        footStyles: { fillColor: [51, 51, 51], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' }, // Cor escura
        styles: { fontSize: 8 },
        columnStyles: {
            'VALOR OS': { halign: 'right' },
            'VALOR MO': { halign: 'right' },
            'VALOR (TOTAL)': { halign: 'right', fontStyle: 'bold' }
        }
    });

    doc.save(`${titulo.replace(/ /g,'_')}.pdf`);
}

/* Fun√ß√µes de filtro e busca (inalteradas, funcionam chamando atualizarTabelaTodas) */
function limparFiltros(){
    document.getElementById('unidade').value = '';
    document.getElementById('tecnicoFiltro').value = '';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('busca').value = '';
    atualizarTabelaTodas();
}
function filtrar(){ atualizarTabelaTodas(); }
function buscar(){ atualizarTabelaTodas(); }

/* limpar todos os dados (seu original) */
async function limparDados(){
    if(!confirm('Deseja limpar TODOS os dados NA NUVEM?')) return;
    document.getElementById('loadingOverlay').style.display = 'flex';
    const snapshot = await osCollection.get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => batch.delete(doc.ref));
    try {
        await batch.commit();
        alert('Dados apagados');
    } catch(e){
        console.error(e); alert('Erro ao apagar dados');
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

/* -------------------------   Export Excel (Com Valor MO)   ------------------------- */
function exportExcel(){
    const items = osData.map(it => ({
        'O S': it.os || '',
        'DATA': it.data || '',
        'CLIENTE': it.cliente || '',
        'PLACA': it.placa || '',
        'VALOR OS': parseFloat(it.valor_os || 0), 
         'VALOR MO': parseFloat(it.valor_mo || 0), 
         'PAGAMENTO': it.pagamento || '',
        'TECNICO': it.tecnico || '',
        'OS TECNICO': it.os_tecnico || '',
        'UNIDADE': it.unidade || ''
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(items, {header: ['O S','DATA','CLIENTE','PLACA','VALOR OS','VALOR MO','PAGAMENTO','TECNICO','OS TECNICO','UNIDADE']});
    XLSX.utils.book_append_sheet(wb, ws, 'O.S');
    XLSX.writeFile(wb, 'OS_FrenteCaixa_Export.xlsx');
}

/* -------------------------   Import Excel (Com Valor MO)   ------------------------- */
function importExcel(){ document.getElementById('inputExcel').click(); }
function lerExcel(event){
    const files = event.target.files;
    if(!files || files.length === 0){ event.target.value = null; return; }
    document.getElementById('loadingOverlay').style.display = 'flex';
    let arquivosProcessados = 0;
    let dadosCombinados = [];
    function processarArquivo(file){
        const reader = new FileReader();
        const fileName = file.name.toUpperCase();
        let unidadeDetect = '';
        if(fileName.includes('BARUERI')) unidadeDetect = 'Barueri';
        if(fileName.includes('COTIA')) unidadeDetect = 'Cotia';
        if(fileName.includes('EMBU')) unidadeDetect = 'Embu';
        reader.onload = function(e){
            const data = e.target.result;
            try {
                const workbook = XLSX.read(data, {type:'binary', raw:true, cellDates:true});
                const first = workbook.Sheets[workbook.SheetNames[0]];
                const sheet = XLSX.utils.sheet_to_json(first, {header:1, raw:true, defval:''});
                let headerMap = null;
                let capturing = false;
                for(let i=0;i<sheet.length;i++){
                    const rawRow = sheet[i];
                    const normalizedRow = rawRow.map(c => normalizeHeader(c));
                    const hasData = normalizedRow.some(c => c === 'DATA');
                    const hasOS = normalizedRow.some(c => c === 'O S' || c === 'O.S' || c === 'OS');
                    const hasCliente = normalizedRow.some(c => c === 'CLIENTE');
                    if(!headerMap && hasData && hasOS && hasCliente){
                        headerMap = {};
                        normalizedRow.forEach((cellText, idx) => {
                            if(cellText === 'O S' || cellText === 'O.S' || cellText === 'OS') headerMap.os = idx;
                            else if(cellText === 'DATA') headerMap.data = idx;
                            else if(cellText === 'CLIENTE') headerMap.cliente = idx;
                            else if(cellText === 'PLACA') headerMap.placa = idx;
                            else if(cellText === 'VALOR OS' || cellText === 'VALOR_OS' || cellText === 'VALOR') headerMap.valor_os = idx;
                            else if(cellText === 'VALOR MO' || cellText === 'VALOR_MO' ) headerMap.valor_mo = idx;
                            else if(cellText === 'PAGAMENTO') headerMap.pagamento = idx;
                            else if(cellText === 'TECNICO') headerMap.tecnico = idx;
                            else if(cellText === 'OS TECNICO' || cellText === 'OS_TECNICO') headerMap.os_tecnico = idx;
                            else if(cellText === 'UNIDADE') headerMap.unidade = idx;
                        });
                        capturing = true;
                        continue;
                    }
                    if(capturing){
                        const rowText = normalizedRow.join(' ');
                        if(rowText.includes('TOTAL') || rowText.includes('RESUMO') || rowText.includes('SAIDAS') || rowText.includes('INICIO DE CX') || (!rawRow || rawRow.length===0) ){
                            capturing = false;
                            continue;
                        }
                        if(headerMap){
                            const rawOS = rawRow[ headerMap.os ] || rawRow[0];
                            if(!rawOS || String(rawOS).trim()==='') continue;
                            let dataCell = headerMap.data !== undefined ? rawRow[headerMap.data] : rawRow[1];
                            let dateISO = parseDateCell(dataCell) || null;
                            if(!dateISO && String(dataCell).trim().length===8 && /^\d{2}\/\d{2}\/\d{4}$/.test(String(dataCell))) dateISO = parseDateCell(dataCell);
                            const valorOsCell = headerMap.valor_os!==undefined ? rawRow[headerMap.valor_os] : rawRow[4];
                            const valorMoCell = headerMap.valor_mo!==undefined ? rawRow[headerMap.valor_mo] : rawRow[5];
                            const pagamentoCell = headerMap.pagamento!==undefined ? rawRow[headerMap.pagamento] : rawRow[6];
                            const tecnicoCell = headerMap.tecnico!==undefined ? rawRow[headerMap.tecnico] : rawRow[7];
                            const osTecnicoCell = headerMap.os_tecnico!==undefined ? rawRow[headerMap.os_tecnico] : '';
                            const unidadeCell = headerMap.unidade!==undefined ? rawRow[headerMap.unidade] : unidadeDetect;
                            const vOs = parseMoneyCell(valorOsCell);
                            const vMo = parseMoneyCell(valorMoCell);
                            const totalValor = (vOs + vMo);
                            const item = {
                                os: String(rawOS || '').toString(),
                                data: formatDate(dateISO || '2000-01-01'),
                                cliente: String(rawRow[ headerMap.cliente !== undefined ? headerMap.cliente : 2 ] || ''),
                                placa: String(rawRow[ headerMap.placa !== undefined ? headerMap.placa : 3 ] || ''),
                                valor_os: vOs.toFixed(2),
                                valor_mo: vMo.toFixed(2),
                                valor: totalValor.toFixed(2),
                                pagamento: String(pagamentoCell || '').trim(),
                                tecnico: String(tecnicoCell || '').trim(),
                                os_tecnico: String(osTecnicoCell || '').trim(),
                                unidade: String(unidadeCell || unidadeDetect || '').trim(),
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            dadosCombinados.push(item);
                        }
                    }
                }
            } catch(e){
                console.error("Erro ao processar arquivo:", e);
                alert(`Erro ao ler o arquivo ${file.name}. Verifique o formato.`);
            } finally {
                arquivosProcessados++;
                if(arquivosProcessados === files.length) {
                    salvarImportacao(dadosCombinados);
                    event.target.value = null; // Resetar o input file
                }
            }
        };
        reader.onerror = function(){
            arquivosProcessados++;
            if(arquivosProcessados === files.length) {
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Erro na leitura de um ou mais arquivos.');
            }
        };
        reader.readAsBinaryString(file);
    }
    Array.from(files).forEach(processarArquivo);
}

async function salvarImportacao(data){
    if(data.length === 0) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('Nenhum dado v√°lido encontrado para importa√ß√£o.');
        return;
    }
    
    if(!confirm(`Deseja importar ${data.length} registros? Isso pode levar alguns minutos.`)) {
         document.getElementById('loadingOverlay').style.display = 'none';
         return;
    }

    let successCount = 0;
    let failCount = 0;

    // Use Batch writes para ser mais eficiente
    const batch = db.batch();
    const batchSize = 500;
    
    for(let i = 0; i < data.length; i++){
        const docRef = osCollection.doc();
        batch.set(docRef, data[i]);
        
        if((i + 1) % batchSize === 0 || i === data.length - 1){
            try {
                await batch.commit();
                successCount += ((i + 1) % batchSize === 0) ? batchSize : ((i + 1) % batchSize) || (data.length % batchSize);
            } catch(e) {
                console.error("Erro no batch:", e);
                failCount += ((i + 1) % batchSize === 0) ? batchSize : ((i + 1) % batchSize) || (data.length % batchSize);
            }
            // Inicia novo batch
            if(i !== data.length - 1){
                batch = db.batch();
            }
        }
    }

    document.getElementById('loadingOverlay').style.display = 'none';
    alert(`Importa√ß√£o conclu√≠da. Sucesso: ${successCount}. Falhas: ${failCount}.`);
}
</script>
</body>
</html>
