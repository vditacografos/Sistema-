<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VDI TACOGRAFOS - Frente de Caixa (PDF Funcional)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Estilos para simular sua tela */
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .resumo-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
        .botao-resumo {
            padding: 15px 10px;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            flex-grow: 1;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }
        .botao-resumo:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .roxo { background-color: #6a1b9a; }
        .azul { background-color: #03a9f4; }
        .vermelho { background-color: #e91e63; }
        .verde { background-color: #4caf50; }
        .amarelo { background-color: #ffc107; color: #333;}
        .laranja { background-color: #ff9800; }
        .roxo-claro { background-color: #9c27b0; }
        
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
        .tabela-os {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .tabela-os th, .tabela-os td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .tabela-os th {
            background-color: #4a90e2;
            color: white;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">Gerando PDF... Por favor, aguarde.</div>

    <h2>Resumo – Controle de Caixa Diário</h2>

    <div class="resumo-container">
        <button class="botao-resumo roxo" onclick="imprimirPDF('MaoDeObra')">
            MÃO DE OBRA <br> R$ 10001,00 
        </button>

        <button class="botao-resumo azul" onclick="imprimirPDF('Faturado')">
            FATURADAS <br> R$ 26189,00
        </button>

        <button class="botao-resumo vermelho" onclick="imprimirPDF('Em Aberto')">
            EM ABERTO <br> R$ 162,00
        </button>

        <button class="botao-resumo verde" onclick="imprimirPDF('PIX')">
            PIX <br> R$ 7728,00
        </button>

        <button class="botao-resumo amarelo" onclick="imprimirPDF('Dinheiro')">
            DINHEIRO <br> R$ 475,00
        </button>

        <button class="botao-resumo laranja" onclick="imprimirPDF('Débito')">
            DÉBITO <br> R$ 492,00
        </button>
        
        <button class="botao-resumo roxo-claro" style="flex-basis: 100%;" onclick="imprimirPDF('Crédito')">
            CRÉDITO <br> R$ 0,00
        </button>
        
        <button class="botao-resumo roxo" style="flex-basis: 100%; margin-top: 20px;" onclick="imprimirPDF('ValorOS')">
            GERAR PDF: TOTAL GERAL (VALOR OS / PEÇAS)
        </button>
    </div>

    <h3>Ordens de Serviço Filtradas (Exemplo)</h3>
    <table class="tabela-os">
        <thead>
            <tr>
                <th>O.S</th><th>DATA</th><th>CLIENTE</th><th>VALOR OS</th><th>VALOR MO</th><th>VALOR TOTAL</th><th>PAGAMENTO</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>0678</td><td>03/11/2025</td><td>CLIENTE A</td><td>R$ 153,00</td><td>R$ 30,00</td><td>R$ 183,00</td><td>Faturado</td></tr>
            <tr><td>1977</td><td>03/11/2025</td><td>CLIENTE B</td><td>R$ 195,00</td><td>R$ 60,00</td><td>R$ 255,00</td><td>Vista</td></tr>
            </tbody>
    </table>

    <script>
        
        // =========================================================================
        // VARIÁVEIS DE DADOS - VOCÊ DEVE SUBSTITUIR ESTES DADOS PELOS DO SEU SISTEMA
        // =========================================================================

        // Simulação dos dados de todas as O.S.
        const osData = [
            { os: '0678', data: '03/11/2025', cliente: 'CLIENTE A', placa: 'BIL 0211', valor_os: '153.00', valor_mo: '30.00', pagamento: 'Faturado', tecnico: 'BIL', unidade: 'COTIA' },
            { os: '1977', data: '03/11/2025', cliente: 'CLIENTE B', placa: 'BIL 0211', valor_os: '195.00', valor_mo: '60.00', pagamento: 'Vista', tecnico: 'BIL', unidade: 'COTIA' },
            { os: '1963', data: '03/11/2025', cliente: 'CLIENTE C', placa: 'BIL 0211', valor_os: '40.00', valor_mo: '0.00', pagamento: 'Vista', tecnico: 'BIL', unidade: 'COTIA' },
            { os: '0673', data: '01/11/2025', cliente: 'CLIENTE D', placa: 'BIL 0212', valor_os: '160.00', valor_mo: '160.00', pagamento: 'Faturado', tecnico: 'BIL', unidade: 'COTIA' },
            { os: '2207', data: '26/11/2025', cliente: 'ADEMIR', placa: 'FTZ-2993', valor_os: '0.00', valor_mo: '190.00', pagamento: 'Crédito', tecnico: 'VAL', unidade: 'COTIA' },
            { os: '0847', data: '26/11/2025', cliente: 'KARAVAGGIO', placa: 'FHS-9767', valor_os: '227.00', valor_mo: '80.00', pagamento: 'Faturado', tecnico: 'VAL', unidade: 'COTIA' },
            { os: '2153', data: '21/11/2025', cliente: 'CONSUMIDOR', placa: 'EAA-7J84', valor_os: '107.00', valor_mo: '20.00', pagamento: 'Débito', tecnico: 'VAL', unidade: 'COTIA' },
            { os: '0749', data: '12/11/2025', cliente: 'CLIENTE G', placa: 'AAA-1111', valor_os: '100.00', valor_mo: '50.00', pagamento: 'Faturado', tecnico: 'VAL', unidade: 'COTIA' },
            { os: '2093', data: '15/11/2025', cliente: 'CLIENTE H', placa: 'BBB-2222', valor_os: '60.00', valor_mo: '0.00', pagamento: 'Débito', tecnico: 'ISAIAS', unidade: 'COTIA' },
            { os: '2206', data: '26/11/2025', cliente: 'CONSUMIDOR', placa: 'SEM PLACA', valor_os: '455.00', valor_mo: '0.00', pagamento: 'PIX', tecnico: 'ISAIAS', unidade: 'COTIA' },
            { os: '2193', data: '25/11/2025', cliente: 'KSS', placa: 'SEM PLACA', valor_os: '980.00', valor_mo: '0.00', pagamento: 'Em Aberto', tecnico: 'ISAIAS', unidade: 'COTIA' },
            { os: '2194', data: '25/11/2025', cliente: 'KSS', placa: 'SEM PLACA', valor_os: '200.00', valor_mo: '50.00', pagamento: 'Dinheiro', tecnico: 'ISAIAS', unidade: 'COTIA' },
            { os: '2195', data: '25/11/2025', cliente: 'KSS', placa: 'SEM PLACA', valor_os: '100.00', valor_mo: '0.00', pagamento: 'Dinheiro', tecnico: 'ISAIAS', unidade: 'COTIA' },
        ];

        // Cores de fundo para as linhas do PDF (Opcional, mas útil)
        const paymentColors = {
            'Faturado': [200, 220, 250],
            'Vista': [240, 240, 200],
            'Crédito': [230, 200, 250],
            'Débito': [255, 220, 200],
            'PIX': [220, 250, 220],
            'Dinheiro': [255, 230, 200],
            'Em Aberto': [255, 200, 200],
        };

        // Funções Utilitárias
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // =========================================================================
        // FUNÇÃO imprimirPDF CORRIGIDA
        // =========================================================================

        async function imprimirPDF(filtro = null) {
            
            // Verifica se a biblioteca está carregada
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert('Erro: As bibliotecas jspdf e jspdf-autotable não foram carregadas corretamente. Verifique sua conexão com a internet ou os links CDN.');
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // --- SIMULAÇÃO DE FILTROS DA TELA (AJUSTE CONFORME SEU CÓDIGO) ---
            const unidadeFiltro = ''; // Se vazio, não filtra
            const tecnicoFiltro = ''; // Se vazio, não filtra
            const dataInicioFiltro = ''; // Se vazio, não filtra
            const dataFimFiltro = ''; // Se vazio, não filtra
            const termoBusca = ''; 
            // -----------------------------------------------------------------

            let dadosFiltrados = osData.filter(item => {
                // Lógica de filtragem padrão da tela
                const itemDate = item.data ? item.data.split('/').reverse().join('-') : '2000-01-01';
                if(unidadeFiltro && item.unidade !== unidadeFiltro) return false;
                if(tecnicoFiltro && item.tecnico !== tecnicoFiltro) return false;
                if(dataInicioFiltro && itemDate < dataInicioFiltro) return false;
                if(dataFimFiltro && itemDate > dataFimFiltro) return false;
                if((item.cliente||'').toUpperCase().includes('CANCELADA')) return false;
                if(termoBusca && !((item.cliente||'').toLowerCase().includes(termoBusca) || (item.placa||'').toLowerCase().includes(termoBusca) || (item.os||'').toLowerCase().includes(termoBusca))) return false;
                return true;
            });

            let reportTitle = 'Relatório Geral de Ordens de Serviço';

            // 2. Aplicar o filtro do botão de resumo (PARÂMETRO PASSADO NO ONCLICK)
            switch (filtro) {
                case 'ValorOS': 
                    dadosFiltrados = dadosFiltrados.filter(item => parseFloat(item.valor_os || 0) > 0);
                    reportTitle = 'Relatório de TOTAL GERAL (VALOR OS - PEÇAS)';
                    break;
                case 'MaoDeObra':
                    dadosFiltrados = dadosFiltrados.filter(item => parseFloat(item.valor_mo || 0) > 0);
                    reportTitle = 'Relatório de MÃO DE OBRA';
                    break;
                case 'Faturado':
                case 'Em Aberto':
                case 'PIX':
                case 'Dinheiro':
                case 'Débito':
                case 'Crédito':
                    dadosFiltrados = dadosFiltrados.filter(item => (item.pagamento || '').trim() === filtro);
                    reportTitle = `Relatório de O.S. Pagas em ${filtro.toUpperCase()}`;
                    break;
                default:
                    // Sem filtro de botão aplicado, usa o filtro da tela
                    reportTitle = 'Relatório Geral (Filtros de Tela)';
                    break;
            }
            
            // 3. Configuração do PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); 
            
            const colunas = ['O.S', 'DATA', 'CLIENTE', 'PLACA', 'VALOR OS', 'VALOR MO', 'VALOR (TOTAL)', 'PAGAMENTO', 'TECNICO', 'UNIDADE'];
            
            const dataTable = dadosFiltrados.map(item => {
                // Conversão de string para float para cálculo e formatação
                const valorOs = parseFloat(item.valor_os || 0);
                const valorMo = parseFloat(item.valor_mo || 0);
                const valorTotal = valorOs + valorMo;
                
                return [
                    item.os || '',
                    item.data || '',
                    item.cliente || '',
                    item.placa || '',
                    `R$ ${valorOs.toFixed(2).replace('.', ',')}`,
                    `R$ ${valorMo.toFixed(2).replace('.', ',')}`,
                    `R$ ${valorTotal.toFixed(2).replace('.', ',')}`,
                    item.pagamento || '',
                    item.tecnico || '',
                    item.unidade || ''
                ];
            });

            // 4. CÁLCULOS E FORMATAÇÃO PARA O RODAPÉ (Corrigido)
            const totalOsPDF = dadosFiltrados.reduce((sum, item) => sum + parseFloat(item.valor_os || 0), 0);
            const totalMoPDF = dadosFiltrados.reduce((sum, item) => sum + parseFloat(item.valor_mo || 0), 0);
            const totalGeralPDF = totalOsPDF + totalMoPDF;

            // Linha crucial: Formata corretamente os totais e organiza no rodapé da tabela
            const footData = [
                ['', '', 'Total OS:', `R$ ${totalOsPDF.toFixed(2).replace('.', ',')}`, 'Total MO:', `R$ ${totalMoPDF.toFixed(2).replace('.', ',')}`, 'Total Geral:', `R$ ${totalGeralPDF.toFixed(2).replace('.', ',')}`, '', '']
            ];
            
            // Título no PDF
            doc.setFontSize(16);
            doc.text(reportTitle, 14, 15);
            doc.setFontSize(10);
            const periodo = (dataInicioFiltro ? formatDate(dataInicioFiltro) : 'Início') + ' a ' + (dataFimFiltro ? formatDate(dataFimFiltro) : 'Fim');
            doc.text(`Filtros: Unidade=${unidadeFiltro||'Todas'}, Técnico=${tecnicoFiltro||'Todos'}, Período=${periodo}`, 14, 22);

            // Geração da Tabela
            doc.autoTable({
                startY: 30,
                head: [colunas],
                body: dataTable,
                foot: footData,
                footStyles: { fillColor: [50, 50, 50], textColor: 255, fontStyle: 'bold', fontSize: 10, halign: 'center' },
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [74, 144, 226] },
                columnStyles: {
                    4: { cellWidth: 20, halign: 'right' }, // VALOR OS
                    5: { cellWidth: 20, halign: 'right' }, // VALOR MO
                    6: { cellWidth: 20, halign: 'right' }  // VALOR (TOTAL)
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && dadosFiltrados[data.row.index]) {
                        const pagamento = dadosFiltrados[data.row.index].pagamento;
                        if (paymentColors && paymentColors[pagamento]) { 
                            data.cell.styles.fillColor = paymentColors[pagamento];
                        }
                    }
                },
                didDrawPage: function(data) {
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.text(`Página ${data.pageNumber} de ${pageCount}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 5, { align: 'right' });
                }
            });

            // Nome do arquivo
            const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            let filename = `Relatorio_VDI_${reportTitle.replace(/\s/g, '_').replace(/[^\w]/g, '')}_${today}.pdf`;

            doc.save(filename);
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
